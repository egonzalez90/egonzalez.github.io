---
layout: post
title: Migrate from keystone v2.0 to keystone v3 OpenStack Liberty
date: 2016-02-02 19:43:46.000000000 +01:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- OpenStack
tags:
- auth
- auth_url
- core
- guide
- how to
- keystone
- migrate
- openstack
- packstack
- rdo
- services
- Tutorial
- v2.0
- v3
- version
meta:
  _edit_last: '2'
  _aioseop_opengraph_settings: a:13:{s:32:"aioseop_opengraph_settings_title";s:59:"Migrate
    from keystone v2.0 to keystone v3 OpenStack Liberty";s:31:"aioseop_opengraph_settings_desc";s:88:"Guide
    providing the steps to migrate from keystone v2.0 to keystone v3 OpenStack Liberty";s:32:"aioseop_opengraph_settings_image";s:87:"http://egonzalez.org/wp-content/uploads/2015/09/learn-about-openstack-badge-140x150.png";s:36:"aioseop_opengraph_settings_customimg";s:87:"http://egonzalez.org/wp-content/uploads/2015/09/learn-about-openstack-badge-140x150.png";s:37:"aioseop_opengraph_settings_imagewidth";s:0:"";s:38:"aioseop_opengraph_settings_imageheight";s:0:"";s:32:"aioseop_opengraph_settings_video";s:0:"";s:37:"aioseop_opengraph_settings_videowidth";s:0:"";s:38:"aioseop_opengraph_settings_videoheight";s:0:"";s:35:"aioseop_opengraph_settings_category";s:8:"activity";s:34:"aioseop_opengraph_settings_section";s:0:"";s:30:"aioseop_opengraph_settings_tag";s:0:"";s:34:"aioseop_opengraph_settings_setcard";s:7:"summary";}
  _publicize_twitter_user: "@egongu90"
  _wpas_mess: Migrate from keystone v2.0 to keystone v3 OpenStack Liberty
  _wpas_skip_12345373: '1'
  _thumbnail_id: '1027'
  _wpas_done_all: '1'
  _wpas_skip_5226565: '1'
  _wpas_skip_10228321: '1'
  _wpas_skip_8706018: '1'
  _aioseop_keywords: 'keystone, migrate, version, v2.0, v2, v3, openstack, packstack,
    rdo, core, services, how, guide, auth_auth_url '
  _aioseop_description: Guide providing the steps to migrate from keystone v2.0 to
    keystone v3 OpenStack Liberty
  _aioseop_title: Migrate from keystone v2.0 to keystone v3 OpenStack Liberty
  _jetpack_related_posts_cache: a:1:{s:32:"8f6677c9d6b0f903e98ad32ec61f8deb";a:2:{s:7:"expires";i:1568767081;s:7:"payload";a:3:{i:0;a:1:{s:2:"id";i:1310;}i:1;a:1:{s:2:"id";i:1038;}i:2;a:1:{s:2:"id";i:1204;}}}}
  dsq_thread_id: '6094296853'
author:
  login: egongu90
  email: egongu90@hotmail.com
  display_name: Editor
  first_name: ''
  last_name: ''
permalink: "/migrate-from-keystone-v2-0-to-keystone-v3-openstack-liberty/"
---
<p>Migrate from keystone v2.0 to v3 isn't as easy like just changing the endpoints at the database, every service must be configured to authenticate against keystone v3.</p>
<p>I've been working on that the past few days looking for a method, with the purpose of facilitate operators life's who need this kind of migration.<br />
I have to thank Adam Young work, i followed his blog to make a first configuration idea, after that, i configured all core services to make use of keystone v3.<br />
If you want to check Adam's blog, follow this link: <a href="http://adam.younglogic.com/2015/05/rdo-v3-only/" target="_blank">http://adam.younglogic.com/2015/05/rdo-v3-only/</a></p>
<p>I used OpenStack Liberty installed with RDO packstack over CentOS 7 servers.<br />
The example IP used is <code>192.168.200.168</code>, use your own according your needs.<br />
Password used for all services is <code>PASSWD1234</code>, use your own password, you can locate your passwords at the packstack answer file. </p>
<p><ins datetime="2016-02-02T18:25:21+00:00"><strong>Horizon</strong></ins></p>
<p>First we configure Horizon with keystone v3 as below:</p>
<pre>
vi /etc/openstack-dashboard/local_settings

OPENSTACK_API_VERSIONS = {
    "identity": 3
}

OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = True
OPENSTACK_KEYSTONE_DEFAULT_DOMAIN = 'Default'
</pre>
<p><ins datetime="2016-02-02T18:25:21+00:00"><strong>keystone</strong></ins></p>
<p>Check your current identity endpoints</p>
<pre>
mysql  --user keystone_admin --password=PASSWD1234  keystone -e "select interface, url from endpoint where service_id =  (select id from service where service.type = 'identity');"
</pre>
<p>Change your public, admin and internal endpoints with v3 at the end, instead of v2.0</p>
<pre>
mysql  --user keystone_admin --password=PASSWD1234   keystone -e "update endpoint set   url  = 'http://192.168.200.178:5000/v3' where  interface ='internal' and  service_id =  (select id from service where service.type = 'identity');"

mysql  --user keystone_admin --password=PASSWD1234   keystone -e "update endpoint set   url  = 'http://192.168.200.178:5000/v3' where  interface ='public' and  service_id =  (select id from service where service.type = 'identity');"

mysql  --user keystone_admin --password=PASSWD1234   keystone -e "update endpoint set   url  = 'http://192.168.200.178:35357/v3' where  interface ='admin' and  service_id =  (select id from service where service.type = 'identity');"
</pre>
<p>Ensure the endpoints are properly created</p>
<pre>
mysql  --user keystone_admin --password=KEYSTONE_DB_PW   keystone -e "select interface, url from endpoint where service_id =  (select id from service where service.type = 'identity');"
</pre>
<p>Create a source file or edit keystonerc_admin with the following data</p>
<pre>
vi v3_keystone

unset OS_SERVICE_TOKEN
export OS_USERNAME=admin
export OS_PASSWORD=PASSWD1234
export OS_AUTH_URL=http://192.168.200.178:5000/v3
export OS_PROJECT_NAME=admin
export OS_PROJECT_DOMAIN_NAME=Default
export OS_USER_DOMAIN_NAME=Default
export OS_REGION_NAME=RegionOne
export PS1='[\u@\h \W(keystone_admin)]\$ '
export OS_IDENTITY_API_VERSION=3
</pre>
<p>Comment both pipelines, in public_api and admin_api</p>
<pre>
vi /usr/share/keystone/keystone-dist-paste.ini

[pipeline:public_api]
# The last item in this pipeline must be public_service or an equivalent
# application. It cannot be a filter.
#pipeline = sizelimit url_normalize request_id build_auth_context token_auth admin_token_auth json_body ec2_extension user_crud_extension public_service

[pipeline:admin_api]
# The last item in this pipeline must be admin_service or an equivalent
# application. It cannot be a filter.
#pipeline = sizelimit url_normalize request_id build_auth_context token_auth admin_token_auth json_body ec2_extension s3_extension crud_extension admin_service
</pre>
<p>Comment v2.0 entries in composite:main and admin sections.</p>
<pre>
[composite:main]
use = egg:Paste#urlmap
#/v2.0 = public_api
/v3 = api_v3
/ = public_version_api

[composite:admin]
use = egg:Paste#urlmap
#/v2.0 = admin_api
/v3 = api_v3
/ = admin_version_api
</pre>
<p>Restart httpd to apply changes</p>
<pre>
systemctl restart httpd
</pre>
<p>Check whether keystone and horizon are properly working<br />
The command below should prompt an user list, if not, check configuration in previous steps</p>
<pre>
openstack user list
</pre>
<p><ins datetime="2016-02-02T18:25:21+00:00"><strong>Glance</strong></ins></p>
<p>Edit the following files, with the content below:</p>
<pre>
vi /etc/glance/glance-api.conf 
vi /etc/glance/glance-registry.conf 
vi /etc/glance/glance-cache.conf 

[keystone_authtoken]

auth_plugin = password
auth_url = http://192.168.200.178:35357
username = glance
password = PASSWD1234
project_name = services
user_domain_name = Default
project_domain_name = Default
auth_uri=http://192.168.200.178:5000
</pre>
<p>Comment the following lines:</p>
<pre>
#auth_host=127.0.0.1
#auth_port=35357
#auth_protocol=http
#identity_uri=http://192.168.200.178:35357
#admin_user=glance
#admin_password=PASSWD1234
#admin_tenant_name=services
</pre>
<p>Those lines, should be commented in all the other OpenStack core services at keystone_authtoken section</p>
<p>Edit the files below and comment the lines inside keystone_authtoken section.</p>
<pre>
vi /usr/share/glance/glance-api-dist.conf 
vi /usr/share/glance/glance-registry-dist.conf 

[keystone_authtoken]
#admin_tenant_name = %SERVICE_TENANT_NAME%
#admin_user = %SERVICE_USER%
#admin_password = %SERVICE_PASSWORD%
#auth_host = 127.0.0.1
#auth_port = 35357
#auth_protocol = http
</pre>
<p>Restart glance services</p>
<pre>
openstack-service restart glance
</pre>
<p>Ensure glance service is working</p>
<pre>
openstack image list
</pre>
<p><ins datetime="2016-02-02T18:25:21+00:00"><strong>Nova</strong></ins></p>
<p>Edit the file below and comment the lines inside keystone_authtoken</p>
<pre>
vi /usr/share/nova/nova-dist.conf

[keystone_authtoken]
#auth_host = 127.0.0.1
#auth_port = 35357
#auth_protocol = http
</pre>
<p>Edit nova.conf and add the auth content inside keystone_authtoken, don't forget to comment the lines related to the last auth method, which were commented in glance section.</p>
<pre>
vi /etc/nova/nova.conf

[keystone_authtoken]

auth_plugin = password
auth_url = http://192.168.200.178:35357
username = nova
password = PASSWD1234
project_name = services
user_domain_name = Default
project_domain_name = Default
auth_uri=http://192.168.200.178:5000
</pre>
<p>Configure nova authentication against neutron</p>
<pre>
[neutron]
          
auth_plugin = password
auth_url = http://192.168.200.178:35357
username = neutron
password = PASSWD1234
project_name = services
user_domain_name = Default
project_domain_name = Default
auth_uri=http://192.168.200.178:5000
</pre>
<p>Restart nova services to apply changes</p>
<pre>
openstack-service restart nova
</pre>
<p>Check if nova works</p>
<pre>
openstack hypervisor list
</pre>
<p><ins datetime="2016-02-02T18:25:21+00:00"><strong>Neutron</strong></ins></p>
<p>Comment or remove the following entries at api-paste.ini and add the new version auth lines </p>
<pre>
vi /etc/neutron/api-paste.ini 

[filter:authtoken]
#identity_uri=http://192.168.200.178:35357
#admin_user=neutron
#admin_password=PASSWD1234
#auth_uri=http://192.168.200.178:5000/v2.0
#admin_tenant_name=services

auth_plugin = password
auth_url = http://192.168.200.178:35357
username = neutron
password = PASSWD1234
project_name = services
user_domain_name = Default
project_domain_name = Default
auth_uri=http://192.168.200.178:5000
</pre>
<p>Configure v3 authentication for metadata service, remember comment the old auth lines</p>
<pre>
vi /etc/neutron/metadata_agent.ini

[DEFAULT]

auth_plugin = password
auth_url = http://192.168.200.178:35357
username = neutron
password = PASSWD1234
project_name = services
user_domain_name = Default
project_domain_name = Default
auth_uri=http://192.168.200.178:5000
</pre>
<p>Configure neutron server with v3 auth</p>
<pre>
vi /etc/neutron/neutron.conf

nova_admin_auth_url = http://192.168.200.178:5000
# nova_admin_tenant_id =1fb93c84c6474c5ea92c0ed5f7d4a6a7
nova_admin_tenant_name = services


[keystone_authtoken]

auth_plugin = password
auth_url = http://192.168.200.178:35357
username = neutron
password = PASSWD1234
project_name = services
user_domain_name = Default
project_domain_name = Default
auth_uri=http://192.168.200.178:5000

#auth_uri = http://192.168.200.178:5000/v2.0
#identity_uri = http://192.168.200.178:35357
#admin_tenant_name = services
#admin_user = neutron
#admin_password = PASSWD1234
</pre>
<p>Configure neutron auth against nova services</p>
<pre>
[nova]

auth_plugin = password
auth_url = http://192.168.200.178:35357
username = nova
password = PASSWD1234
project_name = services
user_domain_name = Default
project_domain_name = Default
auth_uri=http://192.168.200.178:5000
</pre>
<p>Restart neutron services to apply changes</p>
<pre>
openstack-service restart neutron
</pre>
<p>Test correct neutron funtionality</p>
<pre>
openstack network list
</pre>
<p><ins datetime="2016-02-02T18:25:21+00:00"><strong>Cinder</strong></ins></p>
<p>Edit api-paste.ini with the following content</p>
<pre>
vi /etc/cinder/api-paste.ini 

[filter:authtoken]
paste.filter_factory = keystonemiddleware.auth_token:filter_factory
auth_plugin = password
auth_url = http://192.168.200.178:35357
username = cinder
password = PASSWD1234
project_name = services
user_domain_name = Default
project_domain_name = Default
auth_uri=http://192.168.200.178:5000
#admin_tenant_name=services
#auth_uri=http://192.168.200.178:5000/v2.0
#admin_user=cinder
#identity_uri=http://192.168.200.178:35357
#admin_password=PASSWD1234
</pre>
<p>Restart cinder services to apply changes</p>
<pre>
openstack-service restart cinder
</pre>
<p>Ensure cinder is properly running</p>
<pre>
openstack volume create --size 1 testvolume
openstack volume list
</pre>
<p>Now, you can check if nova is working fine, create an instance and ensure it is in ACTIVE state.</p>
<pre>
openstack server create --flavor m1.tiny --image cirros --nic net-id=a1aa6336-9ae2-4ffb-99f5-1b6d1130989c testinstance
openstack server list
</pre>
<p>If any error occurs, review configuration files</p>
<p><ins datetime="2016-02-02T18:25:21+00:00"><strong>Swift</strong></ins></p>
<p>Configure proxy server auth agains keystone v3</p>
<pre>
vi /etc/swift/proxy-server.conf

[filter:authtoken]
log_name = swift
signing_dir = /var/cache/swift
paste.filter_factory = keystonemiddleware.auth_token:filter_factory
auth_plugin = password
auth_url = http://192.168.200.178:35357
username = swift
password = PASSWD1234
project_name = services
user_domain_name = Default
project_domain_name = Default
auth_uri=http://192.168.200.178:5000

#auth_uri = http://192.168.200.178:5000/v2.0
#identity_uri = http://192.168.200.178:35357
#admin_tenant_name = services
#admin_user = swift
#admin_password = PASSWD1234
delay_auth_decision = 1
cache = swift.cache
include_service_catalog = False
</pre>
<p>Restart swift services to apply changes</p>
<pre>
openstack-service restart swift
</pre>
<p>Swift commands must be issued with python-openstackclient instead of swiftclient<br />
If done with swiftclient a -V 3 option must be used in order to avoid issues</p>
<p>Check if swift works fine</p>
<pre>
openstack container create testcontainer
</pre>
<p><ins datetime="2016-02-02T18:25:21+00:00"><strong>Ceilometer</strong></ins></p>
<p>Configure ceilometer service in order to authenticate agains keystone v3</p>
<pre>
[keystone_authtoken]

auth_plugin = password
auth_url = http://192.168.200.178:35357
username = ceilometer
password = PASSWD1234
project_name = services
user_domain_name = Default
project_domain_name = Default
auth_uri=http://192.168.200.178:5000

[service_credentials]

os_auth_url = http://controller:5000/v3
os_username = ceilometer
os_tenant_name = services
os_password = PASSWD1234
os_endpoint_type = internalURL
os_region_name = RegionOne
</pre>
<p>Restart ceilometer services</p>
<pre>
openstack-service restart ceilometer
</pre>
<p>Check ceilometer funtionality</p>
<pre>
ceilometer statistics -m memory
</pre>
<p><ins datetime="2016-02-02T18:25:21+00:00"><strong>Heat</strong></ins></p>
<p>Configure Heat authentication, since trusts are not stable use password auth method</p>
<pre>
vi /etc/heat/heat.conf

# Allowed values: password, trusts
#deferred_auth_method = trusts
deferred_auth_method = password
</pre>
<p>Configure auth_uri and keystone_authtoken section</p>
<pre>
# From heat.common.config
#
# Unversioned keystone url in format like http://0.0.0.0:5000. (string value)
#auth_uri =
auth_uri = http://192.168.200.178:5000

[keystone_authtoken]

auth_plugin = password
auth_url = http://192.168.200.178:35357
username = heat
password = PASSWD1234
project_name = services
user_domain_name = Default
project_domain_name = Default
auth_uri=http://192.168.200.178:5000

#admin_user=heat
#admin_password=PASSWD1234
#admin_tenant_name=services
#identity_uri=http://192.168.200.178:35357
#auth_uri=http://192.168.200.178:5000/v2.0
</pre>
<p>Comment or remove heat-dist auth entries in order to avoid conflicts with your config files</p>
<pre>
vi /usr/share/heat/heat-dist.conf 

[keystone_authtoken]
#auth_host = 127.0.0.1
#auth_port = 35357
#auth_protocol = http
#auth_uri = http://127.0.0.1:5000/v2.0
#signing_dir = /tmp/keystone-signing-heat
</pre>
<p>Restart heat services to apply changes</p>
<pre>
openstack-service restart heat
</pre>
<p>Ensure heat authentication is properly configured with a simple heat template</p>
<pre>
heat stack-create --template-file sample.yaml teststack
</pre>
<p>Most issues occurs in the authentication between nova and neutron services, if instances does not launch as expected, review [nova] and [neutron] sections. </p>
<p>Best regards, Eduardo Gonzalez</p>
