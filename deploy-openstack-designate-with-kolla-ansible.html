<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Deploy OpenStack Designate with Kolla</title>
        <link rel="stylesheet" href="https://egonzalez90.github.io/theme/css/main.css" />
        <link href="https://egonzalez90.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="OpenStack Stuff Atom Feed" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://egonzalez90.github.io/">OpenStack Stuff </a></h1>
                <nav><ul>
                    <li><a href="https://egonzalez90.github.io/category/linux.html">Linux</a></li>
                    <li><a href="https://egonzalez90.github.io/category/linux-openstack.html">Linux, OpenStack</a></li>
                    <li><a href="https://egonzalez90.github.io/category/linux-openstack-various.html">Linux, OpenStack, Various</a></li>
                    <li><a href="https://egonzalez90.github.io/category/linux-various.html">Linux, Various</a></li>
                    <li><a href="https://egonzalez90.github.io/category/linux-virtualizacion.html">Linux, Virtualizacion</a></li>
                    <li><a href="https://egonzalez90.github.io/category/misc.html">misc</a></li>
                    <li class="active"><a href="https://egonzalez90.github.io/category/openstack.html">OpenStack</a></li>
                    <li><a href="https://egonzalez90.github.io/category/reflexiones.html">Reflexiones</a></li>
                    <li><a href="https://egonzalez90.github.io/category/various.html">Various</a></li>
                    <li><a href="https://egonzalez90.github.io/category/virtualizacion.html">Virtualizacion</a></li>
                </ul>
                </nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://egonzalez90.github.io/deploy-openstack-designate-with-kolla-ansible.html" rel="bookmark"
           title="Permalink to Deploy OpenStack Designate with Kolla">Deploy OpenStack Designate with Kolla</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <span>Wed 22 February 2017</span>
<span>| tags: <a href="https://egonzalez90.github.io/tag/-configure.html">--configure</a><a href="https://egonzalez90.github.io/tag/ansible.html">ansible</a><a href="https://egonzalez90.github.io/tag/deploy.html">deploy</a><a href="https://egonzalez90.github.io/tag/designate.html">designate</a><a href="https://egonzalez90.github.io/tag/dns.html">DNS</a><a href="https://egonzalez90.github.io/tag/kolla.html">kolla</a><a href="https://egonzalez90.github.io/tag/kolla-ansible.html">kolla-ansible</a><a href="https://egonzalez90.github.io/tag/ocata.html">ocata</a><a href="https://egonzalez90.github.io/tag/openstack.html">openstack</a></span>
</footer><!-- /.post-info -->      <p>During Ocata release, OpenStack DNS-as-a-Service (Designate) support was
implemented in OpenStack kolla project.</p>
<p>This post will guide you through a basic deployment and tests of
designate service.</p>
<p>Install required dependencies and tools for kolla-ansible and designate.</p>
<div class="highlight"><pre><span></span># yum install -y epel-release
# yum install -y python-pip python-devel libffi-devel gcc openssl-devel ansible ntp wget bind-utils
# pip install -U pip
</pre></div>


<p>Install Docker and downgrade to 1.12.6. At the time of writing this post
libvirt had issues to connect with D-Bus due SElinux issues with Docker
1.13.</p>
<div class="highlight"><pre><span></span># curl -sSL https://get.docker.io | bash
# yum downgrade docker-engine-1.12.6 docker-engine-selinux-1.12.6
# yum install -y python-docker-py
</pre></div>


<p>Configure Docker daemon to allow insecure-registry (Use the IP where
your remote registry will be located).</p>
<div class="highlight"><pre><span></span># mkdir -p /etc/systemd/system/docker.service.d
# tee /etc/systemd/system/docker.service.d/kolla.conf &lt;&lt;-&#39;EOF&#39;
[Service]
ExecStart=
ExecStart=/usr/bin/dockerd --insecure-registry 172.28.128.3:4000
MountFlags=shared
EOF
</pre></div>


<p>Reload systemd daemons and start/stop/disable/enable the following
services.</p>
<div class="highlight"><pre><span></span># systemctl daemon-reload
# systemctl stop libvirtd
# systemctl disable libvirtd
# systemctl enable ntpd docker
# systemctl start ntpd docker
</pre></div>


<p>Download Ocata registry created in tarballs.openstack.org, skip this
step if images used are custom builds or downloaded from DockerHub.<br>
Create kolla registry from downloaded tarball.</p>
<div class="highlight"><pre><span></span># wget https://tarballs.openstack.org/kolla/images/centos-binary-registry-ocata.tar.gz
# mkdir /opt/kolla_registry
# sudo tar xzf centos-binary-registry-ocata.tar.gz -C /opt/kolla_registry
# docker run -d -p 4000:5000 --restart=always -v /opt/kolla_registry/:/var/lib/registry --name registry registry:2
</pre></div>


<p>Install kolla-ansible.</p>
<div class="highlight"><pre><span></span># pip install kolla-ansible
# cp -r /usr/share/kolla-ansible/etc_examples/kolla /etc/kolla/
# cp /usr/share/kolla-ansible/ansible/inventory/* .
</pre></div>


<p>Configure kolla globals.yml configuration file with the following
content.<br>
Change values when necessary (IP addresses, interface names).<br>
This is a sample minimal configuration.</p>
<div class="highlight"><pre><span></span># vi /etc/kolla/globals.yml
---
kolla_internal_vip_address: &quot;172.28.128.10&quot;
kolla_base_distro: &quot;centos&quot;
kolla_install_type: &quot;binary&quot;
docker_registry: &quot;172.28.128.3:4000&quot;
docker_namespace: &quot;lokolla&quot;
network_interface: &quot;enp0s8&quot;
neutron_external_interface: &quot;enp0s9&quot;
</pre></div>


<p>Configure designate options in globals.yml.<br>
dns_interface must be network reachable from nova instances if
internal DNS resolution is needed.</p>
<div class="highlight"><pre><span></span>enable_designate: &quot;yes&quot;
dns_interface: &quot;enp0s8&quot;
designate_backend: &quot;bind9&quot;
designate_ns_record: &quot;sample.openstack.org&quot;
</pre></div>


<p>Configure inventory, add the nodes in their respective groups.</p>
<div class="highlight"><pre><span></span># vi ~/multinode
</pre></div>


<p>Generate passwords.</p>
<div class="highlight"><pre><span></span># kolla-genpwd
</pre></div>


<p>Ensure the environment is ready to deploy with prechecks.<br>
Until prechecks does not succeed do not start deployment.<br>
Fix what is necessary.</p>
<div class="highlight"><pre><span></span># kolla-ansible prechecks -i ~/multinode
</pre></div>


<p>Pull Docker images on the servers, this can be skipped because will be
made in deploy step, but doing it first will ensure all the nodes have
the images you need and will minimize the deployment time.</p>
<div class="highlight"><pre><span></span># kolla-ansible pull -i ~/multinode
</pre></div>


<p>Deploy kolla-ansible and do a woot for kolla ;)</p>
<div class="highlight"><pre><span></span># kolla-ansible deploy -i ~/multinode
</pre></div>


<p>Create credentials file and source it.</p>
<div class="highlight"><pre><span></span># kolla-ansible post-deploy -i ~/multinode
# source /etc/kolla/admin-openrc.sh
</pre></div>


<p>Check that all containers are running and none of them are restarting or
exiting.</p>
<div class="highlight"><pre><span></span># docker ps -a --filter status=exited --filter status=restarting
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
</pre></div>


<p>Install required python clients</p>
<div class="highlight"><pre><span></span># pip install python-openstackclient python-designateclient python-neutronclient
</pre></div>


<p>Execute a base OpenStack configuration (public and internal networks,
cirros image).<br>
Do no execute this script if custom networks are going to be used.</p>
<div class="highlight"><pre><span></span># sh /usr/share/kolla-ansible/init-runonce
</pre></div>


<p>Create a sample designate zone.</p>
<div class="highlight"><pre><span></span># openstack zone create --email admin@sample.openstack.org sample.openstack.org.
+----------------+--------------------------------------+
| Field          | Value                                |
+----------------+--------------------------------------+
| action         | CREATE                               |
| attributes     |                                      |
| created_at     | 2017-02-22T13:14:39.000000           |
| description    | None                                 |
| email          | admin@sample.openstack.org           |
| id             | 4a44b0c9-bd07-4f5c-8908-523f453f269d |
| masters        |                                      |
| name           | sample.openstack.org.                |
| pool_id        | 85d18aec-453e-45ae-9eb3-748841a1da12 |
| project_id     | 937d49af6cfe4ef080a79f9a833d7c7d     |
| serial         | 1487769279                           |
| status         | PENDING                              |
| transferred_at | None                                 |
| ttl            | 3600                                 |
| type           | PRIMARY                              |
| updated_at     | None                                 |
| version        | 1                                    |
+----------------+--------------------------------------+
</pre></div>


<p>Configure designate sink to make use of the previously created zone,
sink will need zone_id to automatically create neutron and nova records
into designate.</p>
<div class="highlight"><pre><span></span># mkdir -p /etc/kolla/config/designate/designate-sink/
# vi /etc/kolla/config/designate/designate-sink.conf
[handler:nova_fixed]
zone_id = 4a44b0c9-bd07-4f5c-8908-523f453f269d
[handler:neutron_floatingip]
zone_id = 4a44b0c9-bd07-4f5c-8908-523f453f269d
</pre></div>


<p>After configure designate-sink.conf, reconfigure designate to make use
of this configuration.</p>
<div class="highlight"><pre><span></span># kolla-ansible reconfigure -i ~/multinode --tags designate
</pre></div>


<p>List networks.</p>
<div class="highlight"><pre><span></span># neutron net-list
+--------------------------------------+----------+----------------------------------+--------------------------------------------------+
| id                                   | name     | tenant_id                        | subnets                                          |
+--------------------------------------+----------+----------------------------------+--------------------------------------------------+
| 3b56c605-5a01-45be-9ed6-e4c3285e4366 | demo-net | 937d49af6cfe4ef080a79f9a833d7c7d | 7f28f050-77b2-426e-b963-35b682077993 10.0.0.0/24 |
| 6954d495-fb8c-4b0b-98a9-9672a7f65b7c | public1  | 937d49af6cfe4ef080a79f9a833d7c7d | 9bd9feca-40a7-4e82-b912-e51b726ad746 10.0.2.0/24 |
+--------------------------------------+----------+----------------------------------+--------------------------------------------------+
</pre></div>


<p>Update the network with a dns_domain.</p>
<div class="highlight"><pre><span></span># neutron net-update 3b56c605-5a01-45be-9ed6-e4c3285e4366 --dns_domain sample.openstack.org.
Updated network: 3b56c605-5a01-45be-9ed6-e4c3285e4366
</pre></div>


<p>Ensure dns_domain is properly applied.</p>
<div class="highlight"><pre><span></span># neutron net-show 3b56c605-5a01-45be-9ed6-e4c3285e4366
+---------------------------+--------------------------------------+
| Field                     | Value                                |
+---------------------------+--------------------------------------+
| admin_state_up            | True                                 |
| availability_zone_hints   |                                      |
| availability_zones        | nova                                 |
| created_at                | 2017-02-22T13:13:06Z                 |
| description               |                                      |
| dns_domain                | sample.openstack.org.                |
| id                        | 3b56c605-5a01-45be-9ed6-e4c3285e4366 |
| ipv4_address_scope        |                                      |
| ipv6_address_scope        |                                      |
| mtu                       | 1450                                 |
| name                      | demo-net                             |
| port_security_enabled     | True                                 |
| project_id                | 937d49af6cfe4ef080a79f9a833d7c7d     |
| provider:network_type     | vxlan                                |
| provider:physical_network |                                      |
| provider:segmentation_id  | 27                                   |
| revision_number           | 6                                    |
| router:external           | False                                |
| shared                    | False                                |
| status                    | ACTIVE                               |
| subnets                   | 7f28f050-77b2-426e-b963-35b682077993 |
| tags                      |                                      |
| tenant_id                 | 937d49af6cfe4ef080a79f9a833d7c7d     |
| updated_at                | 2017-02-22T13:25:16Z                 |
+---------------------------+--------------------------------------+
</pre></div>


<p>Create a new instance in the previously updated network.</p>
<div class="highlight"><pre><span></span># openstack server create   
   --image cirros   
   --flavor m1.tiny   
   --key-name mykey   
   --nic net-id=3b56c605-5a01-45be-9ed6-e4c3285e4366   
   demo1
</pre></div>


<p>Once the instance is ACTIVE, check the IP associated.</p>
<div class="highlight"><pre><span></span># openstack server list
+--------------------------------------+-------+--------+-------------------+------------+
| ID                                   | Name  | Status | Networks          | Image Name |
+--------------------------------------+-------+--------+-------------------+------------+
| d483e4ee-58c2-4e1e-9384-85174630428e | demo1 | ACTIVE | demo-net=10.0.0.3 | cirros     |
+--------------------------------------+-------+--------+-------------------+------------+
</pre></div>


<p>List records in the designate zone.<br>
As you can see there is a record in designate associated with the
instance IP.</p>
<div class="highlight"><pre><span></span># openstack recordset list sample.openstack.org.
+--------------------------------------+----------------------------------+------+-------------------------------------------+--------+--------+
| id                                   | name                             | type | records                                   | status | action |
+--------------------------------------+----------------------------------+------+-------------------------------------------+--------+--------+
| 4f70531e-c325-4ffd-a8d3-8172bd5163b8 | sample.openstack.org.            | SOA  | sample.openstack.org.                     | ACTIVE | NONE   |
|                                      |                                  |      | admin.sample.openstack.org. 1487770304    |        |        |
|                                      |                                  |      | 3586 600 86400 3600                       |        |        |
| a9a09c5f-ccf1-4b52-8400-f36e8faa9549 | sample.openstack.org.            | NS   | sample.openstack.org.                     | ACTIVE | NONE   |
| aa6cd25d-186e-425b-9153-699d8b0811de | 10-0-0-3.sample.openstack.org.   | A    | 10.0.0.3                                  | ACTIVE | NONE   |
| 713650a5-a45e-470b-9539-74e110b15115 | demo1.None.sample.openstack.org. | A    | 10.0.0.3                                  | ACTIVE | NONE   |
| 6506e6f6-f535-45eb-9bfb-4ac1f16c5c9b | demo1.sample.openstack.org.      | A    | 10.0.0.3                                  | ACTIVE | NONE   |
+--------------------------------------+----------------------------------+------+-------------------------------------------+--------+--------+
</pre></div>


<p>Validate that designate resolves the DNS record.<br>
You can use designate mDNS service or directly to bind9 servers to
validate the test.</p>
<div class="highlight"><pre><span></span><span class="cp"># dig +short -p 5354 @172.28.128.3 demo1.sample.openstack.org. A</span>
<span class="mf">10.0.0.3</span>
<span class="cp"># dig +short -p 53 @172.28.128.3 demo1.sample.openstack.org. A</span>
<span class="mf">10.0.0.3</span>
</pre></div>


<p>If you find any issue with designate in kolla-ansible or kolla, please
fill a bug <a href="https://bugs.launchpad.net/kolla-ansible/+filebug">https://bugs.launchpad.net/kolla-ansible/+filebug</a></p>
<p>Regards,<br>
Eduardo Gonzalez</p>
    </div><!-- /.entry-content -->
    <div class="comments">
      <h2>Comments !</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_identifier = "deploy-openstack-designate-with-kolla-ansible.html";
        var disqus_url = "https://egonzalez90.github.io/deploy-openstack-designate-with-kolla-ansible.html";
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//egonzalez-1.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
    </div>

  </article>
</section>
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://egonzalez90.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://twitter.com/egongu90">Twitter</a></li>
                            <li><a href="https://www.linkedin.com/in/eduardogonzalezgutierrez">Linkedin</a></li>
                            <li><a href="https://github.com/egonzalez90">Github</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme <a href="https://github.com/blueicefield/pelican-blueidea/">blueidea</a>, inspired by the default theme.</p>
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'egonzalez-1';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>