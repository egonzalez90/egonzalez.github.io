<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>OpenStack Stuff - availability zones</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">OpenStack Stuff </a></h1>
                <nav><ul>
                    <li><a href="/category/linux.html">Linux</a></li>
                    <li><a href="/category/linux-openstack.html">Linux, OpenStack</a></li>
                    <li><a href="/category/linux-openstack-various.html">Linux, OpenStack, Various</a></li>
                    <li><a href="/category/linux-various.html">Linux, Various</a></li>
                    <li><a href="/category/linux-virtualizacion.html">Linux, Virtualizacion</a></li>
                    <li><a href="/category/misc.html">misc</a></li>
                    <li><a href="/category/openstack.html">OpenStack</a></li>
                    <li><a href="/category/reflexiones.html">Reflexiones</a></li>
                    <li><a href="/category/various.html">Various</a></li>
                    <li><a href="/category/virtualizacion.html">Virtualizacion</a></li>
                </ul>
                </nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/openstack-segregation-with-availability-zones-and-host-aggregates.html">OpenStack segregation with Availability Zones and Host Aggregates</a></h1>
<footer class="post-info">
        <span>Thu 14 January 2016</span>
<span>| tags: <a href="/tag/availability-zones.html">availability zones</a><a href="/tag/flavor.html">flavor</a><a href="/tag/guide.html">guide</a><a href="/tag/host-aggregates.html">host aggregates</a><a href="/tag/image.html">image</a><a href="/tag/meta.html">meta</a><a href="/tag/nova.html">nova</a><a href="/tag/openstack.html">openstack</a><a href="/tag/scheduler.html">scheduler</a><a href="/tag/segregation.html">segregation</a><a href="/tag/usage.html">usage</a></span>
</footer><!-- /.post-info --><p>When a new OpenStack cloud born, usually all servers run over the same
hardware and specifications, often, all servers are in the same
building, room, rack, even a chassis when the cloud is in the first
growth paces.</p>
<p>After a while, workloads increase and the current hardware is not enough
to process that workloads. At this point, your hardware is old and new
hardware is bought. This hardware has different storage disks, CPU, RAM
and so on. You passed from 10's of servers to 100's. DataCenter racks,
rooms and buildings are too small and the growing cloud needs redundancy
between cities or countries.</p>
<p>OpenStack offers a few solutions for that purpose, called Regions,
Cells, Availability Zones and Host Aggregates.<br>
Now, we are going to focus on Availability Zones and Host Aggregates,
which are the way to segregate computational workloads.</p>
<ul>
<li>Host Aggregates:<ul>
<li>Host Aggregates represent a logical set of
    properties/characteristics a group of hosts owns in the form of
    metadata. Imagine some of your servers have SSD disks and the
    other ones SATA, you can map those properties SSD/SATA to a
    group of hosts, when a image or flavor with the metaparameter
    associated is launched, Nova Scheduler will filter the available
    hosts with the meta parameter value and boot the instance on
    hosts with the desired property. Host Aggregates are managed by
    OpenStack admins.</li>
</ul>
</li>
<li>Availability Zones<ul>
<li>Availability Zones represent a logical partition of the
    infrastructure(not necessary but is the common use case) in the
    form of racks, rooms, buildings, etc. Customers can launch
    instances in the desired Availability Zone.</li>
</ul>
</li>
</ul>
<p>Usually, Host Aggregates are mapped to Availability Zones allowing
customers to use the desired set of hardware or characteristics to boot
instances.</p>
<p>At the end of this guide you will know how to:</p>
<ol>
<li>Create Availability Zones and Host Aggregates.</li>
<li>Adding hosts to Host Aggregates and Availability Zones.</li>
<li>Launch instances directly to Availability Zones.</li>
<li>Configure nova scheduler for Host Aggregates usage.</li>
<li>Configure Images and Flavors for scheduling to Host Aggregates.</li>
<li>Launch instances based on flavors and image parameters.</li>
</ol>
<p>Let's start: \00/</p>
<p>Create two Host Aggregate called <code>"az1-ag"/"az2-ag"</code>, this command also,
will create two Availability Zones called <code>"az1"/"az2"</code>.<br>
By default, when a Host Aggregate is created with an Availability Zone,
a metadata key called <code>"availability_zone=NAME_OF_AZ</code>" will be created.</p>
<div class="highlight"><pre><span></span># nova aggregate-create az1-ag az1
+----+--------+-------------------+-------+-------------------------+
| Id | Name   | Availability Zone | Hosts | Metadata                |
+----+--------+-------------------+-------+-------------------------+
| 2  | az1-ag | az1               |       | &#39;availability_zone=az1&#39; |
+----+--------+-------------------+-------+-------------------------+
# nova aggregate-create az2-ag az2
+----+--------+-------------------+-------+-------------------------+
| Id | Name   | Availability Zone | Hosts | Metadata                |
+----+--------+-------------------+-------+-------------------------+
| 3  | az2-ag | az2               |       | &#39;availability_zone=az2&#39; |
+----+--------+-------------------+-------+-------------------------+
</pre></div>


<p>Add one or more compute nodes to Host Aggregates.</p>
<div class="highlight"><pre><span></span># nova aggregate-add-host 2 compute1az
Host compute1az has been successfully added for aggregate 2 
+----+--------+-------------------+--------------+-------------------------+
| Id | Name   | Availability Zone | Hosts        | Metadata                |
+----+--------+-------------------+--------------+-------------------------+
| 2  | az1-ag | az1               | &#39;compute1az&#39; | &#39;availability_zone=az1&#39; |
+----+--------+-------------------+--------------+-------------------------+
# nova aggregate-add-host 3 compute2az
Host compute2az has been successfully added for aggregate 3 
+----+--------+-------------------+--------------+-------------------------+
| Id | Name   | Availability Zone | Hosts        | Metadata                |
+----+--------+-------------------+--------------+-------------------------+
| 3  | az2-ag | az2               | &#39;compute2az&#39; | &#39;availability_zone=az2&#39; |
+----+--------+-------------------+--------------+-------------------------+
</pre></div>


<p>Details about a Host Aggregate can be reviewed with:</p>
<div class="highlight"><pre><span></span># nova aggregate-details az1-ag
+----+--------+-------------------+--------------+-------------------------+
| Id | Name   | Availability Zone | Hosts        | Metadata                |
+----+--------+-------------------+--------------+-------------------------+
| 2  | az1-ag | az1               | &#39;compute1az&#39; | &#39;availability_zone=az1&#39; |
+----+--------+-------------------+--------------+-------------------------+
# nova aggregate-details az2-ag
+----+--------+-------------------+--------------+-------------------------+
| Id | Name   | Availability Zone | Hosts        | Metadata                |
+----+--------+-------------------+--------------+-------------------------+
| 3  | az2-ag | az2               | &#39;compute2az&#39; | &#39;availability_zone=az2&#39; |
+----+--------+-------------------+--------------+-------------------------+
</pre></div>


<p>List Availability Zones and check status.</p>
<div class="highlight"><pre><span></span><span class="c1"># nova availability-zone-list</span>
<span class="s s-Atom">+-----------------------+----------------------------------------+</span>
<span class="p">|</span> <span class="nv">Name</span>                  <span class="p">|</span> <span class="nv">Status</span>                                 <span class="p">|</span>
<span class="s s-Atom">+-----------------------+----------------------------------------+</span>
<span class="p">|</span> <span class="s s-Atom">internal</span>              <span class="p">|</span> <span class="s s-Atom">available</span>                              <span class="p">|</span>
<span class="p">|</span> <span class="p">|</span><span class="o">-</span> <span class="s s-Atom">controlleraz</span>       <span class="p">|</span>                                        <span class="p">|</span>
<span class="p">|</span> <span class="p">|</span> <span class="p">|</span><span class="o">-</span> <span class="s s-Atom">nova</span><span class="o">-</span><span class="s s-Atom">conductor</span>   <span class="p">|</span> <span class="nf">enabled</span> <span class="o">:-</span><span class="p">)</span> <span class="mi">2016</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">14</span><span class="nv">T19</span><span class="s s-Atom">:</span><span class="mi">08</span><span class="s s-Atom">:</span><span class="mf">16.000000</span> <span class="p">|</span>
<span class="p">|</span> <span class="p">|</span> <span class="p">|</span><span class="o">-</span> <span class="s s-Atom">nova</span><span class="o">-</span><span class="s s-Atom">consoleauth</span> <span class="p">|</span> <span class="nf">enabled</span> <span class="o">:-</span><span class="p">)</span> <span class="mi">2016</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">14</span><span class="nv">T19</span><span class="s s-Atom">:</span><span class="mi">08</span><span class="s s-Atom">:</span><span class="mf">16.000000</span> <span class="p">|</span>
<span class="p">|</span> <span class="p">|</span> <span class="p">|</span><span class="o">-</span> <span class="s s-Atom">nova</span><span class="o">-</span><span class="s s-Atom">scheduler</span>   <span class="p">|</span> <span class="nf">enabled</span> <span class="o">:-</span><span class="p">)</span> <span class="mi">2016</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">14</span><span class="nv">T19</span><span class="s s-Atom">:</span><span class="mi">08</span><span class="s s-Atom">:</span><span class="mf">16.000000</span> <span class="p">|</span>
<span class="p">|</span> <span class="p">|</span> <span class="p">|</span><span class="o">-</span> <span class="s s-Atom">nova</span><span class="o">-</span><span class="s s-Atom">cert</span>        <span class="p">|</span> <span class="nf">enabled</span> <span class="o">:-</span><span class="p">)</span> <span class="mi">2016</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">14</span><span class="nv">T19</span><span class="s s-Atom">:</span><span class="mi">08</span><span class="s s-Atom">:</span><span class="mf">13.000000</span> <span class="p">|</span>
<span class="p">|</span> <span class="s s-Atom">az2</span>                   <span class="p">|</span> <span class="s s-Atom">available</span>                              <span class="p">|</span>
<span class="p">|</span> <span class="p">|</span><span class="o">-</span> <span class="s s-Atom">compute2az</span>         <span class="p">|</span>                                        <span class="p">|</span>
<span class="p">|</span> <span class="p">|</span> <span class="p">|</span><span class="o">-</span> <span class="s s-Atom">nova</span><span class="o">-</span><span class="s s-Atom">compute</span>     <span class="p">|</span> <span class="nf">enabled</span> <span class="o">:-</span><span class="p">)</span> <span class="mi">2016</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">14</span><span class="nv">T19</span><span class="s s-Atom">:</span><span class="mi">08</span><span class="s s-Atom">:</span><span class="mf">12.000000</span> <span class="p">|</span>
<span class="p">|</span> <span class="s s-Atom">az1</span>                   <span class="p">|</span> <span class="s s-Atom">available</span>                              <span class="p">|</span>
<span class="p">|</span> <span class="p">|</span><span class="o">-</span> <span class="s s-Atom">compute1az</span>         <span class="p">|</span>                                        <span class="p">|</span>
<span class="p">|</span> <span class="p">|</span> <span class="p">|</span><span class="o">-</span> <span class="s s-Atom">nova</span><span class="o">-</span><span class="s s-Atom">compute</span>     <span class="p">|</span> <span class="nf">enabled</span> <span class="o">:-</span><span class="p">)</span> <span class="mi">2016</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">14</span><span class="nv">T19</span><span class="s s-Atom">:</span><span class="mi">08</span><span class="s s-Atom">:</span><span class="mf">12.000000</span> <span class="p">|</span>
<span class="s s-Atom">+-----------------------+----------------------------------------+</span>
</pre></div>


<p>Other method you can use:</p>
<div class="highlight"><pre><span></span># nova service-list
+----+------------------+--------------+----------+---------+-------+----------------------------+-----------------+
| Id | Binary           | Host         | Zone     | Status  | State | Updated_at                 | Disabled Reason |
+----+------------------+--------------+----------+---------+-------+----------------------------+-----------------+
| 1  | nova-consoleauth | controlleraz | internal | enabled | up    | 2016-01-14T19:54:36.000000 | -               |
| 2  | nova-scheduler   | controlleraz | internal | enabled | up    | 2016-01-14T19:54:36.000000 | -               |
| 3  | nova-conductor   | controlleraz | internal | enabled | up    | 2016-01-14T19:54:35.000000 | -               |
| 4  | nova-cert        | controlleraz | internal | enabled | up    | 2016-01-14T19:54:33.000000 | -               |
| 5  | nova-compute     | compute2az   | az2      | enabled | up    | 2016-01-14T19:54:32.000000 | -               |
| 6  | nova-compute     | compute1az   | az1      | enabled | up    | 2016-01-14T19:54:32.000000 | -               |
+----+------------------+--------------+----------+---------+-------+----------------------------+-----------------+
</pre></div>


<p>Launch two instances using <code>"--availability-zone AZ</code>" option, you can
even select the compute node to use, just use
<code>"--availability-zone AZ:COMPUTE_NODE</code>".</p>
<div class="highlight"><pre><span></span># nova boot --flavor m1.tiny --image cirros --nic net-id=6d62149e-74d3-4e52-9813-53ad207309f4 --availability-zone az1 instanceaz1
# nova boot --flavor m1.tiny --image cirros --nic net-id=6d62149e-74d3-4e52-9813-53ad207309f4 --availability-zone az2 instanceaz2
</pre></div>


<p>Ensure the instances are running in the desired Availability Zone.</p>
<div class="highlight"><pre><span></span># nova show instanceaz1 | grep OS-EXT-AZ | awk &#39;{print$2&quot;:&quot;$4}&#39;
OS-EXT-AZ:availability_zone:az1
# nova show instanceaz2 | grep OS-EXT-AZ | awk &#39;{print$2&quot;:&quot;$4}&#39;
OS-EXT-AZ:availability_zone:az2
</pre></div>


<p>List Glance images.</p>
<div class="highlight"><pre><span></span># glance image-list
+--------------------------------------+----------+
| ID                                   | Name     |
+--------------------------------------+----------+
| a6d7a606-f725-480a-9b1b-7b3ae39b93d4 | cirros   |
| a6540d72-dff7-4fb1-bc64-a8ea69e65178 | imageaz1 |
| 9c7e2d55-0b96-43e2-9231-88e426edb350 | imageaz2 |
+--------------------------------------+----------+
</pre></div>


<p>Update the images with custom properties, i use <code>"availability_zone"</code>
because is the default meta parameter a Host Aggregate owns when is
inside Availability Zones.</p>
<div class="highlight"><pre><span></span># glance image-update --property availability_zone=az1 a6540d72-dff7-4fb1-bc64-a8ea69e65178
+-------------------+--------------------------------------+
| Property          | Value                                |
+-------------------+--------------------------------------+
| availability_zone | az1                                  |
| checksum          | 133eae9fb1c98f45894a4e60d8736619     |
| container_format  | bare                                 |
| created_at        | 2016-01-14T19:59:04Z                 |
| disk_format       | qcow2                                |
| id                | a6540d72-dff7-4fb1-bc64-a8ea69e65178 |
| min_disk          | 0                                    |
| min_ram           | 0                                    |
| name              | imageaz1                             |
| owner             | 0571c6769c3f46acb195eeb01b87ae38     |
| protected         | False                                |
| size              | 13200896                             |
| status            | active                               |
| tags              | []                                   |
| updated_at        | 2016-01-14T20:13:05Z                 |
| virtual_size      | None                                 |
| visibility        | private                              |
+-------------------+--------------------------------------+
# glance image-update --property availability_zone=az2 9c7e2d55-0b96-43e2-9231-88e426edb350
+-------------------+--------------------------------------+
| Property          | Value                                |
+-------------------+--------------------------------------+
| availability_zone | az2                                  |
| checksum          | 133eae9fb1c98f45894a4e60d8736619     |
| container_format  | bare                                 |
| created_at        | 2016-01-14T19:59:10Z                 |
| disk_format       | qcow2                                |
| id                | 9c7e2d55-0b96-43e2-9231-88e426edb350 |
| min_disk          | 0                                    |
| min_ram           | 0                                    |
| name              | imageaz2                             |
| owner             | 0571c6769c3f46acb195eeb01b87ae38     |
| protected         | False                                |
| size              | 13200896                             |
| status            | active                               |
| tags              | []                                   |
| updated_at        | 2016-01-14T20:13:27Z                 |
| virtual_size      | None                                 |
| visibility        | private                              |
+-------------------+--------------------------------------+
</pre></div>


<p>Boot two instances, now we use images with custom properties, those
properties will map to Availability Zones(you can use other type of
parameters mapping to Host Aggregates characteristics).</p>
<div class="highlight"><pre><span></span># nova boot --flavor m1.tiny --image imageaz1 --nic net-id=6d62149e-74d3-4e52-9813-53ad207309f4 instanceimageaz1
# nova boot --flavor m1.tiny --image imageaz2 --nic net-id=6d62149e-74d3-4e52-9813-53ad207309f4 instanceimageaz2
</pre></div>


<p>Ensure the instances booted in the desired Availability Zone.</p>
<div class="highlight"><pre><span></span># nova show instanceimageaz1 | grep OS-EXT-AZ | awk &#39;{print$2&quot;:&quot;$4}&#39;
OS-EXT-AZ:availability_zone:az1
# nova show instanceimageaz2 | grep OS-EXT-AZ | awk &#39;{print$2&quot;:&quot;$4}&#39;
OS-EXT-AZ:availability_zone:az2
</pre></div>


<p>Other method to launch instances is with parameters in flavors.<br>
Create two flavors.</p>
<div class="highlight"><pre><span></span># nova flavor-create --is-public true flavoraz1 6 512 1 1
+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+
| ID | Name      | Memory_MB | Disk | Ephemeral | Swap | VCPUs | RXTX_Factor | Is_Public |
+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+
| 7  | flavoraz1 | 512       | 1    | 0         |      | 1     | 1.0         | True      |
+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+
# nova flavor-create --is-public true flavoraz2 7 512 1 1
+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+
| ID | Name      | Memory_MB | Disk | Ephemeral | Swap | VCPUs | RXTX_Factor | Is_Public |
+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+
| 8  | flavoraz2 | 512       | 1    | 0         |      | 1     | 1.0         | True      |
+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+
</pre></div>


<p>Add metadata to a Host Aggregate with some characteristic property as
can be fast HD or cheap HW.</p>
<div class="highlight"><pre><span></span># nova aggregate-set-metadata az1-ag fast=true
Metadata has been successfully updated for aggregate 2.
+----+--------+-------------------+--------------+--------------------------------------+
| Id | Name   | Availability Zone | Hosts        | Metadata                             |
+----+--------+-------------------+--------------+--------------------------------------+
| 2  | az1-ag | az1               | &#39;compute1az&#39; | &#39;availability_zone=az1&#39;, &#39;fast=true&#39; |
+----+--------+-------------------+--------------+--------------------------------------+
# nova aggregate-set-metadata az2-ag cheap=true
Metadata has been successfully updated for aggregate 3.
+----+--------+-------------------+--------------+---------------------------------------+
| Id | Name   | Availability Zone | Hosts        | Metadata                              |
+----+--------+-------------------+--------------+---------------------------------------+
| 3  | az2-ag | az2               | &#39;compute2az&#39; | &#39;availability_zone=az2&#39;, &#39;cheap=true&#39; |
+----+--------+-------------------+--------------+---------------------------------------+
</pre></div>


<p>Update the previous created flavors with the associated metadata key
with the Host Aggregate.</p>
<div class="highlight"><pre><span></span># nova flavor-key flavoraz1 set  aggregate_instance_extra_specs:fast=true
# nova flavor-key flavoraz2 set  aggregate_instance_extra_specs:cheap=true
</pre></div>


<p>Ensure, the properties are properly created.</p>
<div class="highlight"><pre><span></span># nova flavor-show 7 | grep fast | awk &#39;{print$4$5}&#39;
{&quot;aggregate_instance_extra_specs:fast&quot;:&quot;true&quot;}
# nova flavor-show 8 | grep cheap | awk &#39;{print$4$5}&#39;
{&quot;aggregate_instance_extra_specs:cheap&quot;:&quot;true&quot;}
</pre></div>


<p>By default, Nova Scheduler don't allow filtering by extra Specs inserted
in flavors or images.<br>
First, ensure the following scheduler filters are allowed in Control
nodes.</p>
<div class="highlight"><pre><span></span># egrep ^scheduler_default_filters /etc/nova/nova.conf 
scheduler_default_filters=AggregateInstanceExtraSpecsFilter,RetryFilter,AvailabilityZoneFilter,RamFilter,ComputeFilter,ComputeCapabilitiesFilter,ImagePropertiesFilter,ServerGroupAntiAffinityFilter,ServerGroupAffinityFilter
</pre></div>


<p>If a change has been done in nova.conf file, restart nova services</p>
<div class="highlight"><pre><span></span># openstack-service restart nova
</pre></div>


<p>Boot another two instaces, now using custom flavors</p>
<div class="highlight"><pre><span></span># nova boot --flavor flavoraz1 --image cirros --nic net-id=6d62149e-74d3-4e52-9813-53ad207309f4 instanceflavoraz1
# nova boot --flavor flavoraz2 --image cirros --nic net-id=6d62149e-74d3-4e52-9813-53ad207309f4 instanceflavoraz2
</pre></div>


<p>Check where the instances are running.</p>
<div class="highlight"><pre><span></span># nova show instanceflavoraz1 | grep OS-EXT-AZ | awk &#39;{print$2&quot;:&quot;$4}&#39;
OS-EXT-AZ:availability_zone:az1
# nova show instanceflavoraz2 | grep OS-EXT-AZ | awk &#39;{print$2&quot;:&quot;$4}&#39;
OS-EXT-AZ:availability_zone:az2
</pre></div>


<p>That's all for now<br>
Hope this guide helps.<br>
Regards</p><p><a href="/openstack-segregation-with-availability-zones-and-host-aggregates.html#disqus_thread">comments</a></p>                </article>
<p class="paginator">
    Page 1 / 1
</p>
            </aside><!-- /#featured -->
            </ol><!-- /#posts-list -->
            </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="https://twitter.com/egongu90">Twitter</a></li>
                            <li><a href="https://www.linkedin.com/in/eduardogonzalezgutierrez">Linkedin</a></li>
                            <li><a href="https://github.com/egonzalez90">Github</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme <a href="https://github.com/blueicefield/pelican-blueidea/">blueidea</a>, inspired by the default theme.</p>
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'egonzalez-1';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>