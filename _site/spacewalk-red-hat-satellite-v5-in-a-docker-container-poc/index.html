<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>Spacewalk (Red Hat Satellite v5) in a Docker container PoC</title>
  <meta name="description" content="Spacewalk was the upstream project to provide a Linux systems management layer on which Red Hat Satellite was based, was based at least until RH Satellite version 5. Newer versions are not anymore based on Spacewalk, instead Satellite is a federation of several upstream open source projects, including Katello, Foreman, Pulp, and Candlepin. Some weeks ago, a friend asked me if I knew a Docker container image for Satellite. I have not found any image. What I found was some Spacewalk images, but sadly none of them worked for me. I decided to create an image for this purpose. While developing the image, I found serious troubles to make it run with systemd (I’m a fan of systemd, but not inside containers yet). The result was a semi functional working image. I said semi functional because some Spacewalk features are not working (probably an issue with systemd again). The main problem was that spacewalk-setup script starts and uses systemd to configure the database and the other needed services, that’s OK in a VM but not in a container. So i needed to hack into postgres setup and start the services with the typical command --config-file file.conf executed from supervisord as Docker entrypoint. Currently there is an issue with osa-dispatcher, on which I can’t find a fix to make it run. This image is primarily created just for test Spacewalk interface and be more comfortable with it aka testing/development purposes, or just to have fun hacking with Docker containers. Now, I’m going to make a short description of what the Dockerfile makes and then start the container. Have fun. I used centos as image base for this PoC FROM centos:7 Typical Maintainer line MAINTAINER Eduardo Gonzalez Gutierrez &amp;lt;dabarren@gmail.com&amp;gt; Add jpackage repo which provides Java packages for Linux COPY jpackage-generic.repo /etc/yum.repos.d/jpackage-generic.repo Install EPEL and Spacewalk repositories, after install, clean all stored cache to minimize image size RUN yum install -y http://yum.spacewalkproject.org/2.5/RHEL/7/x86_64/spacewalk-repo-2.5-3.el7.noarch.rpm \ epel-release &amp;amp;&amp;amp; \ yum clean all Import Keys to allow installation from these repositories RUN rpm --import http://www.jpackage.org/jpackage.asc &amp;amp;&amp;amp; \ rpm --import https://dl.fedoraproject.org/pub/epel/RPM-GPG-KEY-EPEL-7 &amp;amp;&amp;amp; \ rpm --import http://yum.spacewalkproject.org/RPM-GPG-KEY-spacewalk-2015 &amp;amp;&amp;amp; \ yum clean all Install spacewalk and supervisord packages RUN yum -y install \ spacewalk-setup-postgresql \ spacewalk-postgresql \ supervisor \ yum clean all Copy the example file used to sync spacewalk database in a later step COPY answerfile.txt /tmp/answerfile.txt Open necessary ports EXPOSE 80 443 5222 68 69 Change to postgres user USER postgres Initialize the database RUN /usr/bin/pg_ctl initdb -D /var/lib/pgsql/data/ Create spacewalk database, user, role and create pltclu language RUN /usr/bin/pg_ctl start -D /var/lib/pgsql/data/ -w -t 300 &amp;amp;&amp;amp; \ psql -c &#39;CREATE DATABASE spaceschema&#39; &amp;amp;&amp;amp; \ psql -c &quot;CREATE USER spaceuser WITH PASSWORD &#39;spacepw&#39;&quot; &amp;amp;&amp;amp; \ psql -c &#39;ALTER ROLE spaceuser SUPERUSER&#39; &amp;amp;&amp;amp; \ createlang pltclu spaceschema Change to root user USER root Start the database and execute spacewalk configuration script RUN su -c &quot;/usr/bin/pg_ctl start -D /var/lib/pgsql/data/ -w -t 300&quot; postgres &amp;amp;&amp;amp; \ su -c &quot;spacewalk-setup --answer-file=/tmp/answerfile.txt --skip-db-diskspace-check --skip-db-install&quot; root ; exit 0 Copy supervisord configuration ADD supervisord.conf /etc/supervisord.d/supervisord.conf Use supervisord command to start all services at container launch time ENTRYPOINT supervisord -c /etc/supervisord.d/supervisord.conf You can check or download the source code at GitHub https://github.com/egonzalez90/docker-spacewalk I uploaded the image to DockerHub, which is auto-build from my GitHub repository, you can find it with the following command. [egonzalez@localhost ~]$ docker search spacewalk INDEX NAME DESCRIPTION STARS OFFICIAL AUTOMATED docker.io docker.io/ruo91/spacewalk Spacewalk is an open source Linux systems ... 3 [OK] docker.io docker.io/jamesnetherton/spacewalk Spacewalk running under Docker 1 docker.io docker.io/coffmant/spacewalk-docker Spacewalk 0 [OK] docker.io docker.io/csabakollar/spacewalk Spacewalk 2.4 in a CentOS6 container 0 docker.io docker.io/egonzalez90/spacewalk Spacewalk docker image 0 [OK] docker.io docker.io/jdostal/spacewalk-clients Repository containing spacewalk-clients 0 docker.io docker.io/jhutar/spacewalk-client 0 docker.io docker.io/norus/spacewalk-reposync 0 docker.io docker.io/pajinek/spacewalk-client 0 [OK] docker.io docker.io/perfectweb/spacewalk spacewalk 0 [OK] docker.io docker.io/researchiteng/docker-spacewalk spacewalk is the open source version of Re... 0 [OK] docker.io docker.io/varhoo/spacewalk-proxy 0 [OK] To start the container use the following command. If you don’t have the image locally, it will download the image from DockerHub [egonzalez@localhost ~]$ docker run -d --privileged=True egonzalez90/spacewalk Unable to find image &#39;egonzalez90/spacewalk:latest&#39; locally Trying to pull repository docker.io/egonzalez90/spacewalk ... latest: Pulling from docker.io/egonzalez90/spacewalk a3ed95caeb02: Already exists da71393503ec: Already exists 519093688e2c: Pull complete 97bbffaa9fc9: Pull complete 63bfb115f62d: Pull complete 929bbb68aff9: Pull complete 532bc4af8e1a: Pull complete 3eb667dda9ee: Pull complete 275894897aa4: Pull complete 93bcddf9cedb: Pull complete 266c3b70754f: Pull complete Digest: sha256:a4dd98548f9dbb405fb4c6bb4a2a07b83d5f2bf730f29f71913b72876b1a61ab Status: Downloaded newer image for docker.io/egonzalez90/spacewalk:latest ded4a8b7eb1ee61fecc8ddc2eb1b092917a361bc36f7f752b32d76e79501d70a Now you have the container running, check if all the ports are properly exposed [egonzalez@localhost ~]$ docker ps --latest --format &#39;table \t\t&#39; CONTAINER ID IMAGE PORTS ded4a8b7eb1e egonzalez90/spacewalk 68-69/tcp, 80/tcp, 443/tcp, 5222/tcp Get the container IP address in order to enter from a Web Browser [egonzalez@localhost ~]$ docker inspect ded4a8b7eb1e | egrep IPAddress &quot;SecondaryIPAddresses&quot;: null, &quot;IPAddress&quot;: &quot;172.17.0.3&quot;, &quot;IPAddress&quot;: &quot;172.17.0.3&quot;, Open A browser and go to the container IP address, if you use HTTP, by default it will redirect you to HTTPS. The container uses an auto-signed SSL certificate, you have to add an exception in the Browser you use to allow connections to Spacewalk. Once in the Welcome page, create an Organization. Now you are in Spacewalk and can play/test some features. There is an issue I was not able to fix, so osa-dispatcher and some other features will not work with this image. If someone can give me an input to fix the issue it will appreciated. [egonzalez@localhost ~]$ docker logs ded4a8b7eb1e | egrep FATAL 2016-07-12 18:13:32,220 INFO gave up: osa-dispatcher entered FATAL state, too many start retries too quickly Thanks for your time and hopes this image at least serves you to learn and play with the interface. Regards, Eduardo Gonzalez">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://217.182.136.201:8080/spacewalk-red-hat-satellite-v5-in-a-docker-container-poc/">
  
  
  <link rel="alternate" type="application/rss+xml" title="OpenStack things" href="http://217.182.136.201:8080/feed.xml">

  

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="egongu90">
  <meta name="twitter:title" content="Spacewalk (Red Hat Satellite v5) in a Docker container PoC">
  <meta name="twitter:description" content="Spacewalk was the upstream project to provide a Linux systems management layer on which Red Hat Satellite was based, was based at least until RH Satellite version 5. Newer versions are not anymore ...">
  
    <meta name="twitter:creator" content="egongu90">
  
  

  <script type="text/javascript">
  WebFontConfig = {
    google: { families: [ 'Bitter:400,700,400italic:latin' ] }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">OpenStack things</a>

    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/">About</a>
      
        
        <a class="page-link" href="/archives/">Archives</a>
      
        
        <a class="page-link" href="https://github.com/yous/whiteglass">GitHub</a>
      
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">Spacewalk (Red Hat Satellite v5) in a Docker container PoC</h1>
    
    <p class="post-meta"><time datetime="2016-07-12T22:57:17+02:00" itemprop="datePublished">Jul 12, 2016</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Editor</span></span> • 
  
  
    
      <a href="/categories/linux/">Linux</a>,
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
  
    
  
    
  
    
      <a href="/categories/various/">Various</a>
    
  
    
  
    
  
    
  
    
  

</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Spacewalk was the upstream project to provide a Linux systems management layer on which Red Hat Satellite was based, was based at least until RH Satellite version 5. Newer versions are not anymore based on Spacewalk, instead Satellite is a federation of several upstream open source projects, including Katello, Foreman, Pulp, and Candlepin.</p>

<p>Some weeks ago, a friend asked me if I knew a Docker container image for Satellite.
I have not found any image. What I found was some Spacewalk images, but sadly none of them worked for me.
I decided to create an image for this purpose.</p>

<p>While developing the image, I found serious troubles to make it run with systemd (I’m a fan of systemd, but not inside containers yet).
The result was a semi functional working image. I said semi functional because some Spacewalk features are not working (probably an issue with systemd again).
The main problem was that spacewalk-setup script starts and uses systemd to configure the database and the other needed services, that’s OK in a VM but not in a container.
So i needed to hack into postgres setup and start the services with the typical <code>command --config-file file.conf</code> executed from supervisord as Docker entrypoint.
Currently there is an issue with <code>osa-dispatcher</code>, on which I can’t find a fix to make it run.</p>

<p>This image is primarily created just for test Spacewalk interface and be more comfortable with it aka testing/development purposes, or just to have fun hacking with Docker containers.</p>

<p>Now, I’m going to make a short description of what the Dockerfile makes and then start the container.
Have fun.</p>

<p>I used centos as image base for this PoC</p>
<pre>
FROM centos:7 
</pre>
<p>Typical Maintainer line</p>
<pre>
MAINTAINER Eduardo Gonzalez Gutierrez &lt;dabarren@gmail.com&gt;
</pre>
<p>Add jpackage repo which provides Java packages for Linux</p>
<pre>
COPY jpackage-generic.repo /etc/yum.repos.d/jpackage-generic.repo
</pre>
<p>Install EPEL and Spacewalk repositories, after install, clean all stored cache to minimize image size</p>
<pre>
RUN yum install -y http://yum.spacewalkproject.org/2.5/RHEL/7/x86_64/spacewalk-repo-2.5-3.el7.noarch.rpm \
        epel-release &amp;&amp; \
        yum clean all
</pre>
<p>Import Keys to allow installation from these repositories</p>
<pre>
RUN rpm --import http://www.jpackage.org/jpackage.asc &amp;&amp; \
    rpm --import https://dl.fedoraproject.org/pub/epel/RPM-GPG-KEY-EPEL-7 &amp;&amp; \
    rpm --import http://yum.spacewalkproject.org/RPM-GPG-KEY-spacewalk-2015 &amp;&amp; \
    yum clean all
</pre>
<p>Install spacewalk and supervisord packages</p>
<pre>
RUN yum -y install \
        spacewalk-setup-postgresql \
        spacewalk-postgresql \
        supervisor  \
        yum clean all
</pre>
<p>Copy the example file used to sync spacewalk database in a later step</p>
<pre>
COPY answerfile.txt /tmp/answerfile.txt
</pre>
<p>Open necessary ports</p>
<pre>
EXPOSE 80 443 5222 68 69
</pre>
<p>Change to postgres user</p>
<pre>
USER postgres
</pre>
<p>Initialize the database</p>
<pre>
RUN /usr/bin/pg_ctl initdb  -D /var/lib/pgsql/data/
</pre>
<p>Create spacewalk database, user, role and create pltclu language</p>
<pre>
RUN /usr/bin/pg_ctl start -D /var/lib/pgsql/data/  -w -t 300 &amp;&amp; \
     psql -c 'CREATE DATABASE spaceschema' &amp;&amp; \
     psql -c "CREATE USER spaceuser WITH PASSWORD 'spacepw'" &amp;&amp; \
     psql -c 'ALTER ROLE spaceuser SUPERUSER' &amp;&amp; \
     createlang pltclu spaceschema
</pre>
<p>Change to root user</p>
<pre>
USER root
</pre>
<p>Start the database and execute spacewalk configuration script</p>
<pre>
RUN su -c "/usr/bin/pg_ctl start -D /var/lib/pgsql/data/  -w -t 300" postgres &amp;&amp; \
    su -c "spacewalk-setup --answer-file=/tmp/answerfile.txt --skip-db-diskspace-check --skip-db-install" root ; exit 0
</pre>
<p>Copy supervisord configuration</p>
<pre>
ADD supervisord.conf /etc/supervisord.d/supervisord.conf
</pre>
<p>Use supervisord command to start all services at container launch time</p>
<pre>
ENTRYPOINT supervisord -c /etc/supervisord.d/supervisord.conf
</pre>
<p>You can check or download the source code at GitHub <a href="https://github.com/egonzalez90/docker-spacewalk" target="_blank">https://github.com/egonzalez90/docker-spacewalk</a></p>

<p>I uploaded the image to DockerHub, which is auto-build from my GitHub repository, you can find it with the following command.</p>
<pre>
[egonzalez@localhost ~]$ docker search spacewalk
INDEX       NAME                                       DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED
docker.io   docker.io/ruo91/spacewalk                  Spacewalk is an open source Linux systems ...   3                    [OK]
docker.io   docker.io/jamesnetherton/spacewalk         Spacewalk running under Docker                  1                    
docker.io   docker.io/coffmant/spacewalk-docker        Spacewalk                                       0                    [OK]
docker.io   docker.io/csabakollar/spacewalk            Spacewalk 2.4 in a CentOS6 container            0                    
docker.io   docker.io/egonzalez90/spacewalk            Spacewalk docker image                          0                    [OK]
docker.io   docker.io/jdostal/spacewalk-clients        Repository containing spacewalk-clients         0                    
docker.io   docker.io/jhutar/spacewalk-client                                                          0                    
docker.io   docker.io/norus/spacewalk-reposync                                                         0                    
docker.io   docker.io/pajinek/spacewalk-client                                                         0                    [OK]
docker.io   docker.io/perfectweb/spacewalk             spacewalk                                       0                    [OK]
docker.io   docker.io/researchiteng/docker-spacewalk   spacewalk is the open source version of Re...   0                    [OK]
docker.io   docker.io/varhoo/spacewalk-proxy                                                           0                    [OK]
</pre>
<p>To start the container use the following command. If you don’t have the image locally, it will download the image from DockerHub</p>
<pre>
[egonzalez@localhost ~]$ docker run -d --privileged=True egonzalez90/spacewalk
Unable to find image 'egonzalez90/spacewalk:latest' locally
Trying to pull repository docker.io/egonzalez90/spacewalk ... 
latest: Pulling from docker.io/egonzalez90/spacewalk
a3ed95caeb02: Already exists 
da71393503ec: Already exists 
519093688e2c: Pull complete 
97bbffaa9fc9: Pull complete 
63bfb115f62d: Pull complete 
929bbb68aff9: Pull complete 
532bc4af8e1a: Pull complete 
3eb667dda9ee: Pull complete 
275894897aa4: Pull complete 
93bcddf9cedb: Pull complete 
266c3b70754f: Pull complete 
Digest: sha256:a4dd98548f9dbb405fb4c6bb4a2a07b83d5f2bf730f29f71913b72876b1a61ab
Status: Downloaded newer image for docker.io/egonzalez90/spacewalk:latest
ded4a8b7eb1ee61fecc8ddc2eb1b092917a361bc36f7f752b32d76e79501d70a
</pre>
<p>Now you have the container running, check if all the ports are properly exposed</p>
<pre>
[egonzalez@localhost ~]$ docker ps --latest --format 'table \t\t'
CONTAINER ID        IMAGE                   PORTS
ded4a8b7eb1e        egonzalez90/spacewalk   68-69/tcp, 80/tcp, 443/tcp, 5222/tcp
</pre>
<p>Get the container IP address in order to enter from a Web Browser</p>
<pre>
[egonzalez@localhost ~]$ docker inspect ded4a8b7eb1e | egrep IPAddress
            "SecondaryIPAddresses": null,
            "IPAddress": "172.17.0.3",
                    "IPAddress": "172.17.0.3",
</pre>
<p>Open A browser and go to the container IP address, if you use HTTP, by default it will redirect you to HTTPS.
The container uses an auto-signed SSL certificate, you have to add an exception in the Browser you use to allow connections to Spacewalk.
Once in the Welcome page, create an Organization.</p>

<p>Now you are in Spacewalk and can play/test some features.
<img src="http://egonzalez.org/wp-content/uploads/2016/07/Selection_003-1024x483.png" alt="Selection_003" width="900" height="425" class="alignnone size-large wp-image-1287" /></p>

<p>There is an issue I was not able to fix, so osa-dispatcher and some other features will not work with this image.
If someone can give me an input to fix the issue it will appreciated.</p>
<pre>
[egonzalez@localhost ~]$ docker logs ded4a8b7eb1e | egrep FATAL
2016-07-12 18:13:32,220 INFO gave up: osa-dispatcher entered FATAL state, too many start retries too quickly
</pre>

<p>Thanks for your time and hopes this image at least serves you to learn and play with the interface.</p>

<p>Regards, Eduardo Gonzalez</p>

  </div>

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

&copy;  - Powered by <a href="https://jekyllrb.com">Jekyll</a> &amp; <a href="https://github.com/yous/whiteglass">whiteglass</a> - Subscribe via <a href="http://217.182.136.201:8080/feed.xml">RSS</a>

    </p>

  </div>

</footer>


  </body>

</html>
