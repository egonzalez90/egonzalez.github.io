<!DOCTYPE html>
<html lang="en-US">

  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width,maximum-scale=2">
    <meta name="description" content="OpenStack things : OpenStack, Docker, Ansible, Ceph, Linux">

    <link rel="stylesheet" type="text/css" media="screen" href="/assets/css/style.css?v=9a6333a51cf04996f04338046deefb14dd69cda4">

<!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Deploy OpenStack Designate with Kolla | OpenStack things</title>
<meta property="og:title" content="Deploy OpenStack Designate with Kolla">
<meta name="author" content="Editor">
<meta property="og:locale" content="en_US">
<meta name="description" content="During Ocata release, OpenStack DNS-as-a-Service (Designate) support was implemented in OpenStack kolla project. This post will guide you through a basic deployment and tests of designate service. Install required dependencies and tools for kolla-ansible and designate. # yum install -y epel-release # yum install -y python-pip python-devel libffi-devel gcc openssl-devel ansible ntp wget bind-utils # pip install -U pip Install Docker and downgrade to 1.12.6. At the time of writing this post libvirt had issues to connect with D-Bus due SElinux issues with Docker 1.13. # curl -sSL https://get.docker.io | bash # yum downgrade docker-engine-1.12.6 docker-engine-selinux-1.12.6 # yum install -y python-docker-py Configure Docker daemon to allow insecure-registry (Use the IP where your remote registry will be located). # mkdir -p /etc/systemd/system/docker.service.d # tee /etc/systemd/system/docker.service.d/kolla.conf &lt;&lt;-'EOF' [Service] ExecStart= ExecStart=/usr/bin/dockerd --insecure-registry 172.28.128.3:4000 MountFlags=shared EOF Reload systemd daemons and start/stop/disable/enable the following services. # systemctl daemon-reload # systemctl stop libvirtd # systemctl disable libvirtd # systemctl enable ntpd docker # systemctl start ntpd docker Download Ocata registry created in tarballs.openstack.org, skip this step if images used are custom builds or downloaded from DockerHub. Create kolla registry from downloaded tarball. # wget https://tarballs.openstack.org/kolla/images/centos-binary-registry-ocata.tar.gz # mkdir /opt/kolla_registry # sudo tar xzf centos-binary-registry-ocata.tar.gz -C /opt/kolla_registry # docker run -d -p 4000:5000 --restart=always -v /opt/kolla_registry/:/var/lib/registry --name registry registry:2 Install kolla-ansible. # pip install kolla-ansible # cp -r /usr/share/kolla-ansible/etc_examples/kolla /etc/kolla/ # cp /usr/share/kolla-ansible/ansible/inventory/* . Configure kolla globals.yml configuration file with the following content. Change values when necessary (IP addresses, interface names). This is a sample minimal configuration. # vi /etc/kolla/globals.yml --- kolla_internal_vip_address: &quot;172.28.128.10&quot; kolla_base_distro: &quot;centos&quot; kolla_install_type: &quot;binary&quot; docker_registry: &quot;172.28.128.3:4000&quot; docker_namespace: &quot;lokolla&quot; network_interface: &quot;enp0s8&quot; neutron_external_interface: &quot;enp0s9&quot; Configure designate options in globals.yml. dns_interface must be network reachable from nova instances if internal DNS resolution is needed. enable_designate: &quot;yes&quot; dns_interface: &quot;enp0s8&quot; designate_backend: &quot;bind9&quot; designate_ns_record: &quot;sample.openstack.org&quot; Configure inventory, add the nodes in their respective groups. # vi ~/multinode Generate passwords. # kolla-genpwd Ensure the environment is ready to deploy with prechecks. Until prechecks does not succeed do not start deployment. Fix what is necessary. # kolla-ansible prechecks -i ~/multinode Pull Docker images on the servers, this can be skipped because will be made in deploy step, but doing it first will ensure all the nodes have the images you need and will minimize the deployment time. # kolla-ansible pull -i ~/multinode Deploy kolla-ansible and do a woot for kolla ;) # kolla-ansible deploy -i ~/multinode Create credentials file and source it. # kolla-ansible post-deploy -i ~/multinode # source /etc/kolla/admin-openrc.sh Check that all containers are running and none of them are restarting or exiting. # docker ps -a --filter status=exited --filter status=restarting CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES Install required python clients # pip install python-openstackclient python-designateclient python-neutronclient Execute a base OpenStack configuration (public and internal networks, cirros image). Do no execute this script if custom networks are going to be used. # sh /usr/share/kolla-ansible/init-runonce Create a sample designate zone. # openstack zone create --email admin@sample.openstack.org sample.openstack.org. +----------------+--------------------------------------+ | Field | Value | +----------------+--------------------------------------+ | action | CREATE | | attributes | | | created_at | 2017-02-22T13:14:39.000000 | | description | None | | email | admin@sample.openstack.org | | id | 4a44b0c9-bd07-4f5c-8908-523f453f269d | | masters | | | name | sample.openstack.org. | | pool_id | 85d18aec-453e-45ae-9eb3-748841a1da12 | | project_id | 937d49af6cfe4ef080a79f9a833d7c7d | | serial | 1487769279 | | status | PENDING | | transferred_at | None | | ttl | 3600 | | type | PRIMARY | | updated_at | None | | version | 1 | +----------------+--------------------------------------+ Configure designate sink to make use of the previously created zone, sink will need zone_id to automatically create neutron and nova records into designate. # mkdir -p /etc/kolla/config/designate/designate-sink/ # vi /etc/kolla/config/designate/designate-sink.conf [handler:nova_fixed] zone_id = 4a44b0c9-bd07-4f5c-8908-523f453f269d [handler:neutron_floatingip] zone_id = 4a44b0c9-bd07-4f5c-8908-523f453f269d After configure designate-sink.conf, reconfigure designate to make use of this configuration. # kolla-ansible reconfigure -i ~/multinode --tags designate List networks. # neutron net-list +--------------------------------------+----------+----------------------------------+--------------------------------------------------+ | id | name | tenant_id | subnets | +--------------------------------------+----------+----------------------------------+--------------------------------------------------+ | 3b56c605-5a01-45be-9ed6-e4c3285e4366 | demo-net | 937d49af6cfe4ef080a79f9a833d7c7d | 7f28f050-77b2-426e-b963-35b682077993 10.0.0.0/24 | | 6954d495-fb8c-4b0b-98a9-9672a7f65b7c | public1 | 937d49af6cfe4ef080a79f9a833d7c7d | 9bd9feca-40a7-4e82-b912-e51b726ad746 10.0.2.0/24 | +--------------------------------------+----------+----------------------------------+--------------------------------------------------+ Update the network with a dns_domain. # neutron net-update 3b56c605-5a01-45be-9ed6-e4c3285e4366 --dns_domain sample.openstack.org. Updated network: 3b56c605-5a01-45be-9ed6-e4c3285e4366 Ensure dns_domain is properly applied. # neutron net-show 3b56c605-5a01-45be-9ed6-e4c3285e4366 +---------------------------+--------------------------------------+ | Field | Value | +---------------------------+--------------------------------------+ | admin_state_up | True | | availability_zone_hints | | | availability_zones | nova | | created_at | 2017-02-22T13:13:06Z | | description | | | dns_domain | sample.openstack.org. | | id | 3b56c605-5a01-45be-9ed6-e4c3285e4366 | | ipv4_address_scope | | | ipv6_address_scope | | | mtu | 1450 | | name | demo-net | | port_security_enabled | True | | project_id | 937d49af6cfe4ef080a79f9a833d7c7d | | provider:network_type | vxlan | | provider:physical_network | | | provider:segmentation_id | 27 | | revision_number | 6 | | router:external | False | | shared | False | | status | ACTIVE | | subnets | 7f28f050-77b2-426e-b963-35b682077993 | | tags | | | tenant_id | 937d49af6cfe4ef080a79f9a833d7c7d | | updated_at | 2017-02-22T13:25:16Z | +---------------------------+--------------------------------------+ Create a new instance in the previously updated network. # openstack server create \ --image cirros \ --flavor m1.tiny \ --key-name mykey \ --nic net-id=3b56c605-5a01-45be-9ed6-e4c3285e4366 \ demo1 Once the instance is ACTIVE, check the IP associated. # openstack server list +--------------------------------------+-------+--------+-------------------+------------+ | ID | Name | Status | Networks | Image Name | +--------------------------------------+-------+--------+-------------------+------------+ | d483e4ee-58c2-4e1e-9384-85174630428e | demo1 | ACTIVE | demo-net=10.0.0.3 | cirros | +--------------------------------------+-------+--------+-------------------+------------+ List records in the designate zone. As you can see there is a record in designate associated with the instance IP. # openstack recordset list sample.openstack.org. +--------------------------------------+----------------------------------+------+-------------------------------------------+--------+--------+ | id | name | type | records | status | action | +--------------------------------------+----------------------------------+------+-------------------------------------------+--------+--------+ | 4f70531e-c325-4ffd-a8d3-8172bd5163b8 | sample.openstack.org. | SOA | sample.openstack.org. | ACTIVE | NONE | | | | | admin.sample.openstack.org. 1487770304 | | | | | | | 3586 600 86400 3600 | | | | a9a09c5f-ccf1-4b52-8400-f36e8faa9549 | sample.openstack.org. | NS | sample.openstack.org. | ACTIVE | NONE | | aa6cd25d-186e-425b-9153-699d8b0811de | 10-0-0-3.sample.openstack.org. | A | 10.0.0.3 | ACTIVE | NONE | | 713650a5-a45e-470b-9539-74e110b15115 | demo1.None.sample.openstack.org. | A | 10.0.0.3 | ACTIVE | NONE | | 6506e6f6-f535-45eb-9bfb-4ac1f16c5c9b | demo1.sample.openstack.org. | A | 10.0.0.3 | ACTIVE | NONE | +--------------------------------------+----------------------------------+------+-------------------------------------------+--------+--------+ Validate that designate resolves the DNS record. You can use designate mDNS service or directly to bind9 servers to validate the test. # dig +short -p 5354 @172.28.128.3 demo1.sample.openstack.org. A 10.0.0.3 # dig +short -p 53 @172.28.128.3 demo1.sample.openstack.org. A 10.0.0.3 If you find any issue with designate in kolla-ansible or kolla, please fill a bug https://bugs.launchpad.net/kolla-ansible/+filebug Regards, Eduardo Gonzalez">
<meta property="og:description" content="During Ocata release, OpenStack DNS-as-a-Service (Designate) support was implemented in OpenStack kolla project. This post will guide you through a basic deployment and tests of designate service. Install required dependencies and tools for kolla-ansible and designate. # yum install -y epel-release # yum install -y python-pip python-devel libffi-devel gcc openssl-devel ansible ntp wget bind-utils # pip install -U pip Install Docker and downgrade to 1.12.6. At the time of writing this post libvirt had issues to connect with D-Bus due SElinux issues with Docker 1.13. # curl -sSL https://get.docker.io | bash # yum downgrade docker-engine-1.12.6 docker-engine-selinux-1.12.6 # yum install -y python-docker-py Configure Docker daemon to allow insecure-registry (Use the IP where your remote registry will be located). # mkdir -p /etc/systemd/system/docker.service.d # tee /etc/systemd/system/docker.service.d/kolla.conf &lt;&lt;-'EOF' [Service] ExecStart= ExecStart=/usr/bin/dockerd --insecure-registry 172.28.128.3:4000 MountFlags=shared EOF Reload systemd daemons and start/stop/disable/enable the following services. # systemctl daemon-reload # systemctl stop libvirtd # systemctl disable libvirtd # systemctl enable ntpd docker # systemctl start ntpd docker Download Ocata registry created in tarballs.openstack.org, skip this step if images used are custom builds or downloaded from DockerHub. Create kolla registry from downloaded tarball. # wget https://tarballs.openstack.org/kolla/images/centos-binary-registry-ocata.tar.gz # mkdir /opt/kolla_registry # sudo tar xzf centos-binary-registry-ocata.tar.gz -C /opt/kolla_registry # docker run -d -p 4000:5000 --restart=always -v /opt/kolla_registry/:/var/lib/registry --name registry registry:2 Install kolla-ansible. # pip install kolla-ansible # cp -r /usr/share/kolla-ansible/etc_examples/kolla /etc/kolla/ # cp /usr/share/kolla-ansible/ansible/inventory/* . Configure kolla globals.yml configuration file with the following content. Change values when necessary (IP addresses, interface names). This is a sample minimal configuration. # vi /etc/kolla/globals.yml --- kolla_internal_vip_address: &quot;172.28.128.10&quot; kolla_base_distro: &quot;centos&quot; kolla_install_type: &quot;binary&quot; docker_registry: &quot;172.28.128.3:4000&quot; docker_namespace: &quot;lokolla&quot; network_interface: &quot;enp0s8&quot; neutron_external_interface: &quot;enp0s9&quot; Configure designate options in globals.yml. dns_interface must be network reachable from nova instances if internal DNS resolution is needed. enable_designate: &quot;yes&quot; dns_interface: &quot;enp0s8&quot; designate_backend: &quot;bind9&quot; designate_ns_record: &quot;sample.openstack.org&quot; Configure inventory, add the nodes in their respective groups. # vi ~/multinode Generate passwords. # kolla-genpwd Ensure the environment is ready to deploy with prechecks. Until prechecks does not succeed do not start deployment. Fix what is necessary. # kolla-ansible prechecks -i ~/multinode Pull Docker images on the servers, this can be skipped because will be made in deploy step, but doing it first will ensure all the nodes have the images you need and will minimize the deployment time. # kolla-ansible pull -i ~/multinode Deploy kolla-ansible and do a woot for kolla ;) # kolla-ansible deploy -i ~/multinode Create credentials file and source it. # kolla-ansible post-deploy -i ~/multinode # source /etc/kolla/admin-openrc.sh Check that all containers are running and none of them are restarting or exiting. # docker ps -a --filter status=exited --filter status=restarting CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES Install required python clients # pip install python-openstackclient python-designateclient python-neutronclient Execute a base OpenStack configuration (public and internal networks, cirros image). Do no execute this script if custom networks are going to be used. # sh /usr/share/kolla-ansible/init-runonce Create a sample designate zone. # openstack zone create --email admin@sample.openstack.org sample.openstack.org. +----------------+--------------------------------------+ | Field | Value | +----------------+--------------------------------------+ | action | CREATE | | attributes | | | created_at | 2017-02-22T13:14:39.000000 | | description | None | | email | admin@sample.openstack.org | | id | 4a44b0c9-bd07-4f5c-8908-523f453f269d | | masters | | | name | sample.openstack.org. | | pool_id | 85d18aec-453e-45ae-9eb3-748841a1da12 | | project_id | 937d49af6cfe4ef080a79f9a833d7c7d | | serial | 1487769279 | | status | PENDING | | transferred_at | None | | ttl | 3600 | | type | PRIMARY | | updated_at | None | | version | 1 | +----------------+--------------------------------------+ Configure designate sink to make use of the previously created zone, sink will need zone_id to automatically create neutron and nova records into designate. # mkdir -p /etc/kolla/config/designate/designate-sink/ # vi /etc/kolla/config/designate/designate-sink.conf [handler:nova_fixed] zone_id = 4a44b0c9-bd07-4f5c-8908-523f453f269d [handler:neutron_floatingip] zone_id = 4a44b0c9-bd07-4f5c-8908-523f453f269d After configure designate-sink.conf, reconfigure designate to make use of this configuration. # kolla-ansible reconfigure -i ~/multinode --tags designate List networks. # neutron net-list +--------------------------------------+----------+----------------------------------+--------------------------------------------------+ | id | name | tenant_id | subnets | +--------------------------------------+----------+----------------------------------+--------------------------------------------------+ | 3b56c605-5a01-45be-9ed6-e4c3285e4366 | demo-net | 937d49af6cfe4ef080a79f9a833d7c7d | 7f28f050-77b2-426e-b963-35b682077993 10.0.0.0/24 | | 6954d495-fb8c-4b0b-98a9-9672a7f65b7c | public1 | 937d49af6cfe4ef080a79f9a833d7c7d | 9bd9feca-40a7-4e82-b912-e51b726ad746 10.0.2.0/24 | +--------------------------------------+----------+----------------------------------+--------------------------------------------------+ Update the network with a dns_domain. # neutron net-update 3b56c605-5a01-45be-9ed6-e4c3285e4366 --dns_domain sample.openstack.org. Updated network: 3b56c605-5a01-45be-9ed6-e4c3285e4366 Ensure dns_domain is properly applied. # neutron net-show 3b56c605-5a01-45be-9ed6-e4c3285e4366 +---------------------------+--------------------------------------+ | Field | Value | +---------------------------+--------------------------------------+ | admin_state_up | True | | availability_zone_hints | | | availability_zones | nova | | created_at | 2017-02-22T13:13:06Z | | description | | | dns_domain | sample.openstack.org. | | id | 3b56c605-5a01-45be-9ed6-e4c3285e4366 | | ipv4_address_scope | | | ipv6_address_scope | | | mtu | 1450 | | name | demo-net | | port_security_enabled | True | | project_id | 937d49af6cfe4ef080a79f9a833d7c7d | | provider:network_type | vxlan | | provider:physical_network | | | provider:segmentation_id | 27 | | revision_number | 6 | | router:external | False | | shared | False | | status | ACTIVE | | subnets | 7f28f050-77b2-426e-b963-35b682077993 | | tags | | | tenant_id | 937d49af6cfe4ef080a79f9a833d7c7d | | updated_at | 2017-02-22T13:25:16Z | +---------------------------+--------------------------------------+ Create a new instance in the previously updated network. # openstack server create \ --image cirros \ --flavor m1.tiny \ --key-name mykey \ --nic net-id=3b56c605-5a01-45be-9ed6-e4c3285e4366 \ demo1 Once the instance is ACTIVE, check the IP associated. # openstack server list +--------------------------------------+-------+--------+-------------------+------------+ | ID | Name | Status | Networks | Image Name | +--------------------------------------+-------+--------+-------------------+------------+ | d483e4ee-58c2-4e1e-9384-85174630428e | demo1 | ACTIVE | demo-net=10.0.0.3 | cirros | +--------------------------------------+-------+--------+-------------------+------------+ List records in the designate zone. As you can see there is a record in designate associated with the instance IP. # openstack recordset list sample.openstack.org. +--------------------------------------+----------------------------------+------+-------------------------------------------+--------+--------+ | id | name | type | records | status | action | +--------------------------------------+----------------------------------+------+-------------------------------------------+--------+--------+ | 4f70531e-c325-4ffd-a8d3-8172bd5163b8 | sample.openstack.org. | SOA | sample.openstack.org. | ACTIVE | NONE | | | | | admin.sample.openstack.org. 1487770304 | | | | | | | 3586 600 86400 3600 | | | | a9a09c5f-ccf1-4b52-8400-f36e8faa9549 | sample.openstack.org. | NS | sample.openstack.org. | ACTIVE | NONE | | aa6cd25d-186e-425b-9153-699d8b0811de | 10-0-0-3.sample.openstack.org. | A | 10.0.0.3 | ACTIVE | NONE | | 713650a5-a45e-470b-9539-74e110b15115 | demo1.None.sample.openstack.org. | A | 10.0.0.3 | ACTIVE | NONE | | 6506e6f6-f535-45eb-9bfb-4ac1f16c5c9b | demo1.sample.openstack.org. | A | 10.0.0.3 | ACTIVE | NONE | +--------------------------------------+----------------------------------+------+-------------------------------------------+--------+--------+ Validate that designate resolves the DNS record. You can use designate mDNS service or directly to bind9 servers to validate the test. # dig +short -p 5354 @172.28.128.3 demo1.sample.openstack.org. A 10.0.0.3 # dig +short -p 53 @172.28.128.3 demo1.sample.openstack.org. A 10.0.0.3 If you find any issue with designate in kolla-ansible or kolla, please fill a bug https://bugs.launchpad.net/kolla-ansible/+filebug Regards, Eduardo Gonzalez">
<link rel="canonical" href="http://217.182.136.201:5000/deploy-openstack-designate-with-kolla-ansible/">
<meta property="og:url" content="http://217.182.136.201:5000/deploy-openstack-designate-with-kolla-ansible/">
<meta property="og:site_name" content="OpenStack things">
<meta property="og:image" content="http://217.182.136.201:5000/wp-content/uploads/2015/09/learn-about-openstack-badge.png">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2017-02-22T15:39:03+00:00">
<script type="application/ld+json">
{"name":null,"description":"During Ocata release, OpenStack DNS-as-a-Service (Designate) support was implemented in OpenStack kolla project. This post will guide you through a basic deployment and tests of designate service. Install required dependencies and tools for kolla-ansible and designate. # yum install -y epel-release # yum install -y python-pip python-devel libffi-devel gcc openssl-devel ansible ntp wget bind-utils # pip install -U pip Install Docker and downgrade to 1.12.6. At the time of writing this post libvirt had issues to connect with D-Bus due SElinux issues with Docker 1.13. # curl -sSL https://get.docker.io | bash # yum downgrade docker-engine-1.12.6 docker-engine-selinux-1.12.6 # yum install -y python-docker-py Configure Docker daemon to allow insecure-registry (Use the IP where your remote registry will be located). # mkdir -p /etc/systemd/system/docker.service.d # tee /etc/systemd/system/docker.service.d/kolla.conf &lt;&lt;-&#39;EOF&#39; [Service] ExecStart= ExecStart=/usr/bin/dockerd --insecure-registry 172.28.128.3:4000 MountFlags=shared EOF Reload systemd daemons and start/stop/disable/enable the following services. # systemctl daemon-reload # systemctl stop libvirtd # systemctl disable libvirtd # systemctl enable ntpd docker # systemctl start ntpd docker Download Ocata registry created in tarballs.openstack.org, skip this step if images used are custom builds or downloaded from DockerHub. Create kolla registry from downloaded tarball. # wget https://tarballs.openstack.org/kolla/images/centos-binary-registry-ocata.tar.gz # mkdir /opt/kolla_registry # sudo tar xzf centos-binary-registry-ocata.tar.gz -C /opt/kolla_registry # docker run -d -p 4000:5000 --restart=always -v /opt/kolla_registry/:/var/lib/registry --name registry registry:2 Install kolla-ansible. # pip install kolla-ansible # cp -r /usr/share/kolla-ansible/etc_examples/kolla /etc/kolla/ # cp /usr/share/kolla-ansible/ansible/inventory/* . Configure kolla globals.yml configuration file with the following content. Change values when necessary (IP addresses, interface names). This is a sample minimal configuration. # vi /etc/kolla/globals.yml --- kolla_internal_vip_address: &quot;172.28.128.10&quot; kolla_base_distro: &quot;centos&quot; kolla_install_type: &quot;binary&quot; docker_registry: &quot;172.28.128.3:4000&quot; docker_namespace: &quot;lokolla&quot; network_interface: &quot;enp0s8&quot; neutron_external_interface: &quot;enp0s9&quot; Configure designate options in globals.yml. dns_interface must be network reachable from nova instances if internal DNS resolution is needed. enable_designate: &quot;yes&quot; dns_interface: &quot;enp0s8&quot; designate_backend: &quot;bind9&quot; designate_ns_record: &quot;sample.openstack.org&quot; Configure inventory, add the nodes in their respective groups. # vi ~/multinode Generate passwords. # kolla-genpwd Ensure the environment is ready to deploy with prechecks. Until prechecks does not succeed do not start deployment. Fix what is necessary. # kolla-ansible prechecks -i ~/multinode Pull Docker images on the servers, this can be skipped because will be made in deploy step, but doing it first will ensure all the nodes have the images you need and will minimize the deployment time. # kolla-ansible pull -i ~/multinode Deploy kolla-ansible and do a woot for kolla ;) # kolla-ansible deploy -i ~/multinode Create credentials file and source it. # kolla-ansible post-deploy -i ~/multinode # source /etc/kolla/admin-openrc.sh Check that all containers are running and none of them are restarting or exiting. # docker ps -a --filter status=exited --filter status=restarting CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES Install required python clients # pip install python-openstackclient python-designateclient python-neutronclient Execute a base OpenStack configuration (public and internal networks, cirros image). Do no execute this script if custom networks are going to be used. # sh /usr/share/kolla-ansible/init-runonce Create a sample designate zone. # openstack zone create --email admin@sample.openstack.org sample.openstack.org. +----------------+--------------------------------------+ | Field | Value | +----------------+--------------------------------------+ | action | CREATE | | attributes | | | created_at | 2017-02-22T13:14:39.000000 | | description | None | | email | admin@sample.openstack.org | | id | 4a44b0c9-bd07-4f5c-8908-523f453f269d | | masters | | | name | sample.openstack.org. | | pool_id | 85d18aec-453e-45ae-9eb3-748841a1da12 | | project_id | 937d49af6cfe4ef080a79f9a833d7c7d | | serial | 1487769279 | | status | PENDING | | transferred_at | None | | ttl | 3600 | | type | PRIMARY | | updated_at | None | | version | 1 | +----------------+--------------------------------------+ Configure designate sink to make use of the previously created zone, sink will need zone_id to automatically create neutron and nova records into designate. # mkdir -p /etc/kolla/config/designate/designate-sink/ # vi /etc/kolla/config/designate/designate-sink.conf [handler:nova_fixed] zone_id = 4a44b0c9-bd07-4f5c-8908-523f453f269d [handler:neutron_floatingip] zone_id = 4a44b0c9-bd07-4f5c-8908-523f453f269d After configure designate-sink.conf, reconfigure designate to make use of this configuration. # kolla-ansible reconfigure -i ~/multinode --tags designate List networks. # neutron net-list +--------------------------------------+----------+----------------------------------+--------------------------------------------------+ | id | name | tenant_id | subnets | +--------------------------------------+----------+----------------------------------+--------------------------------------------------+ | 3b56c605-5a01-45be-9ed6-e4c3285e4366 | demo-net | 937d49af6cfe4ef080a79f9a833d7c7d | 7f28f050-77b2-426e-b963-35b682077993 10.0.0.0/24 | | 6954d495-fb8c-4b0b-98a9-9672a7f65b7c | public1 | 937d49af6cfe4ef080a79f9a833d7c7d | 9bd9feca-40a7-4e82-b912-e51b726ad746 10.0.2.0/24 | +--------------------------------------+----------+----------------------------------+--------------------------------------------------+ Update the network with a dns_domain. # neutron net-update 3b56c605-5a01-45be-9ed6-e4c3285e4366 --dns_domain sample.openstack.org. Updated network: 3b56c605-5a01-45be-9ed6-e4c3285e4366 Ensure dns_domain is properly applied. # neutron net-show 3b56c605-5a01-45be-9ed6-e4c3285e4366 +---------------------------+--------------------------------------+ | Field | Value | +---------------------------+--------------------------------------+ | admin_state_up | True | | availability_zone_hints | | | availability_zones | nova | | created_at | 2017-02-22T13:13:06Z | | description | | | dns_domain | sample.openstack.org. | | id | 3b56c605-5a01-45be-9ed6-e4c3285e4366 | | ipv4_address_scope | | | ipv6_address_scope | | | mtu | 1450 | | name | demo-net | | port_security_enabled | True | | project_id | 937d49af6cfe4ef080a79f9a833d7c7d | | provider:network_type | vxlan | | provider:physical_network | | | provider:segmentation_id | 27 | | revision_number | 6 | | router:external | False | | shared | False | | status | ACTIVE | | subnets | 7f28f050-77b2-426e-b963-35b682077993 | | tags | | | tenant_id | 937d49af6cfe4ef080a79f9a833d7c7d | | updated_at | 2017-02-22T13:25:16Z | +---------------------------+--------------------------------------+ Create a new instance in the previously updated network. # openstack server create \\ --image cirros \\ --flavor m1.tiny \\ --key-name mykey \\ --nic net-id=3b56c605-5a01-45be-9ed6-e4c3285e4366 \\ demo1 Once the instance is ACTIVE, check the IP associated. # openstack server list +--------------------------------------+-------+--------+-------------------+------------+ | ID | Name | Status | Networks | Image Name | +--------------------------------------+-------+--------+-------------------+------------+ | d483e4ee-58c2-4e1e-9384-85174630428e | demo1 | ACTIVE | demo-net=10.0.0.3 | cirros | +--------------------------------------+-------+--------+-------------------+------------+ List records in the designate zone. As you can see there is a record in designate associated with the instance IP. # openstack recordset list sample.openstack.org. +--------------------------------------+----------------------------------+------+-------------------------------------------+--------+--------+ | id | name | type | records | status | action | +--------------------------------------+----------------------------------+------+-------------------------------------------+--------+--------+ | 4f70531e-c325-4ffd-a8d3-8172bd5163b8 | sample.openstack.org. | SOA | sample.openstack.org. | ACTIVE | NONE | | | | | admin.sample.openstack.org. 1487770304 | | | | | | | 3586 600 86400 3600 | | | | a9a09c5f-ccf1-4b52-8400-f36e8faa9549 | sample.openstack.org. | NS | sample.openstack.org. | ACTIVE | NONE | | aa6cd25d-186e-425b-9153-699d8b0811de | 10-0-0-3.sample.openstack.org. | A | 10.0.0.3 | ACTIVE | NONE | | 713650a5-a45e-470b-9539-74e110b15115 | demo1.None.sample.openstack.org. | A | 10.0.0.3 | ACTIVE | NONE | | 6506e6f6-f535-45eb-9bfb-4ac1f16c5c9b | demo1.sample.openstack.org. | A | 10.0.0.3 | ACTIVE | NONE | +--------------------------------------+----------------------------------+------+-------------------------------------------+--------+--------+ Validate that designate resolves the DNS record. You can use designate mDNS service or directly to bind9 servers to validate the test. # dig +short -p 5354 @172.28.128.3 demo1.sample.openstack.org. A 10.0.0.3 # dig +short -p 53 @172.28.128.3 demo1.sample.openstack.org. A 10.0.0.3 If you find any issue with designate in kolla-ansible or kolla, please fill a bug https://bugs.launchpad.net/kolla-ansible/+filebug Regards, Eduardo Gonzalez","author":{"@type":"Person","name":"Editor"},"@type":"BlogPosting","url":"http://217.182.136.201:5000/deploy-openstack-designate-with-kolla-ansible/","publisher":null,"image":"http://217.182.136.201:5000/wp-content/uploads/2015/09/learn-about-openstack-badge.png","headline":"Deploy OpenStack Designate with Kolla","dateModified":"2017-02-22T15:39:03+00:00","datePublished":"2017-02-22T15:39:03+00:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"http://217.182.136.201:5000/deploy-openstack-designate-with-kolla-ansible/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="http://github.com/egonzalez90/egonzalez90.github.io">View on GitHub</a>

          <h1 id="project_title">OpenStack things</h1>
          <h2 id="project_tagline">OpenStack, Docker, Ansible, Ceph, Linux</h2>

          
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <p>During Ocata release, OpenStack DNS-as-a-Service (Designate) support was implemented in OpenStack kolla project.</p>

<p>This post will guide you through a basic deployment and tests of designate service.</p>

<p>Install required dependencies and tools for kolla-ansible and designate.</p>
<pre>
# yum install -y epel-release
# yum install -y python-pip python-devel libffi-devel gcc openssl-devel ansible ntp wget bind-utils
# pip install -U pip
</pre>
<p>Install Docker and downgrade to 1.12.6. At the time of writing this post libvirt had issues to connect with D-Bus due SElinux issues with Docker 1.13.</p>
<pre>
# curl -sSL https://get.docker.io | bash
# yum downgrade docker-engine-1.12.6 docker-engine-selinux-1.12.6
# yum install -y python-docker-py
</pre>
<p>Configure Docker daemon to allow insecure-registry (Use the IP where your remote registry will be located).</p>
<pre>
# mkdir -p /etc/systemd/system/docker.service.d
# tee /etc/systemd/system/docker.service.d/kolla.conf &lt;&lt;-'EOF'
[Service]
ExecStart=
ExecStart=/usr/bin/dockerd --insecure-registry 172.28.128.3:4000
MountFlags=shared
EOF
</pre>
<p>Reload systemd daemons and start/stop/disable/enable the following services.</p>
<pre>
# systemctl daemon-reload
# systemctl stop libvirtd
# systemctl disable libvirtd
# systemctl enable ntpd docker
# systemctl start ntpd docker
</pre>
<p>Download Ocata registry created in tarballs.openstack.org, skip this step if images used are custom builds or downloaded from DockerHub.
Create kolla registry from downloaded tarball.</p>
<pre>
# wget https://tarballs.openstack.org/kolla/images/centos-binary-registry-ocata.tar.gz
# mkdir /opt/kolla_registry
# sudo tar xzf centos-binary-registry-ocata.tar.gz -C /opt/kolla_registry
# docker run -d -p 4000:5000 --restart=always -v /opt/kolla_registry/:/var/lib/registry --name registry registry:2
</pre>
<p>Install kolla-ansible.</p>
<pre>
# pip install kolla-ansible
# cp -r /usr/share/kolla-ansible/etc_examples/kolla /etc/kolla/
# cp /usr/share/kolla-ansible/ansible/inventory/* .
</pre>
<p>Configure kolla globals.yml configuration file with the following content.
Change values when necessary (IP addresses, interface names).
This is a sample minimal configuration.</p>
<pre>
# vi /etc/kolla/globals.yml
---
kolla_internal_vip_address: "172.28.128.10"
kolla_base_distro: "centos"
kolla_install_type: "binary"
docker_registry: "172.28.128.3:4000"
docker_namespace: "lokolla"
network_interface: "enp0s8"
neutron_external_interface: "enp0s9"
</pre>
<p>Configure designate options in globals.yml.
dns_interface must be network reachable from nova instances if internal DNS resolution is needed.</p>
<pre>
enable_designate: "yes"
dns_interface: "enp0s8"
designate_backend: "bind9"
designate_ns_record: "sample.openstack.org"
</pre>
<p>Configure inventory, add the nodes in their respective groups.</p>
<pre>
# vi ~/multinode
</pre>
<p>Generate passwords.</p>
<pre>
# kolla-genpwd
</pre>
<p>Ensure the environment is ready to deploy with prechecks.
Until prechecks does not succeed do not start deployment.
Fix what is necessary.</p>
<pre>
# kolla-ansible prechecks -i ~/multinode
</pre>
<p>Pull Docker images on the servers, this can be skipped because will be made in deploy step, but doing it first will ensure all the nodes have the images you need and will minimize the deployment time.</p>
<pre>
# kolla-ansible pull -i ~/multinode
</pre>
<p>Deploy kolla-ansible and do a woot for kolla ;)</p>
<pre>
# kolla-ansible deploy -i ~/multinode
</pre>
<p>Create credentials file and source it.</p>
<pre>
# kolla-ansible post-deploy -i ~/multinode
# source /etc/kolla/admin-openrc.sh
</pre>
<p>Check that all containers are running and none of them  are restarting or exiting.</p>
<pre>
# docker ps -a --filter status=exited --filter status=restarting
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
</pre>
<p>Install required python clients</p>
<pre>
# pip install python-openstackclient python-designateclient python-neutronclient
</pre>
<p>Execute a base OpenStack configuration (public and internal networks, cirros image).
Do no execute this script if custom networks are going to be used.</p>
<pre>
# sh /usr/share/kolla-ansible/init-runonce
</pre>
<p>Create a sample designate zone.</p>
<pre>
# openstack zone create --email admin@sample.openstack.org sample.openstack.org.
+----------------+--------------------------------------+
| Field          | Value                                |
+----------------+--------------------------------------+
| action         | CREATE                               |
| attributes     |                                      |
| created_at     | 2017-02-22T13:14:39.000000           |
| description    | None                                 |
| email          | admin@sample.openstack.org           |
| id             | 4a44b0c9-bd07-4f5c-8908-523f453f269d |
| masters        |                                      |
| name           | sample.openstack.org.                |
| pool_id        | 85d18aec-453e-45ae-9eb3-748841a1da12 |
| project_id     | 937d49af6cfe4ef080a79f9a833d7c7d     |
| serial         | 1487769279                           |
| status         | PENDING                              |
| transferred_at | None                                 |
| ttl            | 3600                                 |
| type           | PRIMARY                              |
| updated_at     | None                                 |
| version        | 1                                    |
+----------------+--------------------------------------+
</pre>
<p>Configure designate sink to make use of the previously created zone, sink will need zone_id to automatically create neutron and nova records into designate.</p>
<pre>
# mkdir -p /etc/kolla/config/designate/designate-sink/
# vi /etc/kolla/config/designate/designate-sink.conf
[handler:nova_fixed]
zone_id = 4a44b0c9-bd07-4f5c-8908-523f453f269d
[handler:neutron_floatingip]
zone_id = 4a44b0c9-bd07-4f5c-8908-523f453f269d
</pre>
<p>After configure designate-sink.conf, reconfigure designate to make use of this configuration.</p>
<pre>
# kolla-ansible reconfigure -i ~/multinode --tags designate
</pre>
<p>List networks.</p>
<pre>
# neutron net-list
+--------------------------------------+----------+----------------------------------+--------------------------------------------------+
| id                                   | name     | tenant_id                        | subnets                                          |
+--------------------------------------+----------+----------------------------------+--------------------------------------------------+
| 3b56c605-5a01-45be-9ed6-e4c3285e4366 | demo-net | 937d49af6cfe4ef080a79f9a833d7c7d | 7f28f050-77b2-426e-b963-35b682077993 10.0.0.0/24 |
| 6954d495-fb8c-4b0b-98a9-9672a7f65b7c | public1  | 937d49af6cfe4ef080a79f9a833d7c7d | 9bd9feca-40a7-4e82-b912-e51b726ad746 10.0.2.0/24 |
+--------------------------------------+----------+----------------------------------+--------------------------------------------------+
</pre>
<p>Update the network with a dns_domain.</p>
<pre>
# neutron net-update 3b56c605-5a01-45be-9ed6-e4c3285e4366 --dns_domain sample.openstack.org.
Updated network: 3b56c605-5a01-45be-9ed6-e4c3285e4366
</pre>
<p>Ensure dns_domain is properly applied.</p>
<pre>
# neutron net-show 3b56c605-5a01-45be-9ed6-e4c3285e4366
+---------------------------+--------------------------------------+
| Field                     | Value                                |
+---------------------------+--------------------------------------+
| admin_state_up            | True                                 |
| availability_zone_hints   |                                      |
| availability_zones        | nova                                 |
| created_at                | 2017-02-22T13:13:06Z                 |
| description               |                                      |
| dns_domain                | sample.openstack.org.                |
| id                        | 3b56c605-5a01-45be-9ed6-e4c3285e4366 |
| ipv4_address_scope        |                                      |
| ipv6_address_scope        |                                      |
| mtu                       | 1450                                 |
| name                      | demo-net                             |
| port_security_enabled     | True                                 |
| project_id                | 937d49af6cfe4ef080a79f9a833d7c7d     |
| provider:network_type     | vxlan                                |
| provider:physical_network |                                      |
| provider:segmentation_id  | 27                                   |
| revision_number           | 6                                    |
| router:external           | False                                |
| shared                    | False                                |
| status                    | ACTIVE                               |
| subnets                   | 7f28f050-77b2-426e-b963-35b682077993 |
| tags                      |                                      |
| tenant_id                 | 937d49af6cfe4ef080a79f9a833d7c7d     |
| updated_at                | 2017-02-22T13:25:16Z                 |
+---------------------------+--------------------------------------+
</pre>
<p>Create a new instance in the previously updated network.</p>
<pre>
# openstack server create \
    --image cirros \
    --flavor m1.tiny \
    --key-name mykey \
    --nic net-id=3b56c605-5a01-45be-9ed6-e4c3285e4366 \
    demo1
</pre>
<p>Once the instance is ACTIVE, check the IP associated.</p>
<pre>
# openstack server list
+--------------------------------------+-------+--------+-------------------+------------+
| ID                                   | Name  | Status | Networks          | Image Name |
+--------------------------------------+-------+--------+-------------------+------------+
| d483e4ee-58c2-4e1e-9384-85174630428e | demo1 | ACTIVE | demo-net=10.0.0.3 | cirros     |
+--------------------------------------+-------+--------+-------------------+------------+
</pre>
<p>List records in the designate zone.
As you can see there is a record in designate associated with the instance IP.</p>
<pre>
# openstack recordset list sample.openstack.org.
+--------------------------------------+----------------------------------+------+-------------------------------------------+--------+--------+
| id                                   | name                             | type | records                                   | status | action |
+--------------------------------------+----------------------------------+------+-------------------------------------------+--------+--------+
| 4f70531e-c325-4ffd-a8d3-8172bd5163b8 | sample.openstack.org.            | SOA  | sample.openstack.org.                     | ACTIVE | NONE   |
|                                      |                                  |      | admin.sample.openstack.org. 1487770304    |        |        |
|                                      |                                  |      | 3586 600 86400 3600                       |        |        |
| a9a09c5f-ccf1-4b52-8400-f36e8faa9549 | sample.openstack.org.            | NS   | sample.openstack.org.                     | ACTIVE | NONE   |
| aa6cd25d-186e-425b-9153-699d8b0811de | 10-0-0-3.sample.openstack.org.   | A    | 10.0.0.3                                  | ACTIVE | NONE   |
| 713650a5-a45e-470b-9539-74e110b15115 | demo1.None.sample.openstack.org. | A    | 10.0.0.3                                  | ACTIVE | NONE   |
| 6506e6f6-f535-45eb-9bfb-4ac1f16c5c9b | demo1.sample.openstack.org.      | A    | 10.0.0.3                                  | ACTIVE | NONE   |
+--------------------------------------+----------------------------------+------+-------------------------------------------+--------+--------+
</pre>
<p>Validate that designate resolves the DNS record.
You can use designate mDNS service or directly to bind9 servers to validate the test.</p>
<pre>
# dig +short -p 5354 @172.28.128.3 demo1.sample.openstack.org. A
10.0.0.3
# dig +short -p 53 @172.28.128.3 demo1.sample.openstack.org. A
10.0.0.3
</pre>
<p>If you find any issue with designate in kolla-ansible or kolla, please fill a bug <a href="https://bugs.launchpad.net/kolla-ansible/+filebug">https://bugs.launchpad.net/kolla-ansible/+filebug</a></p>

<p>Regards,
Eduardo Gonzalez</p>


      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        
        <p class="copyright">OpenStack things maintained by <a href="http://github.com/egonzalez90">egonzalez90</a></p>
        
        <p>Published with <a href="https://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    
  </body>

<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = 'https://egonzalez-1.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
</html>
