<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>OpenStack things</title>
  <meta name="description" content="OpenStack, Docker, Ansible, Ceph, Linux">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://217.182.136.201:8080/">
  
  
  <link rel="alternate" type="application/rss+xml" title="OpenStack things" href="http://217.182.136.201:8080/feed.xml">

  

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="egongu90">
  <meta name="twitter:title" content="OpenStack things">
  <meta name="twitter:description" content="OpenStack, Docker, Ansible, Ceph, Linux">
  
    <meta name="twitter:creator" content="egongu90">
  
  

  <script type="text/javascript">
  WebFontConfig = {
    google: { families: [ 'Bitter:400,700,400italic:latin' ] }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">OpenStack things</a>

    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/">About</a>
      
        
        <a class="page-link" href="/archives/">Archives</a>
      
        
        <a class="page-link" href="https://github.com/yous/whiteglass">GitHub</a>
      
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="home">

  

  

  <ul class="post-list">
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2017/08/25/welcome-to-jekyll/">Welcome to Jekyll!</a>
          </h1>

          <p class="post-meta">Aug 25, 2017 • 
  
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/jekyll/">jekyll</a>,
    
  
    
  

  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/update/">update</a>
    
  

</p>
        </header>

        <div class="post-content">
          <p>You’ll find this post in your <code class="highlighter-rouge">_posts</code> directory. Go ahead and edit it and re-build the site to see your changes. You can rebuild the site in many different ways, but the most common way is to run <code class="highlighter-rouge">jekyll serve</code>, which launches a web server and auto-regenerates your site when a file is updated.</p>


        </div>
        
          <p class="post-continue">
            <a href="/2017/08/25/welcome-to-jekyll/">Read on &rarr;</a>
          </p>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/deploy-openstack-designate-with-kolla-ansible/">Deploy OpenStack Designate with Kolla</a>
          </h1>

          <p class="post-meta">Feb 22, 2017 • 
  
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/openstack/">OpenStack</a>
    
  
    
  
    
  

</p>
        </header>

        <div class="post-content">
          <p>During Ocata release, OpenStack DNS-as-a-Service (Designate) support was implemented in OpenStack kolla project
This post will guide you through a basic deployment and tests of designate service.</p>


        </div>
        
          <p class="post-continue">
            <a href="/deploy-openstack-designate-with-kolla-ansible/">Read on &rarr;</a>
          </p>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/openstack-keystone-zero-downtime-upgrade-process-n-to-o/">OpenStack Keystone Zero-Downtime upgrade process (N to O)</a>
          </h1>

          <p class="post-meta">Jan 31, 2017 • 
  
  
    
      <a href="/categories/linux/">Linux</a>,
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/openstack/">OpenStack</a>,
    
  
    
  
    
  

  
  
    
  
    
  
    
      <a href="/categories/various/">Various</a>
    
  
    
  
    
  
    
  
    
  

</p>
        </header>

        <div class="post-content">
          <p>This blog post will show Keystone upgrade procedure from OpenStack Newton to Ocata release with zero-downtime.</p>

<p>In the case of doing this in production, please read release notes, ensure a proper configuration, do database backups and test the upgrade a thousand times.</p>

<p>Keystone upgrade will need to stop one node in order to use it as upgrade server.
In the case of a PoC this is not an issue, but in a production environment, Keystone loads may be intensive and stopping a node for a while may decrease other nodes performance more than expected.
For this reason I prefer orchestrate the upgrade from an external Docker container. With this method all nodes will be fully running almost all the time.</p>
<ul>
 	<li>New container won't start any service, just will sync the database schema with new Keystone version avoiding stop a node to orchestrate the upgrade.</li>
 	<li>The Docker image is provided by OpenStack Kolla project, if already using Kolla this upgrade won't be needed as kolla-ansible already provide an upgrade method.</li>
 	<li>At the moment of writing of this blog, Ocata packages were not released into stable repositories. For this reason I use DLRN repositories.</li>
 	<li>If Ocata is released please do not use DLRN, use stable packages instead.</li>
 	<li>Use stable Ocata Docker image if available with tag 4.0.x and will avoid repository configuration and package upgrades.</li>
 	<li>NOTE: Upgrade may need more steps depending of your own configuration, i.e, if using fernet token more steps are necessary during the upgrade.</li>
        <li>All Keystone nodes are behind HAproxy.</li>
</ul>
<p> </p>
<h3>Prepare the upgrade</h3>
<p>Start Keystone Docker container with host networking (needed to communicate with database nodes directly) and root user (needed to install packages).</p>
<pre>(host)# docker run -ti --net host -u 0 kolla/centos-binary-keystone:3.0.2 bash
</pre>
<p>Download Delorean CentOS trunk repositories</p>
<pre>(keystone-upgrade)# curl -Lo /etc/yum.repos.d/delorean.repo http://buildlogs.centos.org/centos/7/cloud/x86_64/rdo-trunk-master-tested/delorean.repo
(keystone-upgrade)# curl -Lo /etc/yum.repos.d/delorean-deps.repo http://trunk.rdoproject.org/centos7/delorean-deps.repo
</pre>
<p>Disable Newton repository</p>
<pre>(keystone-upgrade)# yum-config-manager --disable centos-openstack-newton
</pre>
<p>Ensure Newton repository is not longer used by the system</p>
<pre>(keystone-upgrade)# yum repolist | grep -i openstack
delorean                        delorean-openstack-glance-0bf9d805886c2  565+255
</pre>
<p>Update all packages in the Docker container to bump keystone version to Ocata.</p>
<pre>(keystone-upgrade)# yum clean all &amp;&amp; yum update -y
</pre>
<p>Configure keystone.conf file, this are my settings. Review you configuration and ensure all is correctly, otherwise may cause issues in the database.
An important option is default_domain_id, this value is for backward compatible with users created under default domain.</p>
<pre>(keystone-upgrade)# egrep ^[^#] /etc/keystone/keystone.conf 
[DEFAULT]
debug = False
log_file = /var/log/keystone/keystone.log
secure_proxy_ssl_header = HTTP_X_FORWARDED_PROTO
[database]
connection = mysql+pymysql://keystone:ickvaHC9opkwbz8z8sy28aLiFNezc7Z6Fm34frcB@192.168.100.10:3306/keystone
max_retries = -1
[cache]
backend = oslo_cache.memcache_pool
enabled = True
memcache_servers = 192.168.100.215:11211,192.168.100.170:11211
[identity]
default_domain_id = default
[token]
provider = uuid
</pre>
<p>Check migrate version in the database.
As you will notice, contract/data_migrate/expand are in the same version</p>
<pre>(mariadb)# mysql -ukeystone -pickvaHC9opkwbz8z8sy28aLiFNezc7Z6Fm34frcB -h192.168.100.10 keystone -e "select * from migrate_version;" 
Warning: Using a password on the command line interface can be insecure.
+-----------------------+--------------------------------------------------------------------------+---------+
| repository_id         | repository_path                                                          | version |
+-----------------------+--------------------------------------------------------------------------+---------+
| keystone              | /usr/lib/python2.7/site-packages/keystone/common/sql/migrate_repo        |     109 |
| keystone_contract     | /usr/lib/python2.7/site-packages/keystone/common/sql/contract_repo       |       4 |
| keystone_data_migrate | /usr/lib/python2.7/site-packages/keystone/common/sql/data_migration_repo |       4 |
| keystone_expand       | /usr/lib/python2.7/site-packages/keystone/common/sql/expand_repo         |       4 |
+-----------------------+--------------------------------------------------------------------------+---------+
</pre>
<p>Before start upgrading the database schema, you will need add SUPER privileges in the database to keystone user or set log_bin_trust_function_creators to True.
In my opinion is safer set the value to True, I don’t want keystone with SUPER privileges.</p>
<pre>(mariadb)# mysql -uroot -pnkLMrBibfMTRqOGBAP3UAxdO4kOFfEaPptGM5UDL -h192.168.100.10 keystone -e "set global log_bin_trust_function_creators=1;"
</pre>
<p>Now use Rally, tempest or some tool to test/benchmarch keystone service during upgrade.
If don’t want to use one of those tools, just use this for command.</p>
<pre>(host)# for i in {1000..6000} ; do openstack user create --password $i $i; done
</pre>
<p> </p>
<h3>Start Upgrade</h3>
<p>Check database status before upgrade using Doctor, this may raise issues in the configuration. Some of them may be ignored(Please, ensure is not an issue before ignoring).
As example, I’m not using fernet tokens and errors appear about missing folder.</p>
<pre>(keystone-upgrade)# keystone-manage doctor
</pre>
<p>Remove obsoleted tokens</p>
<pre>(keystone-upgrade)# keystone-manage token_flush
</pre>
<p>Now, expand the database schema to latest version, in keystone.log can see the status.
Check in the logs if some error is raised before jump to the next step.</p>
<pre>(keystone-upgrade)# keystone-manage db_sync --expand


2017-01-31 13:42:02.772 306 INFO migrate.versioning.api [-] 4 -&gt; 5... 
2017-01-31 13:42:03.004 306 INFO migrate.versioning.api [-] done
2017-01-31 13:42:03.005 306 INFO migrate.versioning.api [-] 5 -&gt; 6... 
2017-01-31 13:42:03.310 306 INFO migrate.versioning.api [-] done
2017-01-31 13:42:03.310 306 INFO migrate.versioning.api [-] 6 -&gt; 7... 
2017-01-31 13:42:03.670 306 INFO migrate.versioning.api [-] done
2017-01-31 13:42:03.671 306 INFO migrate.versioning.api [-] 7 -&gt; 8... 
2017-01-31 13:42:03.984 306 INFO migrate.versioning.api [-] done
2017-01-31 13:42:03.985 306 INFO migrate.versioning.api [-] 8 -&gt; 9... 
2017-01-31 13:42:04.185 306 INFO migrate.versioning.api [-] done
2017-01-31 13:42:04.185 306 INFO migrate.versioning.api [-] 9 -&gt; 10... 
2017-01-31 13:42:07.202 306 INFO migrate.versioning.api [-] done
2017-01-31 13:42:07.202 306 INFO migrate.versioning.api [-] 10 -&gt; 11... 
2017-01-31 13:42:07.481 306 INFO migrate.versioning.api [-] done
2017-01-31 13:42:07.481 306 INFO migrate.versioning.api [-] 11 -&gt; 12... 
2017-01-31 13:42:11.334 306 INFO migrate.versioning.api [-] done
2017-01-31 13:42:11.334 306 INFO migrate.versioning.api [-] 12 -&gt; 13... 
2017-01-31 13:42:11.560 306 INFO migrate.versioning.api [-] done
</pre>
<p>After expand the database, migrate it to latest version.
Ensure there are not errors in Keystone logs.</p>
<pre>(keystone-upgrade)# keystone-manage db_sync --migrate

#keystone.log
2017-01-31 13:42:58.771 314 INFO migrate.versioning.api [-] 4 -&gt; 5... 
2017-01-31 13:42:58.943 314 INFO migrate.versioning.api [-] done
2017-01-31 13:42:58.943 314 INFO migrate.versioning.api [-] 5 -&gt; 6... 
2017-01-31 13:42:59.143 314 INFO migrate.versioning.api [-] done
2017-01-31 13:42:59.143 314 INFO migrate.versioning.api [-] 6 -&gt; 7... 
2017-01-31 13:42:59.340 314 INFO migrate.versioning.api [-] done
2017-01-31 13:42:59.341 314 INFO migrate.versioning.api [-] 7 -&gt; 8... 
2017-01-31 13:42:59.698 314 INFO migrate.versioning.api [-] done
2017-01-31 13:42:59.699 314 INFO migrate.versioning.api [-] 8 -&gt; 9... 
2017-01-31 13:42:59.852 314 INFO migrate.versioning.api [-] done
2017-01-31 13:42:59.852 314 INFO migrate.versioning.api [-] 9 -&gt; 10... 
2017-01-31 13:43:00.135 314 INFO migrate.versioning.api [-] done
2017-01-31 13:43:00.135 314 INFO migrate.versioning.api [-] 10 -&gt; 11... 
2017-01-31 13:43:00.545 314 INFO migrate.versioning.api [-] done
2017-01-31 13:43:00.545 314 INFO migrate.versioning.api [-] 11 -&gt; 12... 
2017-01-31 13:43:00.703 314 INFO migrate.versioning.api [-] done
2017-01-31 13:43:00.703 314 INFO migrate.versioning.api [-] 12 -&gt; 13... 
2017-01-31 13:43:00.854 314 INFO migrate.versioning.api [-] done
</pre>
<p>Now, see migrate_version table, you will notice that expand and data_migrate are in the latest version, but contract still in the previous version.</p>
<pre>(mariadb)# mysql -ukeystone -pickvaHC9opkwbz8z8sy28aLiFNezc7Z6Fm34frcB -h192.168.100.10 keystone -e "select * from migrate_version;"
+-----------------------+--------------------------------------------------------------------------+---------+
| repository_id         | repository_path                                                          | version |
+-----------------------+--------------------------------------------------------------------------+---------+
| keystone              | /usr/lib/python2.7/site-packages/keystone/common/sql/migrate_repo        |     109 |
| keystone_contract     | /usr/lib/python2.7/site-packages/keystone/common/sql/contract_repo       |       4 |
| keystone_data_migrate | /usr/lib/python2.7/site-packages/keystone/common/sql/data_migration_repo |      13 |
| keystone_expand       | /usr/lib/python2.7/site-packages/keystone/common/sql/expand_repo         |      13 |
+-----------------------+--------------------------------------------------------------------------+---------+
</pre>
<p> </p>
<h3>Every Keystone node, one by one</h3>
<p>Go to keystone nodes.
Stop Keystone services, in my case using wsgi inside Apache</p>
<pre>(keystone_nodes)# systemctl stop httpd
</pre>
<p>Configure Ocata repositories as made in the Docker container.
Update packages, if you have Keystone sharing the node with other OpenStack service, do not update all packages as it will break other services.
Update only required packages.</p>
<pre>(keystone_nodes)# yum clean all &amp;&amp; yum update -y
</pre>
<p>Configure Keystone configuration file to the desired state. Your configuration may change.</p>
<pre>(keystone_nodes)# egrep ^[^#] /etc/keystone/keystone.conf 
[DEFAULT]
debug = False
log_file = /var/log/keystone/keystone.log
secure_proxy_ssl_header = HTTP_X_FORWARDED_PROTO
[database]
connection = mysql+pymysql://keystone:ickvaHC9opkwbz8z8sy28aLiFNezc7Z6Fm34frcB@192.168.100.10:3306/keystone
max_retries = -1
[cache]
backend = oslo_cache.memcache_pool
enabled = True
memcache_servers = 192.168.100.215:11211,192.168.100.170:11211
[identity]
default_domain_id = default
[token]
provider = uuid
</pre>
<p>Start Keystone service.</p>
<pre>(keystone_nodes)# systemctl start httpd
</pre>
<p> </p>
<h3>Finish Upgrade</h3>
<p>After all the nodes are updated to latest version (please ensure all nodes are using latest packages, if not will fail).
Contract Keystone database schema.
Look at keystone.log for errors.</p>
<pre>(keystone-upgrade)# keystone-manage db_sync --contract

keystone.log

2017-01-31 13:57:52.164 322 INFO migrate.versioning.api [-] 4 -&gt; 5... 
2017-01-31 13:57:52.379 322 INFO migrate.versioning.api [-] done
2017-01-31 13:57:52.379 322 INFO migrate.versioning.api [-] 5 -&gt; 6... 
2017-01-31 13:57:52.969 322 INFO migrate.versioning.api [-] done
2017-01-31 13:57:52.969 322 INFO migrate.versioning.api [-] 6 -&gt; 7... 
2017-01-31 13:57:53.462 322 INFO migrate.versioning.api [-] done
2017-01-31 13:57:53.462 322 INFO migrate.versioning.api [-] 7 -&gt; 8... 
2017-01-31 13:57:53.793 322 INFO migrate.versioning.api [-] done
2017-01-31 13:57:53.793 322 INFO migrate.versioning.api [-] 8 -&gt; 9... 
2017-01-31 13:57:53.957 322 INFO migrate.versioning.api [-] done
2017-01-31 13:57:53.957 322 INFO migrate.versioning.api [-] 9 -&gt; 10... 
2017-01-31 13:57:54.111 322 INFO migrate.versioning.api [-] done
2017-01-31 13:57:54.112 322 INFO migrate.versioning.api [-] 10 -&gt; 11... 
2017-01-31 13:57:54.853 322 INFO migrate.versioning.api [-] done
2017-01-31 13:57:54.853 322 INFO migrate.versioning.api [-] 11 -&gt; 12... 
2017-01-31 13:57:56.727 322 INFO migrate.versioning.api [-] done
2017-01-31 13:57:56.728 322 INFO migrate.versioning.api [-] 12 -&gt; 13... 
2017-01-31 13:57:59.529 322 INFO migrate.versioning.api [-] done
</pre>
<p>Now if we look at migrate_version table, will see that contract version is latest and match with the other version (Ensure all are in the same version).
This means the database upgrade has been successfully implemented.</p>
<pre>(mariadb)# mysql -ukeystone -pickvaHC9opkwbz8z8sy28aLiFNezc7Z6Fm34frcB -h192.168.100.10 keystone -e "select * from migrate_version;"
+-----------------------+--------------------------------------------------------------------------+---------+
| repository_id         | repository_path                                                          | version |
+-----------------------+--------------------------------------------------------------------------+---------+
| keystone              | /usr/lib/python2.7/site-packages/keystone/common/sql/migrate_repo        |     109 |
| keystone_contract     | /usr/lib/python2.7/site-packages/keystone/common/sql/contract_repo       |      13 |
| keystone_data_migrate | /usr/lib/python2.7/site-packages/keystone/common/sql/data_migration_repo |      13 |
| keystone_expand       | /usr/lib/python2.7/site-packages/keystone/common/sql/expand_repo         |      13 |
+-----------------------+--------------------------------------------------------------------------+---------+
</pre>
<p>Remove log_bin_trust_function_creators value.</p>
<pre>(mariadb)# mysql -uroot -pnkLMrBibfMTRqOGBAP3UAxdO4kOFfEaPptGM5UDL -h192.168.100.10 keystone -e "set global log_bin_trust_function_creators=0;"
</pre>
<p>After finish the upgrade, Rally tests should not have any error. **If using HAproxy for load balance Keystone service, some errors may happen due a connection drop while stopping Keystone service and re-balance to other Keystone node. This can be avoided putting the node to update in Maintenance Mode in HAproxy backend.</p>

<p>Have to thank Keystone team in #openstack-keystone IRC channel for the help provided with a couple of issues.</p>

<p>Regards, Eduardo Gonzalez</p>

        </div>
        
          <p class="post-continue">
            <a href="/openstack-keystone-zero-downtime-upgrade-process-n-to-o/">Read on &rarr;</a>
          </p>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/to-conditional-or-to-skip-that-is-the-ansible-question/">To Conditional or To Skip, that is the Ansible question</a>
          </h1>

          <p class="post-meta">Oct 31, 2016 • 
  
  
    
  
    
  
    
      <a href="/categories/various/">Various</a>
    
  
    
  
    
  
    
  
    
  

</p>
        </header>

        <div class="post-content">
          <p>Have you ever think about if an Ansible task should be skipped with a conditional or without (hidden skip)?.
Well, this post will analyse both methods.</p>

<p>Let’s use a example to create the same result and analyse the both methods:</p>

<p>In OpenStack Kolla we found that sometimes operators need to customise policy.json files. That’s fine, but the problem is that policy.json files are installed with the services by default and we don’t need/want to maintain policy.json files in our repository because for sure will cause bugs from outdated policy files in the future.</p>

<p>What’s the proposed solution to this? Allow operators use their own policy files only when their files exists in a custom configuration folder. If custom files are not present, default policy.json files are already present as part of the software installation. ( Actually this change is under review )</p>
<h2>To Conditional method</h2>
<p>Code snippet:</p>
<pre>  - name: Check if file exists
    stat:
      path: "/tmp/custom_file.json"
    register: check_custom_file_exist

  - name: Copy custom policy when exist
    template:
      src: "/tmp/custom_file.json"
      dest: "/tmp/destination_file.json"
    when: ""
</pre>
<p>The first task checks if the file is present and register the stat result.
The second task, copy the file only when the registered result of the previous task is True. (exists == True)</p>

<p>Outputs the following when the file is not present:</p>
<pre>PLAY [localhost] ***************************************************************

TASK [Check if file exists] ****************************************************
ok: [localhost]

TASK [Copy custom policy when exist] *******************************************
skipping: [localhost]

PLAY RECAP *********************************************************************
localhost                  : ok=1    changed=0    unreachable=0    failed=0  
</pre>
<p>We can see the copy file task is skipped with a skipping message.</p>
<h2>To Skip method</h2>
<p>Code snippet:</p>
<pre>  - name: Copy custom policy when exist
    template:
      src: ""
      dest: "/tmp/destination_file.json"
    with_first_found:
    - files:
      - custom_file.json
      skip: True
</pre>
<p>This playbook contains a single task, this task will use the first found file in a list of files. If no file is present will skip the task.</p>

<p>Output from this execution:</p>
<pre>PLAY [localhost] ***************************************************************

TASK [Copy custom policy when exist] *******************************************

PLAY RECAP *********************************************************************
localhost                  : ok=0    changed=0    unreachable=0    failed=0 
</pre>
<p>We can see that no task is executed when custom files are not present, no output from the task (hidden skip).</p>
<h2>Analysis and own opinion</h2>
<p>Both methods do the same, both copy custom files when are present and both skip copy task when are not present.
What are the differences between both methods?</p>

<p>To_skip method is simpler to read and unified in a single task, to_conditional is created within two tasks.
To_conditional method takes longer to be executed as it has to check the existence of a file and then evaluate a conditional.</p>

<p>You may think that to_skip method is better than to_conditional method, that’s right in terms of code syntax and execution times. But…
As both, operator and infrastructure developer, I always use to_conditional method because when I’m deploying something new, I want to know what is executed and what not. In to_skip method you don’t know because there is no output provided from the task(not really true) but in to_conditional method it clearly says Skipping.</p>

<p>Execution times are not a problem in most use cases, as is not commonly used this kind of tasks in CM systems, only a few tasks will need this type of logic.</p>

<p>Regards, Eduardo Gonzalez</p>

        </div>
        
          <p class="post-continue">
            <a href="/to-conditional-or-to-skip-that-is-the-ansible-question/">Read on &rarr;</a>
          </p>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/spacewalk-red-hat-satellite-v5-in-a-docker-container-poc/">Spacewalk (Red Hat Satellite v5) in a Docker container PoC</a>
          </h1>

          <p class="post-meta">Jul 12, 2016 • 
  
  
    
      <a href="/categories/linux/">Linux</a>,
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
  
    
  
    
  
    
      <a href="/categories/various/">Various</a>
    
  
    
  
    
  
    
  
    
  

</p>
        </header>

        <div class="post-content">
          <p>Spacewalk was the upstream project to provide a Linux systems management layer on which Red Hat Satellite was based, was based at least until RH Satellite version 5. Newer versions are not anymore based on Spacewalk, instead Satellite is a federation of several upstream open source projects, including Katello, Foreman, Pulp, and Candlepin.</p>

<p>Some weeks ago, a friend asked me if I knew a Docker container image for Satellite.
I have not found any image. What I found was some Spacewalk images, but sadly none of them worked for me.
I decided to create an image for this purpose.</p>

<p>While developing the image, I found serious troubles to make it run with systemd (I’m a fan of systemd, but not inside containers yet).
The result was a semi functional working image. I said semi functional because some Spacewalk features are not working (probably an issue with systemd again).
The main problem was that spacewalk-setup script starts and uses systemd to configure the database and the other needed services, that’s OK in a VM but not in a container.
So i needed to hack into postgres setup and start the services with the typical <code>command --config-file file.conf</code> executed from supervisord as Docker entrypoint.
Currently there is an issue with <code>osa-dispatcher</code>, on which I can’t find a fix to make it run.</p>

<p>This image is primarily created just for test Spacewalk interface and be more comfortable with it aka testing/development purposes, or just to have fun hacking with Docker containers.</p>

<p>Now, I’m going to make a short description of what the Dockerfile makes and then start the container.
Have fun.</p>

<p>I used centos as image base for this PoC</p>
<pre>
FROM centos:7 
</pre>
<p>Typical Maintainer line</p>
<pre>
MAINTAINER Eduardo Gonzalez Gutierrez &lt;dabarren@gmail.com&gt;
</pre>
<p>Add jpackage repo which provides Java packages for Linux</p>
<pre>
COPY jpackage-generic.repo /etc/yum.repos.d/jpackage-generic.repo
</pre>
<p>Install EPEL and Spacewalk repositories, after install, clean all stored cache to minimize image size</p>
<pre>
RUN yum install -y http://yum.spacewalkproject.org/2.5/RHEL/7/x86_64/spacewalk-repo-2.5-3.el7.noarch.rpm \
        epel-release &amp;&amp; \
        yum clean all
</pre>
<p>Import Keys to allow installation from these repositories</p>
<pre>
RUN rpm --import http://www.jpackage.org/jpackage.asc &amp;&amp; \
    rpm --import https://dl.fedoraproject.org/pub/epel/RPM-GPG-KEY-EPEL-7 &amp;&amp; \
    rpm --import http://yum.spacewalkproject.org/RPM-GPG-KEY-spacewalk-2015 &amp;&amp; \
    yum clean all
</pre>
<p>Install spacewalk and supervisord packages</p>
<pre>
RUN yum -y install \
        spacewalk-setup-postgresql \
        spacewalk-postgresql \
        supervisor  \
        yum clean all
</pre>
<p>Copy the example file used to sync spacewalk database in a later step</p>
<pre>
COPY answerfile.txt /tmp/answerfile.txt
</pre>
<p>Open necessary ports</p>
<pre>
EXPOSE 80 443 5222 68 69
</pre>
<p>Change to postgres user</p>
<pre>
USER postgres
</pre>
<p>Initialize the database</p>
<pre>
RUN /usr/bin/pg_ctl initdb  -D /var/lib/pgsql/data/
</pre>
<p>Create spacewalk database, user, role and create pltclu language</p>
<pre>
RUN /usr/bin/pg_ctl start -D /var/lib/pgsql/data/  -w -t 300 &amp;&amp; \
     psql -c 'CREATE DATABASE spaceschema' &amp;&amp; \
     psql -c "CREATE USER spaceuser WITH PASSWORD 'spacepw'" &amp;&amp; \
     psql -c 'ALTER ROLE spaceuser SUPERUSER' &amp;&amp; \
     createlang pltclu spaceschema
</pre>
<p>Change to root user</p>
<pre>
USER root
</pre>
<p>Start the database and execute spacewalk configuration script</p>
<pre>
RUN su -c "/usr/bin/pg_ctl start -D /var/lib/pgsql/data/  -w -t 300" postgres &amp;&amp; \
    su -c "spacewalk-setup --answer-file=/tmp/answerfile.txt --skip-db-diskspace-check --skip-db-install" root ; exit 0
</pre>
<p>Copy supervisord configuration</p>
<pre>
ADD supervisord.conf /etc/supervisord.d/supervisord.conf
</pre>
<p>Use supervisord command to start all services at container launch time</p>
<pre>
ENTRYPOINT supervisord -c /etc/supervisord.d/supervisord.conf
</pre>
<p>You can check or download the source code at GitHub <a href="https://github.com/egonzalez90/docker-spacewalk" target="_blank">https://github.com/egonzalez90/docker-spacewalk</a></p>

<p>I uploaded the image to DockerHub, which is auto-build from my GitHub repository, you can find it with the following command.</p>
<pre>
[egonzalez@localhost ~]$ docker search spacewalk
INDEX       NAME                                       DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED
docker.io   docker.io/ruo91/spacewalk                  Spacewalk is an open source Linux systems ...   3                    [OK]
docker.io   docker.io/jamesnetherton/spacewalk         Spacewalk running under Docker                  1                    
docker.io   docker.io/coffmant/spacewalk-docker        Spacewalk                                       0                    [OK]
docker.io   docker.io/csabakollar/spacewalk            Spacewalk 2.4 in a CentOS6 container            0                    
docker.io   docker.io/egonzalez90/spacewalk            Spacewalk docker image                          0                    [OK]
docker.io   docker.io/jdostal/spacewalk-clients        Repository containing spacewalk-clients         0                    
docker.io   docker.io/jhutar/spacewalk-client                                                          0                    
docker.io   docker.io/norus/spacewalk-reposync                                                         0                    
docker.io   docker.io/pajinek/spacewalk-client                                                         0                    [OK]
docker.io   docker.io/perfectweb/spacewalk             spacewalk                                       0                    [OK]
docker.io   docker.io/researchiteng/docker-spacewalk   spacewalk is the open source version of Re...   0                    [OK]
docker.io   docker.io/varhoo/spacewalk-proxy                                                           0                    [OK]
</pre>
<p>To start the container use the following command. If you don’t have the image locally, it will download the image from DockerHub</p>
<pre>
[egonzalez@localhost ~]$ docker run -d --privileged=True egonzalez90/spacewalk
Unable to find image 'egonzalez90/spacewalk:latest' locally
Trying to pull repository docker.io/egonzalez90/spacewalk ... 
latest: Pulling from docker.io/egonzalez90/spacewalk
a3ed95caeb02: Already exists 
da71393503ec: Already exists 
519093688e2c: Pull complete 
97bbffaa9fc9: Pull complete 
63bfb115f62d: Pull complete 
929bbb68aff9: Pull complete 
532bc4af8e1a: Pull complete 
3eb667dda9ee: Pull complete 
275894897aa4: Pull complete 
93bcddf9cedb: Pull complete 
266c3b70754f: Pull complete 
Digest: sha256:a4dd98548f9dbb405fb4c6bb4a2a07b83d5f2bf730f29f71913b72876b1a61ab
Status: Downloaded newer image for docker.io/egonzalez90/spacewalk:latest
ded4a8b7eb1ee61fecc8ddc2eb1b092917a361bc36f7f752b32d76e79501d70a
</pre>
<p>Now you have the container running, check if all the ports are properly exposed</p>
<pre>
[egonzalez@localhost ~]$ docker ps --latest --format 'table \t\t'
CONTAINER ID        IMAGE                   PORTS
ded4a8b7eb1e        egonzalez90/spacewalk   68-69/tcp, 80/tcp, 443/tcp, 5222/tcp
</pre>
<p>Get the container IP address in order to enter from a Web Browser</p>
<pre>
[egonzalez@localhost ~]$ docker inspect ded4a8b7eb1e | egrep IPAddress
            "SecondaryIPAddresses": null,
            "IPAddress": "172.17.0.3",
                    "IPAddress": "172.17.0.3",
</pre>
<p>Open A browser and go to the container IP address, if you use HTTP, by default it will redirect you to HTTPS.
The container uses an auto-signed SSL certificate, you have to add an exception in the Browser you use to allow connections to Spacewalk.
Once in the Welcome page, create an Organization.</p>

<p>Now you are in Spacewalk and can play/test some features.
<img src="http://egonzalez.org/wp-content/uploads/2016/07/Selection_003-1024x483.png" alt="Selection_003" width="900" height="425" class="alignnone size-large wp-image-1287" /></p>

<p>There is an issue I was not able to fix, so osa-dispatcher and some other features will not work with this image.
If someone can give me an input to fix the issue it will appreciated.</p>
<pre>
[egonzalez@localhost ~]$ docker logs ded4a8b7eb1e | egrep FATAL
2016-07-12 18:13:32,220 INFO gave up: osa-dispatcher entered FATAL state, too many start retries too quickly
</pre>

<p>Thanks for your time and hopes this image at least serves you to learn and play with the interface.</p>

<p>Regards, Eduardo Gonzalez</p>

        </div>
        
          <p class="post-continue">
            <a href="/spacewalk-red-hat-satellite-v5-in-a-docker-container-poc/">Read on &rarr;</a>
          </p>
        
      </li>
    
  </ul>

  
  <div class="pagination">
    
      <a class="previous" href="/posts/2/">&laquo; Older</a>
    

    
  </div>



</div>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

&copy;  - Powered by <a href="https://jekyllrb.com">Jekyll</a> &amp; <a href="https://github.com/yous/whiteglass">whiteglass</a> - Subscribe via <a href="http://217.182.136.201:8080/feed.xml">RSS</a>

    </p>

  </div>

</footer>


  </body>

</html>
