<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>OpenStack segregation with Availability Zones and Host Aggregates</title>
  <meta name="description" content="When a new OpenStack cloud born, usually all servers run over the same hardware and specifications, often, all servers are in the same building, room, rack, even a chassis when the cloud is in the first growth paces. After a while, workloads increase and the current hardware is not enough to process that workloads. At this point, your hardware is old and new hardware is bought. This hardware has different storage disks, CPU, RAM and so on. You passed from 10’s of servers to 100’s. DataCenter racks, rooms and buildings are too small and the growing cloud needs redundancy between cities or countries. OpenStack offers a few solutions for that purpose, called Regions, Cells, Availability Zones and Host Aggregates. Now, we are going to focus on Availability Zones and Host Aggregates, which are the way to segregate computational workloads. Host Aggregates: Host Aggregates represent a logical set of properties/characteristics a group of hosts owns in the form of metadata. Imagine some of your servers have SSD disks and the other ones SATA, you can map those properties SSD/SATA to a group of hosts, when a image or flavor with the metaparameter associated is launched, Nova Scheduler will filter the available hosts with the meta parameter value and boot the instance on hosts with the desired property. Host Aggregates are managed by OpenStack admins. Availability Zones Availability Zones represent a logical partition of the infrastructure(not necessary but is the common use case) in the form of racks, rooms, buildings, etc. Customers can launch instances in the desired Availability Zone. Usually, Host Aggregates are mapped to Availability Zones allowing customers to use the desired set of hardware or characteristics to boot instances. At the end of this guide you will know how to: Create Availability Zones and Host Aggregates. Adding hosts to Host Aggregates and Availability Zones. Launch instances directly to Availability Zones. Configure nova scheduler for Host Aggregates usage. Configure Images and Flavors for scheduling to Host Aggregates. Launch instances based on flavors and image parameters. Let’s start: \00/ Create two Host Aggregate called &quot;az1-ag&quot;/&quot;az2-ag&quot;, this command also, will create two Availability Zones called &quot;az1&quot;/&quot;az2&quot;. By default, when a Host Aggregate is created with an Availability Zone, a metadata key called &quot;availability_zone=NAME_OF_AZ” will be created. # nova aggregate-create az1-ag az1 +----+--------+-------------------+-------+-------------------------+ | Id | Name | Availability Zone | Hosts | Metadata | +----+--------+-------------------+-------+-------------------------+ | 2 | az1-ag | az1 | | &#39;availability_zone=az1&#39; | +----+--------+-------------------+-------+-------------------------+ # nova aggregate-create az2-ag az2 +----+--------+-------------------+-------+-------------------------+ | Id | Name | Availability Zone | Hosts | Metadata | +----+--------+-------------------+-------+-------------------------+ | 3 | az2-ag | az2 | | &#39;availability_zone=az2&#39; | +----+--------+-------------------+-------+-------------------------+ Add one or more compute nodes to Host Aggregates. # nova aggregate-add-host 2 compute1az Host compute1az has been successfully added for aggregate 2 +----+--------+-------------------+--------------+-------------------------+ | Id | Name | Availability Zone | Hosts | Metadata | +----+--------+-------------------+--------------+-------------------------+ | 2 | az1-ag | az1 | &#39;compute1az&#39; | &#39;availability_zone=az1&#39; | +----+--------+-------------------+--------------+-------------------------+ # nova aggregate-add-host 3 compute2az Host compute2az has been successfully added for aggregate 3 +----+--------+-------------------+--------------+-------------------------+ | Id | Name | Availability Zone | Hosts | Metadata | +----+--------+-------------------+--------------+-------------------------+ | 3 | az2-ag | az2 | &#39;compute2az&#39; | &#39;availability_zone=az2&#39; | +----+--------+-------------------+--------------+-------------------------+ Details about a Host Aggregate can be reviewed with: # nova aggregate-details az1-ag +----+--------+-------------------+--------------+-------------------------+ | Id | Name | Availability Zone | Hosts | Metadata | +----+--------+-------------------+--------------+-------------------------+ | 2 | az1-ag | az1 | &#39;compute1az&#39; | &#39;availability_zone=az1&#39; | +----+--------+-------------------+--------------+-------------------------+ # nova aggregate-details az2-ag +----+--------+-------------------+--------------+-------------------------+ | Id | Name | Availability Zone | Hosts | Metadata | +----+--------+-------------------+--------------+-------------------------+ | 3 | az2-ag | az2 | &#39;compute2az&#39; | &#39;availability_zone=az2&#39; | +----+--------+-------------------+--------------+-------------------------+ List Availability Zones and check status. # nova availability-zone-list +-----------------------+----------------------------------------+ | Name | Status | +-----------------------+----------------------------------------+ | internal | available | | |- controlleraz | | | | |- nova-conductor | enabled :-) 2016-01-14T19:08:16.000000 | | | |- nova-consoleauth | enabled :-) 2016-01-14T19:08:16.000000 | | | |- nova-scheduler | enabled :-) 2016-01-14T19:08:16.000000 | | | |- nova-cert | enabled :-) 2016-01-14T19:08:13.000000 | | az2 | available | | |- compute2az | | | | |- nova-compute | enabled :-) 2016-01-14T19:08:12.000000 | | az1 | available | | |- compute1az | | | | |- nova-compute | enabled :-) 2016-01-14T19:08:12.000000 | +-----------------------+----------------------------------------+ Other method you can use: # nova service-list +----+------------------+--------------+----------+---------+-------+----------------------------+-----------------+ | Id | Binary | Host | Zone | Status | State | Updated_at | Disabled Reason | +----+------------------+--------------+----------+---------+-------+----------------------------+-----------------+ | 1 | nova-consoleauth | controlleraz | internal | enabled | up | 2016-01-14T19:54:36.000000 | - | | 2 | nova-scheduler | controlleraz | internal | enabled | up | 2016-01-14T19:54:36.000000 | - | | 3 | nova-conductor | controlleraz | internal | enabled | up | 2016-01-14T19:54:35.000000 | - | | 4 | nova-cert | controlleraz | internal | enabled | up | 2016-01-14T19:54:33.000000 | - | | 5 | nova-compute | compute2az | az2 | enabled | up | 2016-01-14T19:54:32.000000 | - | | 6 | nova-compute | compute1az | az1 | enabled | up | 2016-01-14T19:54:32.000000 | - | +----+------------------+--------------+----------+---------+-------+----------------------------+-----------------+ Launch two instances using &quot;--availability-zone AZ” option, you can even select the compute node to use, just use &quot;--availability-zone AZ:COMPUTE_NODE”. # nova boot --flavor m1.tiny --image cirros --nic net-id=6d62149e-74d3-4e52-9813-53ad207309f4 --availability-zone az1 instanceaz1 # nova boot --flavor m1.tiny --image cirros --nic net-id=6d62149e-74d3-4e52-9813-53ad207309f4 --availability-zone az2 instanceaz2 Ensure the instances are running in the desired Availability Zone. # nova show instanceaz1 | grep OS-EXT-AZ | awk &#39;{print$2&quot;:&quot;$4}&#39; OS-EXT-AZ:availability_zone:az1 # nova show instanceaz2 | grep OS-EXT-AZ | awk &#39;{print$2&quot;:&quot;$4}&#39; OS-EXT-AZ:availability_zone:az2 List Glance images. # glance image-list +--------------------------------------+----------+ | ID | Name | +--------------------------------------+----------+ | a6d7a606-f725-480a-9b1b-7b3ae39b93d4 | cirros | | a6540d72-dff7-4fb1-bc64-a8ea69e65178 | imageaz1 | | 9c7e2d55-0b96-43e2-9231-88e426edb350 | imageaz2 | +--------------------------------------+----------+ Update the images with custom properties, i use &quot;availability_zone&quot; because is the default meta parameter a Host Aggregate owns when is inside Availability Zones. # glance image-update --property availability_zone=az1 a6540d72-dff7-4fb1-bc64-a8ea69e65178 +-------------------+--------------------------------------+ | Property | Value | +-------------------+--------------------------------------+ | availability_zone | az1 | | checksum | 133eae9fb1c98f45894a4e60d8736619 | | container_format | bare | | created_at | 2016-01-14T19:59:04Z | | disk_format | qcow2 | | id | a6540d72-dff7-4fb1-bc64-a8ea69e65178 | | min_disk | 0 | | min_ram | 0 | | name | imageaz1 | | owner | 0571c6769c3f46acb195eeb01b87ae38 | | protected | False | | size | 13200896 | | status | active | | tags | [] | | updated_at | 2016-01-14T20:13:05Z | | virtual_size | None | | visibility | private | +-------------------+--------------------------------------+ # glance image-update --property availability_zone=az2 9c7e2d55-0b96-43e2-9231-88e426edb350 +-------------------+--------------------------------------+ | Property | Value | +-------------------+--------------------------------------+ | availability_zone | az2 | | checksum | 133eae9fb1c98f45894a4e60d8736619 | | container_format | bare | | created_at | 2016-01-14T19:59:10Z | | disk_format | qcow2 | | id | 9c7e2d55-0b96-43e2-9231-88e426edb350 | | min_disk | 0 | | min_ram | 0 | | name | imageaz2 | | owner | 0571c6769c3f46acb195eeb01b87ae38 | | protected | False | | size | 13200896 | | status | active | | tags | [] | | updated_at | 2016-01-14T20:13:27Z | | virtual_size | None | | visibility | private | +-------------------+--------------------------------------+ Boot two instances, now we use images with custom properties, those properties will map to Availability Zones(you can use other type of parameters mapping to Host Aggregates characteristics). # nova boot --flavor m1.tiny --image imageaz1 --nic net-id=6d62149e-74d3-4e52-9813-53ad207309f4 instanceimageaz1 # nova boot --flavor m1.tiny --image imageaz2 --nic net-id=6d62149e-74d3-4e52-9813-53ad207309f4 instanceimageaz2 Ensure the instances booted in the desired Availability Zone. # nova show instanceimageaz1 | grep OS-EXT-AZ | awk &#39;{print$2&quot;:&quot;$4}&#39; OS-EXT-AZ:availability_zone:az1 # nova show instanceimageaz2 | grep OS-EXT-AZ | awk &#39;{print$2&quot;:&quot;$4}&#39; OS-EXT-AZ:availability_zone:az2 Other method to launch instances is with parameters in flavors. Create two flavors. # nova flavor-create --is-public true flavoraz1 6 512 1 1 +----+-----------+-----------+------+-----------+------+-------+-------------+-----------+ | ID | Name | Memory_MB | Disk | Ephemeral | Swap | VCPUs | RXTX_Factor | Is_Public | +----+-----------+-----------+------+-----------+------+-------+-------------+-----------+ | 7 | flavoraz1 | 512 | 1 | 0 | | 1 | 1.0 | True | +----+-----------+-----------+------+-----------+------+-------+-------------+-----------+ # nova flavor-create --is-public true flavoraz2 7 512 1 1 +----+-----------+-----------+------+-----------+------+-------+-------------+-----------+ | ID | Name | Memory_MB | Disk | Ephemeral | Swap | VCPUs | RXTX_Factor | Is_Public | +----+-----------+-----------+------+-----------+------+-------+-------------+-----------+ | 8 | flavoraz2 | 512 | 1 | 0 | | 1 | 1.0 | True | +----+-----------+-----------+------+-----------+------+-------+-------------+-----------+ Add metadata to a Host Aggregate with some characteristic property as can be fast HD or cheap HW. # nova aggregate-set-metadata az1-ag fast=true Metadata has been successfully updated for aggregate 2. +----+--------+-------------------+--------------+--------------------------------------+ | Id | Name | Availability Zone | Hosts | Metadata | +----+--------+-------------------+--------------+--------------------------------------+ | 2 | az1-ag | az1 | &#39;compute1az&#39; | &#39;availability_zone=az1&#39;, &#39;fast=true&#39; | +----+--------+-------------------+--------------+--------------------------------------+ # nova aggregate-set-metadata az2-ag cheap=true Metadata has been successfully updated for aggregate 3. +----+--------+-------------------+--------------+---------------------------------------+ | Id | Name | Availability Zone | Hosts | Metadata | +----+--------+-------------------+--------------+---------------------------------------+ | 3 | az2-ag | az2 | &#39;compute2az&#39; | &#39;availability_zone=az2&#39;, &#39;cheap=true&#39; | +----+--------+-------------------+--------------+---------------------------------------+ Update the previous created flavors with the associated metadata key with the Host Aggregate. # nova flavor-key flavoraz1 set aggregate_instance_extra_specs:fast=true # nova flavor-key flavoraz2 set aggregate_instance_extra_specs:cheap=true Ensure, the properties are properly created. # nova flavor-show 7 | grep fast | awk &#39;{print$4$5}&#39; {&quot;aggregate_instance_extra_specs:fast&quot;:&quot;true&quot;} # nova flavor-show 8 | grep cheap | awk &#39;{print$4$5}&#39; {&quot;aggregate_instance_extra_specs:cheap&quot;:&quot;true&quot;} By default, Nova Scheduler don’t allow filtering by extra Specs inserted in flavors or images. First, ensure the following scheduler filters are allowed in Control nodes. # egrep ^scheduler_default_filters /etc/nova/nova.conf scheduler_default_filters=AggregateInstanceExtraSpecsFilter,RetryFilter,AvailabilityZoneFilter,RamFilter,ComputeFilter,ComputeCapabilitiesFilter,ImagePropertiesFilter,ServerGroupAntiAffinityFilter,ServerGroupAffinityFilter If a change has been done in nova.conf file, restart nova services # openstack-service restart nova Boot another two instaces, now using custom flavors # nova boot --flavor flavoraz1 --image cirros --nic net-id=6d62149e-74d3-4e52-9813-53ad207309f4 instanceflavoraz1 # nova boot --flavor flavoraz2 --image cirros --nic net-id=6d62149e-74d3-4e52-9813-53ad207309f4 instanceflavoraz2 Check where the instances are running. # nova show instanceflavoraz1 | grep OS-EXT-AZ | awk &#39;{print$2&quot;:&quot;$4}&#39; OS-EXT-AZ:availability_zone:az1 # nova show instanceflavoraz2 | grep OS-EXT-AZ | awk &#39;{print$2&quot;:&quot;$4}&#39; OS-EXT-AZ:availability_zone:az2 That’s all for now Hope this guide helps. Regards">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://217.182.136.201:8080/openstack-segregation-with-availability-zones-and-host-aggregates/">
  
  
  <link rel="alternate" type="application/rss+xml" title="OpenStack things" href="http://217.182.136.201:8080/feed.xml">

  

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="egongu90">
  <meta name="twitter:title" content="OpenStack segregation with Availability Zones and Host Aggregates">
  <meta name="twitter:description" content="When a new OpenStack cloud born, usually all servers run over the same hardware and specifications, often, all servers are in the same building, room, rack, even a chassis when the cloud is in the ...">
  
    <meta name="twitter:creator" content="egongu90">
  
  

  <script type="text/javascript">
  WebFontConfig = {
    google: { families: [ 'Bitter:400,700,400italic:latin' ] }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">OpenStack things</a>

    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/">About</a>
      
        
        <a class="page-link" href="/archives/">Archives</a>
      
        
        <a class="page-link" href="https://github.com/yous/whiteglass">GitHub</a>
      
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">OpenStack segregation with Availability Zones and Host Aggregates</h1>
    
    <p class="post-meta"><time datetime="2016-01-14T22:34:30+01:00" itemprop="datePublished">Jan 14, 2016</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Editor</span></span> • 
  
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/openstack/">OpenStack</a>
    
  
    
  
    
  

</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>When a new OpenStack cloud born, usually all servers run over the same hardware and specifications, often, all servers are in the same building, room, rack, even a chassis when the cloud is in the first growth paces.</p>

<p>After a while, workloads increase and the current hardware is not enough to process that workloads. At this point, your hardware is old and new hardware is bought. This hardware has different storage disks, CPU, RAM and so on. You passed from 10’s of servers to 100’s. DataCenter racks, rooms and buildings are too small and the growing cloud needs redundancy between cities or countries.</p>

<p>OpenStack offers a few solutions for that purpose, called Regions, Cells, Availability Zones and Host Aggregates.
Now, we are going to focus on Availability Zones and Host Aggregates, which are the way to segregate computational workloads.</p>
<ul>
	<li>Host Aggregates:
<ul>
	<li>Host Aggregates represent a logical set of properties/characteristics a group of hosts owns in the form of metadata. Imagine some of your servers have SSD disks and the other ones SATA, you can map those properties SSD/SATA to a group of hosts, when a image or flavor with the metaparameter associated is launched, Nova Scheduler will filter the available hosts with the meta parameter value and boot the instance on hosts with the desired property. Host Aggregates are managed by OpenStack admins.</li>
</ul>
</li>
	<li>Availability Zones
<ul>
	<li>Availability Zones represent a logical partition of the infrastructure(not necessary but is the common use case) in the form of racks, rooms, buildings, etc. Customers can launch instances in the desired Availability Zone.</li>
</ul>
</li>
</ul>
<p>Usually, Host Aggregates are mapped to Availability Zones allowing customers to use the desired set of hardware or characteristics to boot instances.</p>

<p>At the end of this guide you will know how to:</p>
<ol>
	<li>
Create Availability Zones and Host Aggregates.</li>
	<li>
Adding hosts to Host Aggregates and Availability Zones.</li>
	<li>
Launch instances directly to Availability Zones.</li>
	<li>
Configure nova scheduler for Host Aggregates usage.</li>
	<li>
Configure Images and Flavors for scheduling to Host Aggregates.</li>
	<li>
Launch instances based on flavors and image parameters.</li>
</ol>
<p>Let’s start: \00/</p>

<p>Create two Host Aggregate called <code>"az1-ag"/"az2-ag"</code>, this command also, will create two Availability Zones called <code>"az1"/"az2"</code>.
By default, when a Host Aggregate is created with an Availability Zone, a metadata key called <code>"availability_zone=NAME_OF_AZ</code>” will be created.</p>

<pre>
# nova aggregate-create az1-ag az1
+----+--------+-------------------+-------+-------------------------+
| Id | Name   | Availability Zone | Hosts | Metadata                |
+----+--------+-------------------+-------+-------------------------+
| 2  | az1-ag | az1               |       | 'availability_zone=az1' |
+----+--------+-------------------+-------+-------------------------+
# nova aggregate-create az2-ag az2
+----+--------+-------------------+-------+-------------------------+
| Id | Name   | Availability Zone | Hosts | Metadata                |
+----+--------+-------------------+-------+-------------------------+
| 3  | az2-ag | az2               |       | 'availability_zone=az2' |
+----+--------+-------------------+-------+-------------------------+
</pre>
<p>Add one or more compute nodes to Host Aggregates.</p>
<pre>
# nova aggregate-add-host 2 compute1az
Host compute1az has been successfully added for aggregate 2 
+----+--------+-------------------+--------------+-------------------------+
| Id | Name   | Availability Zone | Hosts        | Metadata                |
+----+--------+-------------------+--------------+-------------------------+
| 2  | az1-ag | az1               | 'compute1az' | 'availability_zone=az1' |
+----+--------+-------------------+--------------+-------------------------+
# nova aggregate-add-host 3 compute2az
Host compute2az has been successfully added for aggregate 3 
+----+--------+-------------------+--------------+-------------------------+
| Id | Name   | Availability Zone | Hosts        | Metadata                |
+----+--------+-------------------+--------------+-------------------------+
| 3  | az2-ag | az2               | 'compute2az' | 'availability_zone=az2' |
+----+--------+-------------------+--------------+-------------------------+
</pre>
<p>Details about a Host Aggregate can be reviewed with:</p>
<pre>
# nova aggregate-details az1-ag
+----+--------+-------------------+--------------+-------------------------+
| Id | Name   | Availability Zone | Hosts        | Metadata                |
+----+--------+-------------------+--------------+-------------------------+
| 2  | az1-ag | az1               | 'compute1az' | 'availability_zone=az1' |
+----+--------+-------------------+--------------+-------------------------+
# nova aggregate-details az2-ag
+----+--------+-------------------+--------------+-------------------------+
| Id | Name   | Availability Zone | Hosts        | Metadata                |
+----+--------+-------------------+--------------+-------------------------+
| 3  | az2-ag | az2               | 'compute2az' | 'availability_zone=az2' |
+----+--------+-------------------+--------------+-------------------------+
</pre>
<p>List Availability Zones and check status.</p>
<pre>
# nova availability-zone-list
+-----------------------+----------------------------------------+
| Name                  | Status                                 |
+-----------------------+----------------------------------------+
| internal              | available                              |
| |- controlleraz       |                                        |
| | |- nova-conductor   | enabled :-) 2016-01-14T19:08:16.000000 |
| | |- nova-consoleauth | enabled :-) 2016-01-14T19:08:16.000000 |
| | |- nova-scheduler   | enabled :-) 2016-01-14T19:08:16.000000 |
| | |- nova-cert        | enabled :-) 2016-01-14T19:08:13.000000 |
| az2                   | available                              |
| |- compute2az         |                                        |
| | |- nova-compute     | enabled :-) 2016-01-14T19:08:12.000000 |
| az1                   | available                              |
| |- compute1az         |                                        |
| | |- nova-compute     | enabled :-) 2016-01-14T19:08:12.000000 |
+-----------------------+----------------------------------------+
</pre>
<p>Other method you can use:</p>
<pre>
# nova service-list
+----+------------------+--------------+----------+---------+-------+----------------------------+-----------------+
| Id | Binary           | Host         | Zone     | Status  | State | Updated_at                 | Disabled Reason |
+----+------------------+--------------+----------+---------+-------+----------------------------+-----------------+
| 1  | nova-consoleauth | controlleraz | internal | enabled | up    | 2016-01-14T19:54:36.000000 | -               |
| 2  | nova-scheduler   | controlleraz | internal | enabled | up    | 2016-01-14T19:54:36.000000 | -               |
| 3  | nova-conductor   | controlleraz | internal | enabled | up    | 2016-01-14T19:54:35.000000 | -               |
| 4  | nova-cert        | controlleraz | internal | enabled | up    | 2016-01-14T19:54:33.000000 | -               |
| 5  | nova-compute     | compute2az   | az2      | enabled | up    | 2016-01-14T19:54:32.000000 | -               |
| 6  | nova-compute     | compute1az   | az1      | enabled | up    | 2016-01-14T19:54:32.000000 | -               |
+----+------------------+--------------+----------+---------+-------+----------------------------+-----------------+
</pre>
<p>Launch two instances using <code>"--availability-zone AZ</code>” option, you can even select the compute node to use, just use <code>"--availability-zone AZ:COMPUTE_NODE</code>”.</p>
<pre>
# nova boot --flavor m1.tiny --image cirros --nic net-id=6d62149e-74d3-4e52-9813-53ad207309f4 --availability-zone az1 instanceaz1
# nova boot --flavor m1.tiny --image cirros --nic net-id=6d62149e-74d3-4e52-9813-53ad207309f4 --availability-zone az2 instanceaz2
</pre>
<p>Ensure the instances are running in the desired Availability Zone.</p>
<pre>
# nova show instanceaz1 | grep OS-EXT-AZ | awk '{print$2":"$4}'
OS-EXT-AZ:availability_zone:az1
# nova show instanceaz2 | grep OS-EXT-AZ | awk '{print$2":"$4}'
OS-EXT-AZ:availability_zone:az2
</pre>
<p>List Glance images.</p>
<pre>
# glance image-list
+--------------------------------------+----------+
| ID                                   | Name     |
+--------------------------------------+----------+
| a6d7a606-f725-480a-9b1b-7b3ae39b93d4 | cirros   |
| a6540d72-dff7-4fb1-bc64-a8ea69e65178 | imageaz1 |
| 9c7e2d55-0b96-43e2-9231-88e426edb350 | imageaz2 |
+--------------------------------------+----------+
</pre>
<p>Update the images with custom properties, i use <code>"availability_zone"</code> because is the default meta parameter a Host Aggregate owns when is inside Availability Zones.</p>
<pre>
# glance image-update --property availability_zone=az1 a6540d72-dff7-4fb1-bc64-a8ea69e65178
+-------------------+--------------------------------------+
| Property          | Value                                |
+-------------------+--------------------------------------+
| availability_zone | az1                                  |
| checksum          | 133eae9fb1c98f45894a4e60d8736619     |
| container_format  | bare                                 |
| created_at        | 2016-01-14T19:59:04Z                 |
| disk_format       | qcow2                                |
| id                | a6540d72-dff7-4fb1-bc64-a8ea69e65178 |
| min_disk          | 0                                    |
| min_ram           | 0                                    |
| name              | imageaz1                             |
| owner             | 0571c6769c3f46acb195eeb01b87ae38     |
| protected         | False                                |
| size              | 13200896                             |
| status            | active                               |
| tags              | []                                   |
| updated_at        | 2016-01-14T20:13:05Z                 |
| virtual_size      | None                                 |
| visibility        | private                              |
+-------------------+--------------------------------------+
# glance image-update --property availability_zone=az2 9c7e2d55-0b96-43e2-9231-88e426edb350
+-------------------+--------------------------------------+
| Property          | Value                                |
+-------------------+--------------------------------------+
| availability_zone | az2                                  |
| checksum          | 133eae9fb1c98f45894a4e60d8736619     |
| container_format  | bare                                 |
| created_at        | 2016-01-14T19:59:10Z                 |
| disk_format       | qcow2                                |
| id                | 9c7e2d55-0b96-43e2-9231-88e426edb350 |
| min_disk          | 0                                    |
| min_ram           | 0                                    |
| name              | imageaz2                             |
| owner             | 0571c6769c3f46acb195eeb01b87ae38     |
| protected         | False                                |
| size              | 13200896                             |
| status            | active                               |
| tags              | []                                   |
| updated_at        | 2016-01-14T20:13:27Z                 |
| virtual_size      | None                                 |
| visibility        | private                              |
+-------------------+--------------------------------------+
</pre>
<p>Boot two instances, now we use images with custom properties, those properties will map to Availability Zones(you can use other type of parameters mapping to Host Aggregates characteristics).</p>
<pre>
# nova boot --flavor m1.tiny --image imageaz1 --nic net-id=6d62149e-74d3-4e52-9813-53ad207309f4 instanceimageaz1
# nova boot --flavor m1.tiny --image imageaz2 --nic net-id=6d62149e-74d3-4e52-9813-53ad207309f4 instanceimageaz2
</pre>
<p>Ensure the instances booted in the desired Availability Zone.</p>
<pre>
# nova show instanceimageaz1 | grep OS-EXT-AZ | awk '{print$2":"$4}'
OS-EXT-AZ:availability_zone:az1
# nova show instanceimageaz2 | grep OS-EXT-AZ | awk '{print$2":"$4}'
OS-EXT-AZ:availability_zone:az2
</pre>
<p>Other method to launch instances is with parameters in flavors.
Create two flavors.</p>
<pre>
# nova flavor-create --is-public true flavoraz1 6 512 1 1
+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+
| ID | Name      | Memory_MB | Disk | Ephemeral | Swap | VCPUs | RXTX_Factor | Is_Public |
+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+
| 7  | flavoraz1 | 512       | 1    | 0         |      | 1     | 1.0         | True      |
+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+
# nova flavor-create --is-public true flavoraz2 7 512 1 1
+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+
| ID | Name      | Memory_MB | Disk | Ephemeral | Swap | VCPUs | RXTX_Factor | Is_Public |
+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+
| 8  | flavoraz2 | 512       | 1    | 0         |      | 1     | 1.0         | True      |
+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+
</pre>
<p>Add metadata to a Host Aggregate with some characteristic property as can be fast HD or cheap HW.</p>
<pre>
# nova aggregate-set-metadata az1-ag fast=true
Metadata has been successfully updated for aggregate 2.
+----+--------+-------------------+--------------+--------------------------------------+
| Id | Name   | Availability Zone | Hosts        | Metadata                             |
+----+--------+-------------------+--------------+--------------------------------------+
| 2  | az1-ag | az1               | 'compute1az' | 'availability_zone=az1', 'fast=true' |
+----+--------+-------------------+--------------+--------------------------------------+
# nova aggregate-set-metadata az2-ag cheap=true
Metadata has been successfully updated for aggregate 3.
+----+--------+-------------------+--------------+---------------------------------------+
| Id | Name   | Availability Zone | Hosts        | Metadata                              |
+----+--------+-------------------+--------------+---------------------------------------+
| 3  | az2-ag | az2               | 'compute2az' | 'availability_zone=az2', 'cheap=true' |
+----+--------+-------------------+--------------+---------------------------------------+
</pre>
<p>Update the previous created flavors with the associated metadata key with the Host Aggregate.</p>
<pre>
# nova flavor-key flavoraz1 set  aggregate_instance_extra_specs:fast=true
# nova flavor-key flavoraz2 set  aggregate_instance_extra_specs:cheap=true
</pre>
<p>Ensure, the properties are properly created.</p>
<pre>
# nova flavor-show 7 | grep fast | awk '{print$4$5}'
{"aggregate_instance_extra_specs:fast":"true"}
# nova flavor-show 8 | grep cheap | awk '{print$4$5}'
{"aggregate_instance_extra_specs:cheap":"true"}
</pre>
<p>By default, Nova Scheduler don’t allow filtering by extra Specs inserted in flavors or images.
First, ensure the following scheduler filters are allowed in Control nodes.</p>
<pre>
# egrep ^scheduler_default_filters /etc/nova/nova.conf 
scheduler_default_filters=AggregateInstanceExtraSpecsFilter,RetryFilter,AvailabilityZoneFilter,RamFilter,ComputeFilter,ComputeCapabilitiesFilter,ImagePropertiesFilter,ServerGroupAntiAffinityFilter,ServerGroupAffinityFilter
</pre>
<p>If a change has been done in nova.conf file, restart nova services</p>
<pre>
# openstack-service restart nova
</pre>
<p>Boot another two instaces, now using custom flavors</p>
<pre>
# nova boot --flavor flavoraz1 --image cirros --nic net-id=6d62149e-74d3-4e52-9813-53ad207309f4 instanceflavoraz1
# nova boot --flavor flavoraz2 --image cirros --nic net-id=6d62149e-74d3-4e52-9813-53ad207309f4 instanceflavoraz2
</pre>
<p>Check where the instances are running.</p>
<pre>
# nova show instanceflavoraz1 | grep OS-EXT-AZ | awk '{print$2":"$4}'
OS-EXT-AZ:availability_zone:az1
# nova show instanceflavoraz2 | grep OS-EXT-AZ | awk '{print$2":"$4}'
OS-EXT-AZ:availability_zone:az2
</pre>

<p>That’s all for now
Hope this guide helps.
Regards</p>

  </div>

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

&copy;  - Powered by <a href="https://jekyllrb.com">Jekyll</a> &amp; <a href="https://github.com/yous/whiteglass">whiteglass</a> - Subscribe via <a href="http://217.182.136.201:8080/feed.xml">RSS</a>

    </p>

  </div>

</footer>


  </body>

</html>
