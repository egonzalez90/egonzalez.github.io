<!DOCTYPE html>
<html lang="en-US">

  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width,maximum-scale=2">
    <meta name="description" content="OpenStack things : OpenStack, Docker, Ansible, Ceph, Linux">

    <link rel="stylesheet" type="text/css" media="screen" href="/assets/css/style.css?v=9a6333a51cf04996f04338046deefb14dd69cda4">

<!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Nova VNC flows under the hood | OpenStack things</title>
<meta property="og:title" content="Nova VNC flows under the hood">
<meta name="author" content="Editor">
<meta property="og:locale" content="en_US">
<meta name="description" content="Most OpenStack deployments has a VNC console implemented with nova-novncproxy. This service gives the final user the ability to log into their instances in a web based method through a browser. At this post i’m going to show how a vnc console request works under the hood while using the following command or lauching a vnc session through Horizon. # nova get-vnc-console INSTANCE novnc First of all, a user connects to NOVA and issues a VNC console request for an instance. Nova API needs to validate the user issuing an authentication request to keystone. The user receives a token with nova’s endpoint URL in the catalog, with that endpoint and the token, the user makes a request against nova calling for a VNC session. GET http://192.168.200.208:5000/v2.0 -H &quot;Accept: application/json&quot; -H \ &quot;User-Agent: python-keystoneclient&quot; GET http://192.168.200.208:8774/v2/ -H &quot;User-Agent: python-novaclient&quot; -H \ &quot;Accept: application/json&quot; -H &quot;X-Auth-Token: {SHA1}3b6262df9eaba5da33c1004805187806322201f1&quot; If a name instead of an instance ID is used in the request, Nova need to check his database to match that name with his corresponding ID, as we can see in the following request. GET http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers?name=test1 \ -H &quot;User-Agent: python-novaclient&quot; -H &quot;Accept: application/json&quot; \ -H &quot;X-Auth-Token: {SHA1}3b6262df9eaba5da33c1004805187806322201f1&quot; RESP BODY: {&quot;servers&quot;: [{&quot;id&quot;: &quot;9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;, \ &quot;links&quot;: [{&quot;href&quot;: &quot;http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;, &quot;rel&quot;: &quot;self&quot;},\ {&quot;href&quot;: &quot;http://192.168.200.208:8774/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;, \ &quot;rel&quot;: &quot;bookmark&quot;}], &quot;name&quot;: &quot;test1&quot;}]} Once the ID is matched with the name, Nova check information about the instance (I thought it was to validate if is in ACTIVE status, but i realized that even when is in STOPPED status the request is made it anyway). GET http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee\ -H &quot;User-Agent: python-novaclient&quot; -H &quot;Accept: application/json&quot; \ -H &quot;X-Auth-Token: {SHA1}3b6262df9eaba5da33c1004805187806322201f1&quot; RESP BODY: {&quot;server&quot;: {&quot;status&quot;: &quot;ACTIVE&quot;, &quot;updated&quot;: &quot;2016-03-02T17:28:45Z&quot;, &quot;hostId&quot;: &quot;ca3a874dcad9079fcc6a0b10b0e2efaa394bc66b5335197fdd9c2498&quot;, &quot;OS-EXT-SRV-ATTR:host&quot;: &quot;liberty&quot;, &quot;addresses&quot;: {&quot;private&quot;: [{&quot;OS-EXT-IPS-MAC:mac_addr&quot;: &quot;fa:16:3e:aa:1c:32&quot;, &quot;version&quot;: 4, &quot;addr&quot;: &quot;10.0.0.6&quot;, &quot;OS-EXT-IPS:type&quot;: &quot;fixed&quot;}]}, &quot;links&quot;: [{&quot;href&quot;: &quot;http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;, &quot;rel&quot;: &quot;self&quot;}, {&quot;href&quot;: &quot;http://192.168.200.208:8774/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;, &quot;rel&quot;: &quot;bookmark&quot;}], &quot;key_name&quot;: null, &quot;image&quot;: {&quot;id&quot;: &quot;bf31eadd-c5f4-40f8-9ddb-30f688ca5e5f&quot;, &quot;links&quot;: [{&quot;href&quot;: &quot;http://192.168.200.208:8774/ee84411cdb8148d28674b129ef482f31/images/bf31eadd-c5f4-40f8-9ddb-30f688ca5e5f&quot;, &quot;rel&quot;: &quot;bookmark&quot;}]}, &quot;OS-EXT-STS:task_state&quot;: null, &quot;OS-EXT-STS:vm_state&quot;: &quot;active&quot;, &quot;OS-EXT-SRV-ATTR:instance_name&quot;: &quot;instance-0000000a&quot;, &quot;OS-SRV-USG:launched_at&quot;: &quot;2016-03-02T17:28:45.000000&quot;, &quot;OS-EXT-SRV-ATTR:hypervisor_hostname&quot;: &quot;liberty&quot;, &quot;flavor&quot;: {&quot;id&quot;: &quot;1&quot;, &quot;links&quot;: [{&quot;href&quot;: &quot;http://192.168.200.208:8774/ee84411cdb8148d28674b129ef482f31/flavors/1&quot;, &quot;rel&quot;: &quot;bookmark&quot;}]}, &quot;id&quot;: &quot;9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;, &quot;security_groups&quot;: [{&quot;name&quot;: &quot;default&quot;}], &quot;OS-SRV-USG:terminated_at&quot;: null, &quot;OS-EXT-AZ:availability_zone&quot;: &quot;nova&quot;, &quot;user_id&quot;: &quot;d9164a323be649c0a8c5c80fdd5bd585&quot;, &quot;name&quot;: &quot;test1&quot;, &quot;created&quot;: &quot;2016-03-02T17:28:34Z&quot;, &quot;tenant_id&quot;: &quot;ee84411cdb8148d28674b129ef482f31&quot;, &quot;OS-DCF:diskConfig&quot;: &quot;MANUAL&quot;, &quot;os-extended-volumes:volumes_attached&quot;: [], &quot;accessIPv4&quot;: &quot;&quot;, &quot;accessIPv6&quot;: &quot;&quot;, &quot;progress&quot;: 0, &quot;OS-EXT-STS:power_state&quot;: 1, &quot;config_drive&quot;: &quot;&quot;, &quot;metadata&quot;: {}}} When we get the information, nova-api POST a request to nova-consoleauth for a VNC console. POST http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee/action \ -H &quot;User-Agent: python-novaclient&quot; -H &quot;Content-Type: application/json&quot; \ -H &quot;Accept: application/json&quot; -H &quot;X-Auth-Token: {SHA1}3b6262df9eaba5da33c1004805187806322201f1&quot;\ -d '{&quot;os-getVNCConsole&quot;: {&quot;type&quot;: &quot;novnc&quot;}}' DEBUG nova.api.openstack.wsgi [req-2201b9d6-5711-46d3-ac4d-669094f07527 \ d9164a323be649c0a8c5c80fdd5bd585 ee84411cdb8148d28674b129ef482f31 - - -] \ Action: 'action', calling method: , body: {&quot;os-getVNCConsole&quot;: {&quot;type&quot;: &quot;novnc&quot;}} \ _process_stack /usr/lib/python2.7/site-packages/nova/api/openstack/wsgi.py:789 Nova-consoleauth receives the console request and create an access URL while generates a temporary token for the vnc console. INFO nova.consoleauth.manager [req-d4def6f9-1ab9-4626-b6a8-d81643ea5eb4 d9164a323be649c0a8c5c80fdd5bd585 ee84411cdb8148d28674b129ef482f31 - - -] \ Received Token: 3dfcd011-28f1-4cf3-8f5c-8cd18de4560e, \ {'instance_uuid': u'9165dbda-f54e-4186-b2cb-e6ca05ac53ee', \ 'access_url': u'http://192.168.200.208:6080/vnc_auto.html?token=3dfcd011-28f1-4cf3-8f5c-8cd18de4560e',\ 'token': u'3dfcd011-28f1-4cf3-8f5c-8cd18de4560e', 'last_activity_at': 1456940028.356214, \ 'internal_access_path': None, 'console_type': u'novnc', 'host': u'liberty', 'port': u'5900'} Nova-consoleauth answer to nova-api who also answers to the user with an access URL. This URL got the following content on it: HTTP or HTTPS connection to nova-novncproxy IP Nova-novncproxy port A token to validate the VNC connection RESP BODY: {&quot;console&quot;: {&quot;url&quot;: &quot;http://192.168.200.208:6080/vnc_auto.html?token=3dfcd011-28f1-4cf3-8f5c-8cd18de4560e&quot;, &quot;type&quot;: &quot;novnc&quot;}} +-------+--------------------------------------------------------------------------------------+ | Type | Url | +-------+--------------------------------------------------------------------------------------+ | novnc | http://192.168.200.208:6080/vnc_auto.html?token=3dfcd011-28f1-4cf3-8f5c-8cd18de4560e | +-------+--------------------------------------------------------------------------------------+ Until now, nova-novncproxy service can be stopped or isn’t used at all, is at this point the when proxy server enter into the game. The user connects through a web browser to the nova-novncproxy’s URL provided by nova before. DEBUG nova.console.websocketproxy [-] 192.168.200.1: \ new handler Process vmsg /usr/lib/python2.7/site-packages/websockify/websocket.py:828 Nova-vncproxy validate the issued token with the URL against nova-consoleauth. nova.consoleauth.manager [req-399c7b58-700a-4779-b215-b12d10056813 - - - - -] \ Checking Token: 3dfcd011-28f1-4cf3-8f5c-8cd18de4560e, True When the token is validated, nova-novncproxy maps compute’s node private IP (at this case port 5900) with the nova-novncproxy public IP(6080 port). INFO nova.console.websocketproxy [req-399c7b58-700a-4779-b215-b12d10056813 - - - - -]\ 7: connect info: {u'instance_uuid': u'9165dbda-f54e-4186-b2cb-e6ca05ac53ee', u'\ internal_access_path': None, u'last_activity_at': 1456940028.356214, \ u'console_type': u'novnc', u'host': u'liberty', u'token': u'3dfcd011-28f1-4cf3-8f5c-8cd18de4560e', \ u'access_url': u'http://192.168.200.208:6080/vnc_auto.html?token=3dfcd011-28f1-4cf3-8f5c-8cd18de4560e'\ , u'port': u'5900'} We can see how the python novncproxy process binds both IPs/port. # ps aux | grep vnc nova 14840 1.2 0.7 362096 41000 ? S 18:53 0:14 /usr/bin/python2 /usr/bin/nova-novncproxy --web /usr/share/novnc/ # netstat -putona | grep 14840 tcp 0 0 192.168.200.208:6080 192.168.200.1:59918 ESTABLISHED 14840/python2 keepalive (3,13/0/0) tcp 0 0 192.168.122.73:57764 192.168.122.73:5900 ESTABLISHED 14840/python2 keepalive (3,13/0/0) Nova-novncproxy starts the connection between the instance and user’s browser session. INFO nova.console.websocketproxy [req-399c7b58-700a-4779-b215-b12d10056813 - - - - -]\ 7: connecting to: liberty:5900 Libvirt connects a vnc console into the instance, as we can see at the xml provided by virsh command. Also, port 5900 now is binded at qemu-kvm process. # virsh dumpxml 2 ... &lt;graphics type='vnc' port='5900' autoport='yes' listen='0.0.0.0' keymap='en-us'&gt; &lt;listen type='address' address='0.0.0.0'/&gt; &lt;/graphics&gt; ... # netstat -putona | grep 5900 tcp 0 0 0.0.0.0:5900 0.0.0.0:* LISTEN 5910/qemu-kvm off (0.00/0/0) tcp 0 0 192.168.122.73:5900 192.168.122.73:57702 ESTABLISHED 5910/qemu-kvm off (0.00/0/0) tcp 0 0 192.168.122.73:57702 192.168.122.73:5900 ESTABLISHED 11118/python2 keepalive (1,92/0/0) Nova-novncproxy keeps the connection alive until browser session ends. DEBUG nova.console.websocketproxy [-] \ Reaing zombies, active child count is 1 vmsg /usr/lib/python2.7/site-packages/websockify/websocket.py:828 When a token is not valid while authenticating against nova-consoleauth, we can see a message like the following. INFO nova.console.websocketproxy [req-9164b32d-3ce1-441b-82c7-6c23c9a354d0 - - - - -] \ handler exception: The token '3dfcd011-28f1-4cf3-8f5c-8cd18de4560e' is invalid or has expired Regards. Eduardo Gonzalez">
<meta property="og:description" content="Most OpenStack deployments has a VNC console implemented with nova-novncproxy. This service gives the final user the ability to log into their instances in a web based method through a browser. At this post i’m going to show how a vnc console request works under the hood while using the following command or lauching a vnc session through Horizon. # nova get-vnc-console INSTANCE novnc First of all, a user connects to NOVA and issues a VNC console request for an instance. Nova API needs to validate the user issuing an authentication request to keystone. The user receives a token with nova’s endpoint URL in the catalog, with that endpoint and the token, the user makes a request against nova calling for a VNC session. GET http://192.168.200.208:5000/v2.0 -H &quot;Accept: application/json&quot; -H \ &quot;User-Agent: python-keystoneclient&quot; GET http://192.168.200.208:8774/v2/ -H &quot;User-Agent: python-novaclient&quot; -H \ &quot;Accept: application/json&quot; -H &quot;X-Auth-Token: {SHA1}3b6262df9eaba5da33c1004805187806322201f1&quot; If a name instead of an instance ID is used in the request, Nova need to check his database to match that name with his corresponding ID, as we can see in the following request. GET http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers?name=test1 \ -H &quot;User-Agent: python-novaclient&quot; -H &quot;Accept: application/json&quot; \ -H &quot;X-Auth-Token: {SHA1}3b6262df9eaba5da33c1004805187806322201f1&quot; RESP BODY: {&quot;servers&quot;: [{&quot;id&quot;: &quot;9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;, \ &quot;links&quot;: [{&quot;href&quot;: &quot;http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;, &quot;rel&quot;: &quot;self&quot;},\ {&quot;href&quot;: &quot;http://192.168.200.208:8774/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;, \ &quot;rel&quot;: &quot;bookmark&quot;}], &quot;name&quot;: &quot;test1&quot;}]} Once the ID is matched with the name, Nova check information about the instance (I thought it was to validate if is in ACTIVE status, but i realized that even when is in STOPPED status the request is made it anyway). GET http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee\ -H &quot;User-Agent: python-novaclient&quot; -H &quot;Accept: application/json&quot; \ -H &quot;X-Auth-Token: {SHA1}3b6262df9eaba5da33c1004805187806322201f1&quot; RESP BODY: {&quot;server&quot;: {&quot;status&quot;: &quot;ACTIVE&quot;, &quot;updated&quot;: &quot;2016-03-02T17:28:45Z&quot;, &quot;hostId&quot;: &quot;ca3a874dcad9079fcc6a0b10b0e2efaa394bc66b5335197fdd9c2498&quot;, &quot;OS-EXT-SRV-ATTR:host&quot;: &quot;liberty&quot;, &quot;addresses&quot;: {&quot;private&quot;: [{&quot;OS-EXT-IPS-MAC:mac_addr&quot;: &quot;fa:16:3e:aa:1c:32&quot;, &quot;version&quot;: 4, &quot;addr&quot;: &quot;10.0.0.6&quot;, &quot;OS-EXT-IPS:type&quot;: &quot;fixed&quot;}]}, &quot;links&quot;: [{&quot;href&quot;: &quot;http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;, &quot;rel&quot;: &quot;self&quot;}, {&quot;href&quot;: &quot;http://192.168.200.208:8774/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;, &quot;rel&quot;: &quot;bookmark&quot;}], &quot;key_name&quot;: null, &quot;image&quot;: {&quot;id&quot;: &quot;bf31eadd-c5f4-40f8-9ddb-30f688ca5e5f&quot;, &quot;links&quot;: [{&quot;href&quot;: &quot;http://192.168.200.208:8774/ee84411cdb8148d28674b129ef482f31/images/bf31eadd-c5f4-40f8-9ddb-30f688ca5e5f&quot;, &quot;rel&quot;: &quot;bookmark&quot;}]}, &quot;OS-EXT-STS:task_state&quot;: null, &quot;OS-EXT-STS:vm_state&quot;: &quot;active&quot;, &quot;OS-EXT-SRV-ATTR:instance_name&quot;: &quot;instance-0000000a&quot;, &quot;OS-SRV-USG:launched_at&quot;: &quot;2016-03-02T17:28:45.000000&quot;, &quot;OS-EXT-SRV-ATTR:hypervisor_hostname&quot;: &quot;liberty&quot;, &quot;flavor&quot;: {&quot;id&quot;: &quot;1&quot;, &quot;links&quot;: [{&quot;href&quot;: &quot;http://192.168.200.208:8774/ee84411cdb8148d28674b129ef482f31/flavors/1&quot;, &quot;rel&quot;: &quot;bookmark&quot;}]}, &quot;id&quot;: &quot;9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;, &quot;security_groups&quot;: [{&quot;name&quot;: &quot;default&quot;}], &quot;OS-SRV-USG:terminated_at&quot;: null, &quot;OS-EXT-AZ:availability_zone&quot;: &quot;nova&quot;, &quot;user_id&quot;: &quot;d9164a323be649c0a8c5c80fdd5bd585&quot;, &quot;name&quot;: &quot;test1&quot;, &quot;created&quot;: &quot;2016-03-02T17:28:34Z&quot;, &quot;tenant_id&quot;: &quot;ee84411cdb8148d28674b129ef482f31&quot;, &quot;OS-DCF:diskConfig&quot;: &quot;MANUAL&quot;, &quot;os-extended-volumes:volumes_attached&quot;: [], &quot;accessIPv4&quot;: &quot;&quot;, &quot;accessIPv6&quot;: &quot;&quot;, &quot;progress&quot;: 0, &quot;OS-EXT-STS:power_state&quot;: 1, &quot;config_drive&quot;: &quot;&quot;, &quot;metadata&quot;: {}}} When we get the information, nova-api POST a request to nova-consoleauth for a VNC console. POST http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee/action \ -H &quot;User-Agent: python-novaclient&quot; -H &quot;Content-Type: application/json&quot; \ -H &quot;Accept: application/json&quot; -H &quot;X-Auth-Token: {SHA1}3b6262df9eaba5da33c1004805187806322201f1&quot;\ -d '{&quot;os-getVNCConsole&quot;: {&quot;type&quot;: &quot;novnc&quot;}}' DEBUG nova.api.openstack.wsgi [req-2201b9d6-5711-46d3-ac4d-669094f07527 \ d9164a323be649c0a8c5c80fdd5bd585 ee84411cdb8148d28674b129ef482f31 - - -] \ Action: 'action', calling method: , body: {&quot;os-getVNCConsole&quot;: {&quot;type&quot;: &quot;novnc&quot;}} \ _process_stack /usr/lib/python2.7/site-packages/nova/api/openstack/wsgi.py:789 Nova-consoleauth receives the console request and create an access URL while generates a temporary token for the vnc console. INFO nova.consoleauth.manager [req-d4def6f9-1ab9-4626-b6a8-d81643ea5eb4 d9164a323be649c0a8c5c80fdd5bd585 ee84411cdb8148d28674b129ef482f31 - - -] \ Received Token: 3dfcd011-28f1-4cf3-8f5c-8cd18de4560e, \ {'instance_uuid': u'9165dbda-f54e-4186-b2cb-e6ca05ac53ee', \ 'access_url': u'http://192.168.200.208:6080/vnc_auto.html?token=3dfcd011-28f1-4cf3-8f5c-8cd18de4560e',\ 'token': u'3dfcd011-28f1-4cf3-8f5c-8cd18de4560e', 'last_activity_at': 1456940028.356214, \ 'internal_access_path': None, 'console_type': u'novnc', 'host': u'liberty', 'port': u'5900'} Nova-consoleauth answer to nova-api who also answers to the user with an access URL. This URL got the following content on it: HTTP or HTTPS connection to nova-novncproxy IP Nova-novncproxy port A token to validate the VNC connection RESP BODY: {&quot;console&quot;: {&quot;url&quot;: &quot;http://192.168.200.208:6080/vnc_auto.html?token=3dfcd011-28f1-4cf3-8f5c-8cd18de4560e&quot;, &quot;type&quot;: &quot;novnc&quot;}} +-------+--------------------------------------------------------------------------------------+ | Type | Url | +-------+--------------------------------------------------------------------------------------+ | novnc | http://192.168.200.208:6080/vnc_auto.html?token=3dfcd011-28f1-4cf3-8f5c-8cd18de4560e | +-------+--------------------------------------------------------------------------------------+ Until now, nova-novncproxy service can be stopped or isn’t used at all, is at this point the when proxy server enter into the game. The user connects through a web browser to the nova-novncproxy’s URL provided by nova before. DEBUG nova.console.websocketproxy [-] 192.168.200.1: \ new handler Process vmsg /usr/lib/python2.7/site-packages/websockify/websocket.py:828 Nova-vncproxy validate the issued token with the URL against nova-consoleauth. nova.consoleauth.manager [req-399c7b58-700a-4779-b215-b12d10056813 - - - - -] \ Checking Token: 3dfcd011-28f1-4cf3-8f5c-8cd18de4560e, True When the token is validated, nova-novncproxy maps compute’s node private IP (at this case port 5900) with the nova-novncproxy public IP(6080 port). INFO nova.console.websocketproxy [req-399c7b58-700a-4779-b215-b12d10056813 - - - - -]\ 7: connect info: {u'instance_uuid': u'9165dbda-f54e-4186-b2cb-e6ca05ac53ee', u'\ internal_access_path': None, u'last_activity_at': 1456940028.356214, \ u'console_type': u'novnc', u'host': u'liberty', u'token': u'3dfcd011-28f1-4cf3-8f5c-8cd18de4560e', \ u'access_url': u'http://192.168.200.208:6080/vnc_auto.html?token=3dfcd011-28f1-4cf3-8f5c-8cd18de4560e'\ , u'port': u'5900'} We can see how the python novncproxy process binds both IPs/port. # ps aux | grep vnc nova 14840 1.2 0.7 362096 41000 ? S 18:53 0:14 /usr/bin/python2 /usr/bin/nova-novncproxy --web /usr/share/novnc/ # netstat -putona | grep 14840 tcp 0 0 192.168.200.208:6080 192.168.200.1:59918 ESTABLISHED 14840/python2 keepalive (3,13/0/0) tcp 0 0 192.168.122.73:57764 192.168.122.73:5900 ESTABLISHED 14840/python2 keepalive (3,13/0/0) Nova-novncproxy starts the connection between the instance and user’s browser session. INFO nova.console.websocketproxy [req-399c7b58-700a-4779-b215-b12d10056813 - - - - -]\ 7: connecting to: liberty:5900 Libvirt connects a vnc console into the instance, as we can see at the xml provided by virsh command. Also, port 5900 now is binded at qemu-kvm process. # virsh dumpxml 2 ... &lt;graphics type='vnc' port='5900' autoport='yes' listen='0.0.0.0' keymap='en-us'&gt; &lt;listen type='address' address='0.0.0.0'/&gt; &lt;/graphics&gt; ... # netstat -putona | grep 5900 tcp 0 0 0.0.0.0:5900 0.0.0.0:* LISTEN 5910/qemu-kvm off (0.00/0/0) tcp 0 0 192.168.122.73:5900 192.168.122.73:57702 ESTABLISHED 5910/qemu-kvm off (0.00/0/0) tcp 0 0 192.168.122.73:57702 192.168.122.73:5900 ESTABLISHED 11118/python2 keepalive (1,92/0/0) Nova-novncproxy keeps the connection alive until browser session ends. DEBUG nova.console.websocketproxy [-] \ Reaing zombies, active child count is 1 vmsg /usr/lib/python2.7/site-packages/websockify/websocket.py:828 When a token is not valid while authenticating against nova-consoleauth, we can see a message like the following. INFO nova.console.websocketproxy [req-9164b32d-3ce1-441b-82c7-6c23c9a354d0 - - - - -] \ handler exception: The token '3dfcd011-28f1-4cf3-8f5c-8cd18de4560e' is invalid or has expired Regards. Eduardo Gonzalez">
<link rel="canonical" href="http://217.182.136.201:5000/nova-vnc-flows-under-the-hood/">
<meta property="og:url" content="http://217.182.136.201:5000/nova-vnc-flows-under-the-hood/">
<meta property="og:site_name" content="OpenStack things">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2016-03-02T22:26:38+00:00">
<script type="application/ld+json">
{"name":null,"description":"Most OpenStack deployments has a VNC console implemented with nova-novncproxy. This service gives the final user the ability to log into their instances in a web based method through a browser. At this post i’m going to show how a vnc console request works under the hood while using the following command or lauching a vnc session through Horizon. # nova get-vnc-console INSTANCE novnc First of all, a user connects to NOVA and issues a VNC console request for an instance. Nova API needs to validate the user issuing an authentication request to keystone. The user receives a token with nova’s endpoint URL in the catalog, with that endpoint and the token, the user makes a request against nova calling for a VNC session. GET http://192.168.200.208:5000/v2.0 -H &quot;Accept: application/json&quot; -H \\ &quot;User-Agent: python-keystoneclient&quot; GET http://192.168.200.208:8774/v2/ -H &quot;User-Agent: python-novaclient&quot; -H \\ &quot;Accept: application/json&quot; -H &quot;X-Auth-Token: {SHA1}3b6262df9eaba5da33c1004805187806322201f1&quot; If a name instead of an instance ID is used in the request, Nova need to check his database to match that name with his corresponding ID, as we can see in the following request. GET http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers?name=test1 \\ -H &quot;User-Agent: python-novaclient&quot; -H &quot;Accept: application/json&quot; \\ -H &quot;X-Auth-Token: {SHA1}3b6262df9eaba5da33c1004805187806322201f1&quot; RESP BODY: {&quot;servers&quot;: [{&quot;id&quot;: &quot;9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;, \\ &quot;links&quot;: [{&quot;href&quot;: &quot;http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;, &quot;rel&quot;: &quot;self&quot;},\\ {&quot;href&quot;: &quot;http://192.168.200.208:8774/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;, \\ &quot;rel&quot;: &quot;bookmark&quot;}], &quot;name&quot;: &quot;test1&quot;}]} Once the ID is matched with the name, Nova check information about the instance (I thought it was to validate if is in ACTIVE status, but i realized that even when is in STOPPED status the request is made it anyway). GET http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee\\ -H &quot;User-Agent: python-novaclient&quot; -H &quot;Accept: application/json&quot; \\ -H &quot;X-Auth-Token: {SHA1}3b6262df9eaba5da33c1004805187806322201f1&quot; RESP BODY: {&quot;server&quot;: {&quot;status&quot;: &quot;ACTIVE&quot;, &quot;updated&quot;: &quot;2016-03-02T17:28:45Z&quot;, &quot;hostId&quot;: &quot;ca3a874dcad9079fcc6a0b10b0e2efaa394bc66b5335197fdd9c2498&quot;, &quot;OS-EXT-SRV-ATTR:host&quot;: &quot;liberty&quot;, &quot;addresses&quot;: {&quot;private&quot;: [{&quot;OS-EXT-IPS-MAC:mac_addr&quot;: &quot;fa:16:3e:aa:1c:32&quot;, &quot;version&quot;: 4, &quot;addr&quot;: &quot;10.0.0.6&quot;, &quot;OS-EXT-IPS:type&quot;: &quot;fixed&quot;}]}, &quot;links&quot;: [{&quot;href&quot;: &quot;http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;, &quot;rel&quot;: &quot;self&quot;}, {&quot;href&quot;: &quot;http://192.168.200.208:8774/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;, &quot;rel&quot;: &quot;bookmark&quot;}], &quot;key_name&quot;: null, &quot;image&quot;: {&quot;id&quot;: &quot;bf31eadd-c5f4-40f8-9ddb-30f688ca5e5f&quot;, &quot;links&quot;: [{&quot;href&quot;: &quot;http://192.168.200.208:8774/ee84411cdb8148d28674b129ef482f31/images/bf31eadd-c5f4-40f8-9ddb-30f688ca5e5f&quot;, &quot;rel&quot;: &quot;bookmark&quot;}]}, &quot;OS-EXT-STS:task_state&quot;: null, &quot;OS-EXT-STS:vm_state&quot;: &quot;active&quot;, &quot;OS-EXT-SRV-ATTR:instance_name&quot;: &quot;instance-0000000a&quot;, &quot;OS-SRV-USG:launched_at&quot;: &quot;2016-03-02T17:28:45.000000&quot;, &quot;OS-EXT-SRV-ATTR:hypervisor_hostname&quot;: &quot;liberty&quot;, &quot;flavor&quot;: {&quot;id&quot;: &quot;1&quot;, &quot;links&quot;: [{&quot;href&quot;: &quot;http://192.168.200.208:8774/ee84411cdb8148d28674b129ef482f31/flavors/1&quot;, &quot;rel&quot;: &quot;bookmark&quot;}]}, &quot;id&quot;: &quot;9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;, &quot;security_groups&quot;: [{&quot;name&quot;: &quot;default&quot;}], &quot;OS-SRV-USG:terminated_at&quot;: null, &quot;OS-EXT-AZ:availability_zone&quot;: &quot;nova&quot;, &quot;user_id&quot;: &quot;d9164a323be649c0a8c5c80fdd5bd585&quot;, &quot;name&quot;: &quot;test1&quot;, &quot;created&quot;: &quot;2016-03-02T17:28:34Z&quot;, &quot;tenant_id&quot;: &quot;ee84411cdb8148d28674b129ef482f31&quot;, &quot;OS-DCF:diskConfig&quot;: &quot;MANUAL&quot;, &quot;os-extended-volumes:volumes_attached&quot;: [], &quot;accessIPv4&quot;: &quot;&quot;, &quot;accessIPv6&quot;: &quot;&quot;, &quot;progress&quot;: 0, &quot;OS-EXT-STS:power_state&quot;: 1, &quot;config_drive&quot;: &quot;&quot;, &quot;metadata&quot;: {}}} When we get the information, nova-api POST a request to nova-consoleauth for a VNC console. POST http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee/action \\ -H &quot;User-Agent: python-novaclient&quot; -H &quot;Content-Type: application/json&quot; \\ -H &quot;Accept: application/json&quot; -H &quot;X-Auth-Token: {SHA1}3b6262df9eaba5da33c1004805187806322201f1&quot;\\ -d &#39;{&quot;os-getVNCConsole&quot;: {&quot;type&quot;: &quot;novnc&quot;}}&#39; DEBUG nova.api.openstack.wsgi [req-2201b9d6-5711-46d3-ac4d-669094f07527 \\ d9164a323be649c0a8c5c80fdd5bd585 ee84411cdb8148d28674b129ef482f31 - - -] \\ Action: &#39;action&#39;, calling method: , body: {&quot;os-getVNCConsole&quot;: {&quot;type&quot;: &quot;novnc&quot;}} \\ _process_stack /usr/lib/python2.7/site-packages/nova/api/openstack/wsgi.py:789 Nova-consoleauth receives the console request and create an access URL while generates a temporary token for the vnc console. INFO nova.consoleauth.manager [req-d4def6f9-1ab9-4626-b6a8-d81643ea5eb4 d9164a323be649c0a8c5c80fdd5bd585 ee84411cdb8148d28674b129ef482f31 - - -] \\ Received Token: 3dfcd011-28f1-4cf3-8f5c-8cd18de4560e, \\ {&#39;instance_uuid&#39;: u&#39;9165dbda-f54e-4186-b2cb-e6ca05ac53ee&#39;, \\ &#39;access_url&#39;: u&#39;http://192.168.200.208:6080/vnc_auto.html?token=3dfcd011-28f1-4cf3-8f5c-8cd18de4560e&#39;,\\ &#39;token&#39;: u&#39;3dfcd011-28f1-4cf3-8f5c-8cd18de4560e&#39;, &#39;last_activity_at&#39;: 1456940028.356214, \\ &#39;internal_access_path&#39;: None, &#39;console_type&#39;: u&#39;novnc&#39;, &#39;host&#39;: u&#39;liberty&#39;, &#39;port&#39;: u&#39;5900&#39;} Nova-consoleauth answer to nova-api who also answers to the user with an access URL. This URL got the following content on it: HTTP or HTTPS connection to nova-novncproxy IP Nova-novncproxy port A token to validate the VNC connection RESP BODY: {&quot;console&quot;: {&quot;url&quot;: &quot;http://192.168.200.208:6080/vnc_auto.html?token=3dfcd011-28f1-4cf3-8f5c-8cd18de4560e&quot;, &quot;type&quot;: &quot;novnc&quot;}} +-------+--------------------------------------------------------------------------------------+ | Type | Url | +-------+--------------------------------------------------------------------------------------+ | novnc | http://192.168.200.208:6080/vnc_auto.html?token=3dfcd011-28f1-4cf3-8f5c-8cd18de4560e | +-------+--------------------------------------------------------------------------------------+ Until now, nova-novncproxy service can be stopped or isn’t used at all, is at this point the when proxy server enter into the game. The user connects through a web browser to the nova-novncproxy’s URL provided by nova before. DEBUG nova.console.websocketproxy [-] 192.168.200.1: \\ new handler Process vmsg /usr/lib/python2.7/site-packages/websockify/websocket.py:828 Nova-vncproxy validate the issued token with the URL against nova-consoleauth. nova.consoleauth.manager [req-399c7b58-700a-4779-b215-b12d10056813 - - - - -] \\ Checking Token: 3dfcd011-28f1-4cf3-8f5c-8cd18de4560e, True When the token is validated, nova-novncproxy maps compute’s node private IP (at this case port 5900) with the nova-novncproxy public IP(6080 port). INFO nova.console.websocketproxy [req-399c7b58-700a-4779-b215-b12d10056813 - - - - -]\\ 7: connect info: {u&#39;instance_uuid&#39;: u&#39;9165dbda-f54e-4186-b2cb-e6ca05ac53ee&#39;, u&#39;\\ internal_access_path&#39;: None, u&#39;last_activity_at&#39;: 1456940028.356214, \\ u&#39;console_type&#39;: u&#39;novnc&#39;, u&#39;host&#39;: u&#39;liberty&#39;, u&#39;token&#39;: u&#39;3dfcd011-28f1-4cf3-8f5c-8cd18de4560e&#39;, \\ u&#39;access_url&#39;: u&#39;http://192.168.200.208:6080/vnc_auto.html?token=3dfcd011-28f1-4cf3-8f5c-8cd18de4560e&#39;\\ , u&#39;port&#39;: u&#39;5900&#39;} We can see how the python novncproxy process binds both IPs/port. # ps aux | grep vnc nova 14840 1.2 0.7 362096 41000 ? S 18:53 0:14 /usr/bin/python2 /usr/bin/nova-novncproxy --web /usr/share/novnc/ # netstat -putona | grep 14840 tcp 0 0 192.168.200.208:6080 192.168.200.1:59918 ESTABLISHED 14840/python2 keepalive (3,13/0/0) tcp 0 0 192.168.122.73:57764 192.168.122.73:5900 ESTABLISHED 14840/python2 keepalive (3,13/0/0) Nova-novncproxy starts the connection between the instance and user’s browser session. INFO nova.console.websocketproxy [req-399c7b58-700a-4779-b215-b12d10056813 - - - - -]\\ 7: connecting to: liberty:5900 Libvirt connects a vnc console into the instance, as we can see at the xml provided by virsh command. Also, port 5900 now is binded at qemu-kvm process. # virsh dumpxml 2 ... &lt;graphics type=&#39;vnc&#39; port=&#39;5900&#39; autoport=&#39;yes&#39; listen=&#39;0.0.0.0&#39; keymap=&#39;en-us&#39;&gt; &lt;listen type=&#39;address&#39; address=&#39;0.0.0.0&#39;/&gt; &lt;/graphics&gt; ... # netstat -putona | grep 5900 tcp 0 0 0.0.0.0:5900 0.0.0.0:* LISTEN 5910/qemu-kvm off (0.00/0/0) tcp 0 0 192.168.122.73:5900 192.168.122.73:57702 ESTABLISHED 5910/qemu-kvm off (0.00/0/0) tcp 0 0 192.168.122.73:57702 192.168.122.73:5900 ESTABLISHED 11118/python2 keepalive (1,92/0/0) Nova-novncproxy keeps the connection alive until browser session ends. DEBUG nova.console.websocketproxy [-] \\ Reaing zombies, active child count is 1 vmsg /usr/lib/python2.7/site-packages/websockify/websocket.py:828 When a token is not valid while authenticating against nova-consoleauth, we can see a message like the following. INFO nova.console.websocketproxy [req-9164b32d-3ce1-441b-82c7-6c23c9a354d0 - - - - -] \\ handler exception: The token &#39;3dfcd011-28f1-4cf3-8f5c-8cd18de4560e&#39; is invalid or has expired Regards. Eduardo Gonzalez","author":{"@type":"Person","name":"Editor"},"@type":"BlogPosting","url":"http://217.182.136.201:5000/nova-vnc-flows-under-the-hood/","publisher":null,"image":null,"headline":"Nova VNC flows under the hood","dateModified":"2016-03-02T22:26:38+00:00","datePublished":"2016-03-02T22:26:38+00:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"http://217.182.136.201:5000/nova-vnc-flows-under-the-hood/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="http://github.com/egonzalez90/egonzalez90.github.io">View on GitHub</a>

          <h1 id="project_title">OpenStack things</h1>
          <h2 id="project_tagline">OpenStack, Docker, Ansible, Ceph, Linux</h2>

          
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <p>Most OpenStack deployments has a VNC console implemented with nova-novncproxy. This service gives the final user the ability to log into their instances in a web based method through a browser.</p>

<p>At this post i’m going to show how a vnc console request works under the hood while using the following command or lauching a vnc session through Horizon.</p>
<pre># nova get-vnc-console INSTANCE novnc
</pre>
<p>First of all, a user connects to NOVA and issues a VNC console request for an instance. Nova API needs to validate the user issuing an authentication request to keystone.
The user receives a token with nova’s endpoint URL in the catalog, with that endpoint and the token, the user makes a request against nova calling for a VNC session.</p>
<pre>GET http://192.168.200.208:5000/v2.0 -H "Accept: application/json" -H \
"User-Agent: python-keystoneclient"

GET http://192.168.200.208:8774/v2/ -H "User-Agent: python-novaclient" -H \
"Accept: application/json" -H "X-Auth-Token: {SHA1}3b6262df9eaba5da33c1004805187806322201f1"
</pre>
<p>If a name instead of an instance ID is used in the request, Nova need to check his database to match that name with his corresponding ID, as we can see in the following request.</p>
<pre>
GET http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers?name=test1 \
-H "User-Agent: python-novaclient" -H "Accept: application/json" \
-H "X-Auth-Token: {SHA1}3b6262df9eaba5da33c1004805187806322201f1"

RESP BODY: {"servers": [{"id": "9165dbda-f54e-4186-b2cb-e6ca05ac53ee", \
"links": [{"href": "http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee", "rel": "self"},\
 {"href": "http://192.168.200.208:8774/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee", \
"rel": "bookmark"}], "name": "test1"}]}
</pre>
<p>Once the ID is matched with the name, Nova check information about the instance (I thought it was to validate if is in ACTIVE status, but i realized that even when is in STOPPED status the request is made it anyway).</p>
<pre>
GET http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee\
 -H "User-Agent: python-novaclient" -H "Accept: application/json" \
 -H "X-Auth-Token: {SHA1}3b6262df9eaba5da33c1004805187806322201f1"

RESP BODY: {"server": {"status": "ACTIVE", "updated": "2016-03-02T17:28:45Z", "hostId": "ca3a874dcad9079fcc6a0b10b0e2efaa394bc66b5335197fdd9c2498", "OS-EXT-SRV-ATTR:host": "liberty", "addresses": {"private": [{"OS-EXT-IPS-MAC:mac_addr": "fa:16:3e:aa:1c:32", "version": 4, "addr": "10.0.0.6", "OS-EXT-IPS:type": "fixed"}]}, "links": [{"href": "http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee", "rel": "self"}, {"href": "http://192.168.200.208:8774/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee", "rel": "bookmark"}], "key_name": null, "image": {"id": "bf31eadd-c5f4-40f8-9ddb-30f688ca5e5f", "links": [{"href": "http://192.168.200.208:8774/ee84411cdb8148d28674b129ef482f31/images/bf31eadd-c5f4-40f8-9ddb-30f688ca5e5f", "rel": "bookmark"}]}, "OS-EXT-STS:task_state": null, "OS-EXT-STS:vm_state": "active", "OS-EXT-SRV-ATTR:instance_name": "instance-0000000a", "OS-SRV-USG:launched_at": "2016-03-02T17:28:45.000000", "OS-EXT-SRV-ATTR:hypervisor_hostname": "liberty", "flavor": {"id": "1", "links": [{"href": "http://192.168.200.208:8774/ee84411cdb8148d28674b129ef482f31/flavors/1", "rel": "bookmark"}]}, "id": "9165dbda-f54e-4186-b2cb-e6ca05ac53ee", "security_groups": [{"name": "default"}], "OS-SRV-USG:terminated_at": null, "OS-EXT-AZ:availability_zone": "nova", "user_id": "d9164a323be649c0a8c5c80fdd5bd585", "name": "test1", "created": "2016-03-02T17:28:34Z", "tenant_id": "ee84411cdb8148d28674b129ef482f31", "OS-DCF:diskConfig": "MANUAL", "os-extended-volumes:volumes_attached": [], "accessIPv4": "", "accessIPv6": "", "progress": 0, "OS-EXT-STS:power_state": 1, "config_drive": "", "metadata": {}}}
</pre>
<p>When we get the information, nova-api POST a request to nova-consoleauth for a VNC console.</p>
<pre>
POST http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee/action \
-H "User-Agent: python-novaclient" -H "Content-Type: application/json" \
-H "Accept: application/json" -H "X-Auth-Token: {SHA1}3b6262df9eaba5da33c1004805187806322201f1"\
-d '{"os-getVNCConsole": {"type": "novnc"}}'


DEBUG nova.api.openstack.wsgi [req-2201b9d6-5711-46d3-ac4d-669094f07527 \
d9164a323be649c0a8c5c80fdd5bd585 ee84411cdb8148d28674b129ef482f31 - - -] \
Action: 'action', calling method: , body: {"os-getVNCConsole": {"type": "novnc"}} \
_process_stack /usr/lib/python2.7/site-packages/nova/api/openstack/wsgi.py:789
</pre>
<p>Nova-consoleauth receives the console request and create an access URL while generates a temporary token for the vnc console.</p>
<pre>
INFO nova.consoleauth.manager [req-d4def6f9-1ab9-4626-b6a8-d81643ea5eb4 d9164a323be649c0a8c5c80fdd5bd585 ee84411cdb8148d28674b129ef482f31 - - -] \
Received Token: 3dfcd011-28f1-4cf3-8f5c-8cd18de4560e, \
{'instance_uuid': u'9165dbda-f54e-4186-b2cb-e6ca05ac53ee', \
'access_url': u'http://192.168.200.208:6080/vnc_auto.html?token=3dfcd011-28f1-4cf3-8f5c-8cd18de4560e',\
 'token': u'3dfcd011-28f1-4cf3-8f5c-8cd18de4560e', 'last_activity_at': 1456940028.356214, \
'internal_access_path': None, 'console_type': u'novnc', 'host': u'liberty', 'port': u'5900'}
</pre>
<p>Nova-consoleauth answer to nova-api who also answers to the user with an access URL.
This URL got the following content on it:</p>
<ul>
	<li>HTTP or HTTPS connection to nova-novncproxy IP</li>
	<li>Nova-novncproxy port</li>
	<li>A token to validate the VNC connection</li>
</ul>
<pre>RESP BODY: {"console": {"url": "http://192.168.200.208:6080/vnc_auto.html?token=3dfcd011-28f1-4cf3-8f5c-8cd18de4560e", "type": "novnc"}}

+-------+--------------------------------------------------------------------------------------+
| Type  | Url                                                                                  |
+-------+--------------------------------------------------------------------------------------+
| novnc | http://192.168.200.208:6080/vnc_auto.html?token=3dfcd011-28f1-4cf3-8f5c-8cd18de4560e |
+-------+--------------------------------------------------------------------------------------+
</pre>
<p>Until now, nova-novncproxy service can be stopped or isn’t used at all, is at this point the when proxy server enter into the game.
The user connects through a web browser to the nova-novncproxy’s URL provided by nova before.</p>
<pre>
DEBUG nova.console.websocketproxy [-] 192.168.200.1: \
new handler Process vmsg /usr/lib/python2.7/site-packages/websockify/websocket.py:828
</pre>
<p>Nova-vncproxy validate the issued token with the URL against nova-consoleauth.</p>
<pre>
nova.consoleauth.manager [req-399c7b58-700a-4779-b215-b12d10056813 - - - - -] \
Checking Token: 3dfcd011-28f1-4cf3-8f5c-8cd18de4560e, True
</pre>
<p>When the token is validated, nova-novncproxy maps compute’s node private IP (at this case port 5900) with the nova-novncproxy public IP(6080 port).</p>
<pre>
INFO nova.console.websocketproxy [req-399c7b58-700a-4779-b215-b12d10056813 - - - - -]\
   7: connect info: {u'instance_uuid': u'9165dbda-f54e-4186-b2cb-e6ca05ac53ee', u'\
internal_access_path': None, u'last_activity_at': 1456940028.356214, \
u'console_type': u'novnc', u'host': u'liberty', u'token': u'3dfcd011-28f1-4cf3-8f5c-8cd18de4560e', \
u'access_url': u'http://192.168.200.208:6080/vnc_auto.html?token=3dfcd011-28f1-4cf3-8f5c-8cd18de4560e'\
, u'port': u'5900'}
</pre>
<p>We can see how the python novncproxy process binds both IPs/port.</p>
<pre>
# ps aux | grep vnc
nova     14840  1.2  0.7 362096 41000 ?        S    18:53   0:14 /usr/bin/python2 /usr/bin/nova-novncproxy --web /usr/share/novnc/

# netstat -putona | grep 14840
tcp        0      0 192.168.200.208:6080    192.168.200.1:59918     ESTABLISHED 14840/python2        keepalive (3,13/0/0)
tcp        0      0 192.168.122.73:57764    192.168.122.73:5900     ESTABLISHED 14840/python2        keepalive (3,13/0/0)
</pre>
<p>Nova-novncproxy starts the connection between the instance and user’s browser session.</p>
<pre>
INFO nova.console.websocketproxy [req-399c7b58-700a-4779-b215-b12d10056813 - - - - -]\
   7: connecting to: liberty:5900
</pre>
<p>Libvirt connects a vnc console into the instance, as we can see at the xml provided by virsh command.
Also, port 5900 now is binded at qemu-kvm process.</p>

<pre><code>
# virsh dumpxml 2
...
&lt;graphics type='vnc' port='5900' autoport='yes' listen='0.0.0.0' keymap='en-us'&gt;
     &lt;listen type='address' address='0.0.0.0'/&gt;
   &lt;/graphics&gt;
...
</code></pre>
<pre># netstat -putona | grep 5900
tcp        0      0 0.0.0.0:5900            0.0.0.0:*               LISTEN      5910/qemu-kvm        off (0.00/0/0)
tcp        0      0 192.168.122.73:5900     192.168.122.73:57702    ESTABLISHED 5910/qemu-kvm        off (0.00/0/0)
tcp        0      0 192.168.122.73:57702    192.168.122.73:5900     ESTABLISHED 11118/python2        keepalive (1,92/0/0)
</pre>
<p>Nova-novncproxy keeps the connection alive until browser session ends.</p>
<pre>
DEBUG nova.console.websocketproxy [-] \
Reaing zombies, active child count is 1 vmsg /usr/lib/python2.7/site-packages/websockify/websocket.py:828
</pre>
<p>When a token is not valid while authenticating against nova-consoleauth, we can see a message like the following.</p>
<pre>
INFO nova.console.websocketproxy [req-9164b32d-3ce1-441b-82c7-6c23c9a354d0 - - - - -] \
handler exception: The token '3dfcd011-28f1-4cf3-8f5c-8cd18de4560e' is invalid or has expired
</pre>

<p>Regards.
 Eduardo Gonzalez</p>

      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        
        <p class="copyright">OpenStack things maintained by <a href="http://github.com/egonzalez90">egonzalez90</a></p>
        
        <p>Published with <a href="https://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    
  </body>

<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = 'https://egonzalez-1.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
</html>
