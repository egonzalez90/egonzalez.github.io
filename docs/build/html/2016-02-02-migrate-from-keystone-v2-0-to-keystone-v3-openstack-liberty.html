
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Migrate keystone v2.0 to keystone v3 OpenStack Liberty &#8212; egonzalez  documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Configure neutron DVR OpenStack Liberty" href="2016-01-27-configure-neutron-dvr-openstack-liberty.html" />
    <link rel="prev" title="Working with affinity/anti-affinity groups OpenStack" href="2016-02-15-working-with-affinityanti-affinity-groups-openstack.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="migrate-keystone-v2-0-to-keystone-v3-openstack-liberty">
<h1>Migrate keystone v2.0 to keystone v3 OpenStack Liberty<a class="headerlink" href="#migrate-keystone-v2-0-to-keystone-v3-openstack-liberty" title="Permalink to this headline">¶</a></h1>
<p>Migrate from keystone v2.0 to v3 isn’t as easy like just changing the
endpoints at the database, every service must be configured to
authenticate against keystone v3.</p>
<div class="line-block">
<div class="line">I’ve been working on that the past few days looking for a method, with
the purpose of facilitate operators life’s who need this kind of
migration.</div>
<div class="line">I have to thank Adam Young work, i followed his blog to make a first
configuration idea, after that, i configured all core services to make
use of keystone v3.</div>
<div class="line">If you want to check Adam’s blog, follow this link:
<a class="reference external" href="http://adam.younglogic.com/2015/05/rdo-v3-only/">http://adam.younglogic.com/2015/05/rdo-v3-only/</a></div>
</div>
<div class="line-block">
<div class="line">I used OpenStack Liberty installed with RDO packstack over CentOS 7
servers.</div>
<div class="line">The example IP used is <code class="docutils literal notranslate"><span class="pre">192.168.200.168</span></code>, use your own according
your needs.</div>
<div class="line">Password used for all services is <code class="docutils literal notranslate"><span class="pre">PASSWD1234</span></code>, use your own
password, you can locate your passwords at the packstack answer file.</div>
</div>
<p>Horizon</p>
<p>First we configure Horizon with keystone v3 as below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openstack</span><span class="o">-</span><span class="n">dashboard</span><span class="o">/</span><span class="n">local_settings</span>

<span class="n">OPENSTACK_API_VERSIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;identity&quot;</span><span class="p">:</span> <span class="mi">3</span>
<span class="p">}</span>

<span class="n">OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">OPENSTACK_KEYSTONE_DEFAULT_DOMAIN</span> <span class="o">=</span> <span class="s1">&#39;Default&#39;</span>
</pre></div>
</div>
<p>keystone</p>
<p>Check your current identity endpoints</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mysql</span>  <span class="o">--</span><span class="n">user</span> <span class="n">keystone_admin</span> <span class="o">--</span><span class="n">password</span><span class="o">=</span><span class="n">PASSWD1234</span>  <span class="n">keystone</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;select interface, url from endpoint where service_id =  (select id from service where service.type = &#39;identity&#39;);&quot;</span>
</pre></div>
</div>
<p>Change your public, admin and internal endpoints with v3 at the end,
instead of v2.0</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mysql</span>  <span class="o">--</span><span class="n">user</span> <span class="n">keystone_admin</span> <span class="o">--</span><span class="n">password</span><span class="o">=</span><span class="n">PASSWD1234</span>   <span class="n">keystone</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;update endpoint set   url  = &#39;http://192.168.200.178:5000/v3&#39; where  interface =&#39;internal&#39; and  service_id =  (select id from service where service.type = &#39;identity&#39;);&quot;</span>

<span class="n">mysql</span>  <span class="o">--</span><span class="n">user</span> <span class="n">keystone_admin</span> <span class="o">--</span><span class="n">password</span><span class="o">=</span><span class="n">PASSWD1234</span>   <span class="n">keystone</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;update endpoint set   url  = &#39;http://192.168.200.178:5000/v3&#39; where  interface =&#39;public&#39; and  service_id =  (select id from service where service.type = &#39;identity&#39;);&quot;</span>

<span class="n">mysql</span>  <span class="o">--</span><span class="n">user</span> <span class="n">keystone_admin</span> <span class="o">--</span><span class="n">password</span><span class="o">=</span><span class="n">PASSWD1234</span>   <span class="n">keystone</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;update endpoint set   url  = &#39;http://192.168.200.178:35357/v3&#39; where  interface =&#39;admin&#39; and  service_id =  (select id from service where service.type = &#39;identity&#39;);&quot;</span>
</pre></div>
</div>
<p>Ensure the endpoints are properly created</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mysql</span>  <span class="o">--</span><span class="n">user</span> <span class="n">keystone_admin</span> <span class="o">--</span><span class="n">password</span><span class="o">=</span><span class="n">KEYSTONE_DB_PW</span>   <span class="n">keystone</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;select interface, url from endpoint where service_id =  (select id from service where service.type = &#39;identity&#39;);&quot;</span>
</pre></div>
</div>
<p>Create a source file or edit keystonerc_admin with the following data</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="n">v3_keystone</span>

<span class="n">unset</span> <span class="n">OS_SERVICE_TOKEN</span>
<span class="n">export</span> <span class="n">OS_USERNAME</span><span class="o">=</span><span class="n">admin</span>
<span class="n">export</span> <span class="n">OS_PASSWORD</span><span class="o">=</span><span class="n">PASSWD1234</span>
<span class="n">export</span> <span class="n">OS_AUTH_URL</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.178</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span><span class="n">v3</span>
<span class="n">export</span> <span class="n">OS_PROJECT_NAME</span><span class="o">=</span><span class="n">admin</span>
<span class="n">export</span> <span class="n">OS_PROJECT_DOMAIN_NAME</span><span class="o">=</span><span class="n">Default</span>
<span class="n">export</span> <span class="n">OS_USER_DOMAIN_NAME</span><span class="o">=</span><span class="n">Default</span>
<span class="n">export</span> <span class="n">OS_REGION_NAME</span><span class="o">=</span><span class="n">RegionOne</span>
<span class="n">export</span> <span class="n">PS1</span><span class="o">=</span><span class="s1">&#39;[\u@\h \W(keystone_admin)]\$ &#39;</span>
<span class="n">export</span> <span class="n">OS_IDENTITY_API_VERSION</span><span class="o">=</span><span class="mi">3</span>
</pre></div>
</div>
<p>Comment both pipelines, in public_api and admin_api</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">keystone</span><span class="o">/</span><span class="n">keystone</span><span class="o">-</span><span class="n">dist</span><span class="o">-</span><span class="n">paste</span><span class="o">.</span><span class="n">ini</span>

<span class="p">[</span><span class="n">pipeline</span><span class="p">:</span><span class="n">public_api</span><span class="p">]</span>
<span class="c1"># The last item in this pipeline must be public_service or an equivalent</span>
<span class="c1"># application. It cannot be a filter.</span>
<span class="c1">#pipeline = sizelimit url_normalize request_id build_auth_context token_auth admin_token_auth json_body ec2_extension user_crud_extension public_service</span>

<span class="p">[</span><span class="n">pipeline</span><span class="p">:</span><span class="n">admin_api</span><span class="p">]</span>
<span class="c1"># The last item in this pipeline must be admin_service or an equivalent</span>
<span class="c1"># application. It cannot be a filter.</span>
<span class="c1">#pipeline = sizelimit url_normalize request_id build_auth_context token_auth admin_token_auth json_body ec2_extension s3_extension crud_extension admin_service</span>
</pre></div>
</div>
<p>Comment v2.0 entries in composite:main and admin sections.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">composite</span><span class="p">:</span><span class="n">main</span><span class="p">]</span>
<span class="n">use</span> <span class="o">=</span> <span class="n">egg</span><span class="p">:</span><span class="n">Paste</span><span class="c1">#urlmap</span>
<span class="c1">#/v2.0 = public_api</span>
<span class="o">/</span><span class="n">v3</span> <span class="o">=</span> <span class="n">api_v3</span>
<span class="o">/</span> <span class="o">=</span> <span class="n">public_version_api</span>

<span class="p">[</span><span class="n">composite</span><span class="p">:</span><span class="n">admin</span><span class="p">]</span>
<span class="n">use</span> <span class="o">=</span> <span class="n">egg</span><span class="p">:</span><span class="n">Paste</span><span class="c1">#urlmap</span>
<span class="c1">#/v2.0 = admin_api</span>
<span class="o">/</span><span class="n">v3</span> <span class="o">=</span> <span class="n">api_v3</span>
<span class="o">/</span> <span class="o">=</span> <span class="n">admin_version_api</span>
</pre></div>
</div>
<p>Restart httpd to apply changes</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">restart</span> <span class="n">httpd</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">Check whether keystone and horizon are properly working</div>
<div class="line">The command below should prompt an user list, if not, check
configuration in previous steps</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openstack</span> <span class="n">user</span> <span class="nb">list</span>
</pre></div>
</div>
<p>Glance</p>
<p>Edit the following files, with the content below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">glance</span><span class="o">/</span><span class="n">glance</span><span class="o">-</span><span class="n">api</span><span class="o">.</span><span class="n">conf</span>
<span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">glance</span><span class="o">/</span><span class="n">glance</span><span class="o">-</span><span class="n">registry</span><span class="o">.</span><span class="n">conf</span>
<span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">glance</span><span class="o">/</span><span class="n">glance</span><span class="o">-</span><span class="n">cache</span><span class="o">.</span><span class="n">conf</span>

<span class="p">[</span><span class="n">keystone_authtoken</span><span class="p">]</span>

<span class="n">auth_plugin</span> <span class="o">=</span> <span class="n">password</span>
<span class="n">auth_url</span> <span class="o">=</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.178</span><span class="p">:</span><span class="mi">35357</span>
<span class="n">username</span> <span class="o">=</span> <span class="n">glance</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">PASSWD1234</span>
<span class="n">project_name</span> <span class="o">=</span> <span class="n">services</span>
<span class="n">user_domain_name</span> <span class="o">=</span> <span class="n">Default</span>
<span class="n">project_domain_name</span> <span class="o">=</span> <span class="n">Default</span>
<span class="n">auth_uri</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.178</span><span class="p">:</span><span class="mi">5000</span>
</pre></div>
</div>
<p>Comment the following lines:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#auth_host=127.0.0.1</span>
<span class="c1">#auth_port=35357</span>
<span class="c1">#auth_protocol=http</span>
<span class="c1">#identity_uri=http://192.168.200.178:35357</span>
<span class="c1">#admin_user=glance</span>
<span class="c1">#admin_password=PASSWD1234</span>
<span class="c1">#admin_tenant_name=services</span>
</pre></div>
</div>
<p>Those lines, should be commented in all the other OpenStack core
services at keystone_authtoken section</p>
<p>Edit the files below and comment the lines inside keystone_authtoken
section.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">glance</span><span class="o">/</span><span class="n">glance</span><span class="o">-</span><span class="n">api</span><span class="o">-</span><span class="n">dist</span><span class="o">.</span><span class="n">conf</span>
<span class="n">vi</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">glance</span><span class="o">/</span><span class="n">glance</span><span class="o">-</span><span class="n">registry</span><span class="o">-</span><span class="n">dist</span><span class="o">.</span><span class="n">conf</span>

<span class="p">[</span><span class="n">keystone_authtoken</span><span class="p">]</span>
<span class="c1">#admin_tenant_name = %SERVICE_TENANT_NAME%</span>
<span class="c1">#admin_user = %SERVICE_USER%</span>
<span class="c1">#admin_password = %SERVICE_PASSWORD%</span>
<span class="c1">#auth_host = 127.0.0.1</span>
<span class="c1">#auth_port = 35357</span>
<span class="c1">#auth_protocol = http</span>
</pre></div>
</div>
<p>Restart glance services</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openstack</span><span class="o">-</span><span class="n">service</span> <span class="n">restart</span> <span class="n">glance</span>
</pre></div>
</div>
<p>Ensure glance service is working</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openstack</span> <span class="n">image</span> <span class="nb">list</span>
</pre></div>
</div>
<p>Nova</p>
<p>Edit the file below and comment the lines inside keystone_authtoken</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">nova</span><span class="o">/</span><span class="n">nova</span><span class="o">-</span><span class="n">dist</span><span class="o">.</span><span class="n">conf</span>

<span class="p">[</span><span class="n">keystone_authtoken</span><span class="p">]</span>
<span class="c1">#auth_host = 127.0.0.1</span>
<span class="c1">#auth_port = 35357</span>
<span class="c1">#auth_protocol = http</span>
</pre></div>
</div>
<p>Edit nova.conf and add the auth content inside keystone_authtoken, don’t
forget to comment the lines related to the last auth method, which were
commented in glance section.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nova</span><span class="o">/</span><span class="n">nova</span><span class="o">.</span><span class="n">conf</span>

<span class="p">[</span><span class="n">keystone_authtoken</span><span class="p">]</span>

<span class="n">auth_plugin</span> <span class="o">=</span> <span class="n">password</span>
<span class="n">auth_url</span> <span class="o">=</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.178</span><span class="p">:</span><span class="mi">35357</span>
<span class="n">username</span> <span class="o">=</span> <span class="n">nova</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">PASSWD1234</span>
<span class="n">project_name</span> <span class="o">=</span> <span class="n">services</span>
<span class="n">user_domain_name</span> <span class="o">=</span> <span class="n">Default</span>
<span class="n">project_domain_name</span> <span class="o">=</span> <span class="n">Default</span>
<span class="n">auth_uri</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.178</span><span class="p">:</span><span class="mi">5000</span>
</pre></div>
</div>
<p>Configure nova authentication against neutron</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">neutron</span><span class="p">]</span>

<span class="n">auth_plugin</span> <span class="o">=</span> <span class="n">password</span>
<span class="n">auth_url</span> <span class="o">=</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.178</span><span class="p">:</span><span class="mi">35357</span>
<span class="n">username</span> <span class="o">=</span> <span class="n">neutron</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">PASSWD1234</span>
<span class="n">project_name</span> <span class="o">=</span> <span class="n">services</span>
<span class="n">user_domain_name</span> <span class="o">=</span> <span class="n">Default</span>
<span class="n">project_domain_name</span> <span class="o">=</span> <span class="n">Default</span>
<span class="n">auth_uri</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.178</span><span class="p">:</span><span class="mi">5000</span>
</pre></div>
</div>
<p>Restart nova services to apply changes</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openstack</span><span class="o">-</span><span class="n">service</span> <span class="n">restart</span> <span class="n">nova</span>
</pre></div>
</div>
<p>Check if nova works</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openstack</span> <span class="n">hypervisor</span> <span class="nb">list</span>
</pre></div>
</div>
<p>Neutron</p>
<p>Comment or remove the following entries at api-paste.ini and add the new
version auth lines</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">neutron</span><span class="o">/</span><span class="n">api</span><span class="o">-</span><span class="n">paste</span><span class="o">.</span><span class="n">ini</span>

<span class="p">[</span><span class="nb">filter</span><span class="p">:</span><span class="n">authtoken</span><span class="p">]</span>
<span class="c1">#identity_uri=http://192.168.200.178:35357</span>
<span class="c1">#admin_user=neutron</span>
<span class="c1">#admin_password=PASSWD1234</span>
<span class="c1">#auth_uri=http://192.168.200.178:5000/v2.0</span>
<span class="c1">#admin_tenant_name=services</span>

<span class="n">auth_plugin</span> <span class="o">=</span> <span class="n">password</span>
<span class="n">auth_url</span> <span class="o">=</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.178</span><span class="p">:</span><span class="mi">35357</span>
<span class="n">username</span> <span class="o">=</span> <span class="n">neutron</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">PASSWD1234</span>
<span class="n">project_name</span> <span class="o">=</span> <span class="n">services</span>
<span class="n">user_domain_name</span> <span class="o">=</span> <span class="n">Default</span>
<span class="n">project_domain_name</span> <span class="o">=</span> <span class="n">Default</span>
<span class="n">auth_uri</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.178</span><span class="p">:</span><span class="mi">5000</span>
</pre></div>
</div>
<p>Configure v3 authentication for metadata service, remember comment the
old auth lines</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">neutron</span><span class="o">/</span><span class="n">metadata_agent</span><span class="o">.</span><span class="n">ini</span>

<span class="p">[</span><span class="n">DEFAULT</span><span class="p">]</span>

<span class="n">auth_plugin</span> <span class="o">=</span> <span class="n">password</span>
<span class="n">auth_url</span> <span class="o">=</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.178</span><span class="p">:</span><span class="mi">35357</span>
<span class="n">username</span> <span class="o">=</span> <span class="n">neutron</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">PASSWD1234</span>
<span class="n">project_name</span> <span class="o">=</span> <span class="n">services</span>
<span class="n">user_domain_name</span> <span class="o">=</span> <span class="n">Default</span>
<span class="n">project_domain_name</span> <span class="o">=</span> <span class="n">Default</span>
<span class="n">auth_uri</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.178</span><span class="p">:</span><span class="mi">5000</span>
</pre></div>
</div>
<p>Configure neutron server with v3 auth</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">neutron</span><span class="o">/</span><span class="n">neutron</span><span class="o">.</span><span class="n">conf</span>

<span class="n">nova_admin_auth_url</span> <span class="o">=</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.178</span><span class="p">:</span><span class="mi">5000</span>
<span class="c1"># nova_admin_tenant_id =1fb93c84c6474c5ea92c0ed5f7d4a6a7</span>
<span class="n">nova_admin_tenant_name</span> <span class="o">=</span> <span class="n">services</span>


<span class="p">[</span><span class="n">keystone_authtoken</span><span class="p">]</span>

<span class="n">auth_plugin</span> <span class="o">=</span> <span class="n">password</span>
<span class="n">auth_url</span> <span class="o">=</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.178</span><span class="p">:</span><span class="mi">35357</span>
<span class="n">username</span> <span class="o">=</span> <span class="n">neutron</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">PASSWD1234</span>
<span class="n">project_name</span> <span class="o">=</span> <span class="n">services</span>
<span class="n">user_domain_name</span> <span class="o">=</span> <span class="n">Default</span>
<span class="n">project_domain_name</span> <span class="o">=</span> <span class="n">Default</span>
<span class="n">auth_uri</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.178</span><span class="p">:</span><span class="mi">5000</span>

<span class="c1">#auth_uri = http://192.168.200.178:5000/v2.0</span>
<span class="c1">#identity_uri = http://192.168.200.178:35357</span>
<span class="c1">#admin_tenant_name = services</span>
<span class="c1">#admin_user = neutron</span>
<span class="c1">#admin_password = PASSWD1234</span>
</pre></div>
</div>
<p>Configure neutron auth against nova services</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">nova</span><span class="p">]</span>

<span class="n">auth_plugin</span> <span class="o">=</span> <span class="n">password</span>
<span class="n">auth_url</span> <span class="o">=</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.178</span><span class="p">:</span><span class="mi">35357</span>
<span class="n">username</span> <span class="o">=</span> <span class="n">nova</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">PASSWD1234</span>
<span class="n">project_name</span> <span class="o">=</span> <span class="n">services</span>
<span class="n">user_domain_name</span> <span class="o">=</span> <span class="n">Default</span>
<span class="n">project_domain_name</span> <span class="o">=</span> <span class="n">Default</span>
<span class="n">auth_uri</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.178</span><span class="p">:</span><span class="mi">5000</span>
</pre></div>
</div>
<p>Restart neutron services to apply changes</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openstack</span><span class="o">-</span><span class="n">service</span> <span class="n">restart</span> <span class="n">neutron</span>
</pre></div>
</div>
<p>Test correct neutron funtionality</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openstack</span> <span class="n">network</span> <span class="nb">list</span>
</pre></div>
</div>
<p>Cinder</p>
<p>Edit api-paste.ini with the following content</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">cinder</span><span class="o">/</span><span class="n">api</span><span class="o">-</span><span class="n">paste</span><span class="o">.</span><span class="n">ini</span>

<span class="p">[</span><span class="nb">filter</span><span class="p">:</span><span class="n">authtoken</span><span class="p">]</span>
<span class="n">paste</span><span class="o">.</span><span class="n">filter_factory</span> <span class="o">=</span> <span class="n">keystonemiddleware</span><span class="o">.</span><span class="n">auth_token</span><span class="p">:</span><span class="n">filter_factory</span>
<span class="n">auth_plugin</span> <span class="o">=</span> <span class="n">password</span>
<span class="n">auth_url</span> <span class="o">=</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.178</span><span class="p">:</span><span class="mi">35357</span>
<span class="n">username</span> <span class="o">=</span> <span class="n">cinder</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">PASSWD1234</span>
<span class="n">project_name</span> <span class="o">=</span> <span class="n">services</span>
<span class="n">user_domain_name</span> <span class="o">=</span> <span class="n">Default</span>
<span class="n">project_domain_name</span> <span class="o">=</span> <span class="n">Default</span>
<span class="n">auth_uri</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.178</span><span class="p">:</span><span class="mi">5000</span>
<span class="c1">#admin_tenant_name=services</span>
<span class="c1">#auth_uri=http://192.168.200.178:5000/v2.0</span>
<span class="c1">#admin_user=cinder</span>
<span class="c1">#identity_uri=http://192.168.200.178:35357</span>
<span class="c1">#admin_password=PASSWD1234</span>
</pre></div>
</div>
<p>Restart cinder services to apply changes</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openstack</span><span class="o">-</span><span class="n">service</span> <span class="n">restart</span> <span class="n">cinder</span>
</pre></div>
</div>
<p>Ensure cinder is properly running</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openstack</span> <span class="n">volume</span> <span class="n">create</span> <span class="o">--</span><span class="n">size</span> <span class="mi">1</span> <span class="n">testvolume</span>
<span class="n">openstack</span> <span class="n">volume</span> <span class="nb">list</span>
</pre></div>
</div>
<p>Now, you can check if nova is working fine, create an instance and
ensure it is in ACTIVE state.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openstack</span> <span class="n">server</span> <span class="n">create</span> <span class="o">--</span><span class="n">flavor</span> <span class="n">m1</span><span class="o">.</span><span class="n">tiny</span> <span class="o">--</span><span class="n">image</span> <span class="n">cirros</span> <span class="o">--</span><span class="n">nic</span> <span class="n">net</span><span class="o">-</span><span class="nb">id</span><span class="o">=</span><span class="n">a1aa6336</span><span class="o">-</span><span class="mi">9</span><span class="n">ae2</span><span class="o">-</span><span class="mi">4</span><span class="n">ffb</span><span class="o">-</span><span class="mi">99</span><span class="n">f5</span><span class="o">-</span><span class="mi">1</span><span class="n">b6d1130989c</span> <span class="n">testinstance</span>
<span class="n">openstack</span> <span class="n">server</span> <span class="nb">list</span>
</pre></div>
</div>
<p>If any error occurs, review configuration files</p>
<p>Swift</p>
<p>Configure proxy server auth agains keystone v3</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">swift</span><span class="o">/</span><span class="n">proxy</span><span class="o">-</span><span class="n">server</span><span class="o">.</span><span class="n">conf</span>

<span class="p">[</span><span class="nb">filter</span><span class="p">:</span><span class="n">authtoken</span><span class="p">]</span>
<span class="n">log_name</span> <span class="o">=</span> <span class="n">swift</span>
<span class="n">signing_dir</span> <span class="o">=</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">swift</span>
<span class="n">paste</span><span class="o">.</span><span class="n">filter_factory</span> <span class="o">=</span> <span class="n">keystonemiddleware</span><span class="o">.</span><span class="n">auth_token</span><span class="p">:</span><span class="n">filter_factory</span>
<span class="n">auth_plugin</span> <span class="o">=</span> <span class="n">password</span>
<span class="n">auth_url</span> <span class="o">=</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.178</span><span class="p">:</span><span class="mi">35357</span>
<span class="n">username</span> <span class="o">=</span> <span class="n">swift</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">PASSWD1234</span>
<span class="n">project_name</span> <span class="o">=</span> <span class="n">services</span>
<span class="n">user_domain_name</span> <span class="o">=</span> <span class="n">Default</span>
<span class="n">project_domain_name</span> <span class="o">=</span> <span class="n">Default</span>
<span class="n">auth_uri</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.178</span><span class="p">:</span><span class="mi">5000</span>

<span class="c1">#auth_uri = http://192.168.200.178:5000/v2.0</span>
<span class="c1">#identity_uri = http://192.168.200.178:35357</span>
<span class="c1">#admin_tenant_name = services</span>
<span class="c1">#admin_user = swift</span>
<span class="c1">#admin_password = PASSWD1234</span>
<span class="n">delay_auth_decision</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">cache</span> <span class="o">=</span> <span class="n">swift</span><span class="o">.</span><span class="n">cache</span>
<span class="n">include_service_catalog</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
<p>Restart swift services to apply changes</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openstack</span><span class="o">-</span><span class="n">service</span> <span class="n">restart</span> <span class="n">swift</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">Swift commands must be issued with python-openstackclient instead of
swiftclient</div>
<div class="line">If done with swiftclient a -V 3 option must be used in order to avoid
issues</div>
</div>
<p>Check if swift works fine</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openstack</span> <span class="n">container</span> <span class="n">create</span> <span class="n">testcontainer</span>
</pre></div>
</div>
<p>Ceilometer</p>
<p>Configure ceilometer service in order to authenticate agains keystone v3</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">keystone_authtoken</span><span class="p">]</span>

<span class="n">auth_plugin</span> <span class="o">=</span> <span class="n">password</span>
<span class="n">auth_url</span> <span class="o">=</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.178</span><span class="p">:</span><span class="mi">35357</span>
<span class="n">username</span> <span class="o">=</span> <span class="n">ceilometer</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">PASSWD1234</span>
<span class="n">project_name</span> <span class="o">=</span> <span class="n">services</span>
<span class="n">user_domain_name</span> <span class="o">=</span> <span class="n">Default</span>
<span class="n">project_domain_name</span> <span class="o">=</span> <span class="n">Default</span>
<span class="n">auth_uri</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.178</span><span class="p">:</span><span class="mi">5000</span>

<span class="p">[</span><span class="n">service_credentials</span><span class="p">]</span>

<span class="n">os_auth_url</span> <span class="o">=</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">controller</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span><span class="n">v3</span>
<span class="n">os_username</span> <span class="o">=</span> <span class="n">ceilometer</span>
<span class="n">os_tenant_name</span> <span class="o">=</span> <span class="n">services</span>
<span class="n">os_password</span> <span class="o">=</span> <span class="n">PASSWD1234</span>
<span class="n">os_endpoint_type</span> <span class="o">=</span> <span class="n">internalURL</span>
<span class="n">os_region_name</span> <span class="o">=</span> <span class="n">RegionOne</span>
</pre></div>
</div>
<p>Restart ceilometer services</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openstack</span><span class="o">-</span><span class="n">service</span> <span class="n">restart</span> <span class="n">ceilometer</span>
</pre></div>
</div>
<p>Check ceilometer funtionality</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceilometer</span> <span class="n">statistics</span> <span class="o">-</span><span class="n">m</span> <span class="n">memory</span>
</pre></div>
</div>
<p>Heat</p>
<p>Configure Heat authentication, since trusts are not stable use password
auth method</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">heat</span><span class="o">/</span><span class="n">heat</span><span class="o">.</span><span class="n">conf</span>

<span class="c1"># Allowed values: password, trusts</span>
<span class="c1">#deferred_auth_method = trusts</span>
<span class="n">deferred_auth_method</span> <span class="o">=</span> <span class="n">password</span>
</pre></div>
</div>
<p>Configure auth_uri and keystone_authtoken section</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># From heat.common.config</span>
<span class="c1">#</span>
<span class="c1"># Unversioned keystone url in format like http://0.0.0.0:5000. (string value)</span>
<span class="c1">#auth_uri =</span>
<span class="n">auth_uri</span> <span class="o">=</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.178</span><span class="p">:</span><span class="mi">5000</span>

<span class="p">[</span><span class="n">keystone_authtoken</span><span class="p">]</span>

<span class="n">auth_plugin</span> <span class="o">=</span> <span class="n">password</span>
<span class="n">auth_url</span> <span class="o">=</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.178</span><span class="p">:</span><span class="mi">35357</span>
<span class="n">username</span> <span class="o">=</span> <span class="n">heat</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">PASSWD1234</span>
<span class="n">project_name</span> <span class="o">=</span> <span class="n">services</span>
<span class="n">user_domain_name</span> <span class="o">=</span> <span class="n">Default</span>
<span class="n">project_domain_name</span> <span class="o">=</span> <span class="n">Default</span>
<span class="n">auth_uri</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.178</span><span class="p">:</span><span class="mi">5000</span>

<span class="c1">#admin_user=heat</span>
<span class="c1">#admin_password=PASSWD1234</span>
<span class="c1">#admin_tenant_name=services</span>
<span class="c1">#identity_uri=http://192.168.200.178:35357</span>
<span class="c1">#auth_uri=http://192.168.200.178:5000/v2.0</span>
</pre></div>
</div>
<p>Comment or remove heat-dist auth entries in order to avoid conflicts
with your config files</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">heat</span><span class="o">/</span><span class="n">heat</span><span class="o">-</span><span class="n">dist</span><span class="o">.</span><span class="n">conf</span>

<span class="p">[</span><span class="n">keystone_authtoken</span><span class="p">]</span>
<span class="c1">#auth_host = 127.0.0.1</span>
<span class="c1">#auth_port = 35357</span>
<span class="c1">#auth_protocol = http</span>
<span class="c1">#auth_uri = http://127.0.0.1:5000/v2.0</span>
<span class="c1">#signing_dir = /tmp/keystone-signing-heat</span>
</pre></div>
</div>
<p>Restart heat services to apply changes</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openstack</span><span class="o">-</span><span class="n">service</span> <span class="n">restart</span> <span class="n">heat</span>
</pre></div>
</div>
<p>Ensure heat authentication is properly configured with a simple heat
template</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">heat</span> <span class="n">stack</span><span class="o">-</span><span class="n">create</span> <span class="o">--</span><span class="n">template</span><span class="o">-</span><span class="n">file</span> <span class="n">sample</span><span class="o">.</span><span class="n">yaml</span> <span class="n">teststack</span>
</pre></div>
</div>
<p>Most issues occurs in the authentication between nova and neutron
services, if instances does not launch as expected, review [nova] and
[neutron] sections.</p>
<p>Best regards, Eduardo Gonzalez</p>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">egonzalez</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Post:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="2017-08-28-openstack-tacker-and-service-function-chaining-sfc-with-kolla.html">OpenStack tacker and service function chaining sfc with kolla</a></li>
<li class="toctree-l1"><a class="reference internal" href="2017-02-22-deploy-openstack-designate-with-kolla-ansible.html">Deploy OpenStack designate with kolla-ansible</a></li>
<li class="toctree-l1"><a class="reference internal" href="2017-01-31-openstack-keystone-zero-downtime-upgrade-process-n-to-o.html">OpenStack keystone zero downtime upgrade process newton to ocata</a></li>
<li class="toctree-l1"><a class="reference internal" href="2016-10-31-to-conditional-or-to-skip-that-is-the-ansible-question.html">To conditional or to skip, that’s the Ansible question</a></li>
<li class="toctree-l1"><a class="reference internal" href="2016-07-12-spacewalk-red-hat-satellite-v5-in-a-docker-container-poc.html">Spacewalk Red Hat Satellite v5 in a Docker container PoC</a></li>
<li class="toctree-l1"><a class="reference internal" href="2016-07-04-midonet-integration-with-openstack-mitaka.html">Midonet integration with OpenStack Mitaka</a></li>
<li class="toctree-l1"><a class="reference internal" href="2016-06-15-rally-openstack-benchmarking-from-docker-containers.html">Rally OpenStack benchmarking from Docker containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="2016-06-06-opendaylight-in-a-docker-container.html">OpenDaylight in a Docker container</a></li>
<li class="toctree-l1"><a class="reference internal" href="2016-04-24-openstack-kolla-deployment-from-rdo-packages.html">OpenStack kolla deployment from RDO packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="2016-03-24-magnum-in-rdo-openstack-liberty-manual-installation-from-source-code.html">Magnum in RDO OpenStack Liberty manual installation from source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="2016-03-17-ceph-ansible-baremetal-deployment.html">Ceph Ansible baremetal deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="2016-03-02-nova-vnc-flows-under-the-hood.html">Nova VNC flows under the hood</a></li>
<li class="toctree-l1"><a class="reference internal" href="2016-02-24-ansible-ini_file-module-simplifying-your-devops-life.html">Ansible INI file module, simplifying your DevOps life</a></li>
<li class="toctree-l1"><a class="reference internal" href="2016-02-15-working-with-affinityanti-affinity-groups-openstack.html">Working with affinity/anti-affinity groups OpenStack</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Migrate keystone v2.0 to keystone v3 OpenStack Liberty</a></li>
<li class="toctree-l1"><a class="reference internal" href="2016-01-27-configure-neutron-dvr-openstack-liberty.html">Configure neutron DVR OpenStack Liberty</a></li>
<li class="toctree-l1"><a class="reference internal" href="2016-01-14-openstack-segregation-with-availability-zones-and-host-aggregates.html">OpenStack segregation with availability zones and host aggregates</a></li>
<li class="toctree-l1"><a class="reference internal" href="2015-12-23-nova-docker-driver.html">Nova Docker driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="2015-12-14-murano-in-rdo-openstack-manual-installation.html">Murano in RDO OpenStack manual installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="2015-09-08-ceph-radosgw-admin-ops-how-to-use-it.html">Ceph RadosGW admin Ops, how to use it</a></li>
<li class="toctree-l1"><a class="reference internal" href="2015-08-13-multiple-store-locations-for-glance-images.html">Multiple store locations for glance images</a></li>
<li class="toctree-l1"><a class="reference internal" href="2015-07-02-list-all-tenants-belonging-an-user.html">List all tenants belonging an user</a></li>
<li class="toctree-l1"><a class="reference internal" href="2015-03-24-load-balancer-as-a-service-lbaas.html">Load balancer as a service OpenStack LbaaS</a></li>
<li class="toctree-l1"><a class="reference internal" href="2015-03-16-openstack-nova-api-start-error-could-not-bind-to-0-0-0-0-address-already-in-use.html">OpenStack nova APi start error, could not bind to 0.0.0.0 address all ready in use</a></li>
<li class="toctree-l1"><a class="reference internal" href="2015-03-09-delete-openstack-neutron-networks-solution-to-unable-to-complete-operation-on-subnet.html">Delete OpenStack neutron networks, fix to unable to complete operation on subnet</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="2016-02-15-working-with-affinityanti-affinity-groups-openstack.html" title="previous chapter">Working with affinity/anti-affinity groups OpenStack</a></li>
      <li>Next: <a href="2016-01-27-configure-neutron-dvr-openstack-liberty.html" title="next chapter">Configure neutron DVR OpenStack Liberty</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Eduardo Gonzalez.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/2016-02-02-migrate-from-keystone-v2-0-to-keystone-v3-openstack-liberty.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>