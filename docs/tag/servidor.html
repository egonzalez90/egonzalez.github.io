<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>OpenStack Stuff - servidor</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">OpenStack Stuff </a></h1>
                <nav><ul>
                    <li><a href="/category/linux.html">Linux</a></li>
                    <li><a href="/category/linux-openstack.html">Linux, OpenStack</a></li>
                    <li><a href="/category/linux-openstack-various.html">Linux, OpenStack, Various</a></li>
                    <li><a href="/category/linux-various.html">Linux, Various</a></li>
                    <li><a href="/category/linux-virtualizacion.html">Linux, Virtualizacion</a></li>
                    <li><a href="/category/misc.html">misc</a></li>
                    <li><a href="/category/openstack.html">OpenStack</a></li>
                    <li><a href="/category/reflexiones.html">Reflexiones</a></li>
                    <li><a href="/category/various.html">Various</a></li>
                    <li><a href="/category/virtualizacion.html">Virtualizacion</a></li>
                </ul>
                </nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/analisis-forense-servidor-atacado.html">Análisis Forense Servidor Atacado</a></h1>
<footer class="post-info">
        <span>Wed 15 October 2014</span>
<span>| tags: <a href="/tag/analisis.html">analisis</a><a href="/tag/atacado.html">atacado</a><a href="/tag/ataque.html">ataque</a><a href="/tag/bash_history.html">bash_history</a><a href="/tag/busqueda.html">busqueda</a><a href="/tag/ethical.html">ethical</a><a href="/tag/forense.html">forense</a><a href="/tag/hacking.html">Hacking</a><a href="/tag/informatica.html">informatica</a><a href="/tag/last.html">last</a><a href="/tag/linux.html">linux</a><a href="/tag/lsattr.html">lsattr</a><a href="/tag/mtime.html">mtime</a><a href="/tag/netstat.html">netstat</a><a href="/tag/ps.html">ps</a><a href="/tag/rpm-va.html">rpm -Va</a><a href="/tag/seguridad.html">Seguridad</a><a href="/tag/servidor.html">servidor</a><a href="/tag/strace.html">strace</a><a href="/tag/top.html">top</a><a href="/tag/unix.html">unix</a><a href="/tag/vulnerable.html">vulnerable</a></span>
</footer><!-- /.post-info --><p>Esta guía te proporcionara las bases para investigar servidores que su
seguridad ha sido comprometida.</p>
<p>Veremos  los diferentes modos para determinar:</p>
<ul>
<li>Punto de entrada</li>
<li>Origen del ataque</li>
<li>Archivos comprometidos</li>
<li>Nivel de acceso obtenido por el atacante</li>
<li>Investigación de pruebas y rastros dejados por los atacantes</li>
</ul>
<!--more-->

<p>Son muchos los puntos de entradas que un servidor Linux/Unix puede
tener, pero es importante que método se ha usado para determinar el daño
que ha podido hacer en a máquina y/o otros servidores conectados entre
sí.</p>
<p>La mejor forma de arreglar un servidor comprometido es re instalar el
sistema operativo y restaurar los datos importantes desde una copia de
seguridad, pero es importante investigar el servidor afectado para
conocer el punto de entrada y así poder parchearlo en la reinstalación
del SO.</p>
<h1>Documentación</h1>
<p>Cuando te enteras que un sistema bajo tu control puede haber sido
comprometido, debes de intentar obtener la mayor información posible del
denunciante. Entre ellas:</p>
<ul>
<li>Cuando se encontró el problema inicial</li>
<li>La hora estimada del ataque</li>
<li>Se ha modificado el servidor desde el ataque</li>
<li>Alguna cosa más que el denunciante considere importante</li>
</ul>
<p>NOTA: Si estás pensando en involucrar a las fuerzas de la ley, realizar
denuncias, es muy importante que no se realice ninguna acción en el
servidor. Este debe quedar en su estado actual a un equipo de
informática forense para la búsqueda de pruebas.</p>
<p>Si vas a proceder a la investigación, documenta toda lo que encuentres
en el servidor.</p>
<h1>Herramientas usadas en la investigación</h1>
<p>En un escenario ideal para un atacante, todos los archivos de log se
habrán borrado dejando su rastro limpio. Por suerte estos casos no se
suelen dar, y aunque los ataques estén automatizados, siempre hay alguna
pista desde la que encontrar información sobre cómo se ha realizado el
ataque, si es ataque web básico o un ataque que compromete el acceso
root.</p>
<p>Aquí tienes algunas herramientas con las que podrás investigar posibles
rastros para analizar el sistema.</p>
<h2>last</h2>
<p>Esta herramienta listara las últimas sesiones de usuario, con este
comando podrás ver horas de sesión, IP, nombre de usuario, etc.</p>
<p>Un numero exagerado de direcciones IP en los archivos de log
/var/log/messages o /var/log/secure puede indicar que el atacante
realizo un ataque por fuerza bruta, eso reflejara en el comando last la
hora de cuando consiguió dicho acceso al servidor</p>
<h2>ls -lart</h2>
<p>Este comando nos mostrara una lista de archivos y directorios ordenados
por fecha según la última modificación. Esto nos permitirá saber que ha
sido modificado o añadido comprobándolo con las fechas del ataque.</p>
<h2>netstat -na</h2>
<p>Eso nos listara las conexiones a la escucha existentes. Nos podrá
revelar posibles backdoors o servicios que no deberían estar en escucha,
los cuales pueden ser causa de alguno de los ficheros</p>
<h2>alias</h2>
<p>Este comando nos mostrara los alias de comandos, es posible que un
atacante cree alias para que al ejecutar determinado comando se ejecute
otro.</p>
<h2>ps -wauxef</h2>
<p>Este comando nos es muy útil a la hora de detectar procesos erróneos en
escucha, además también nos listara otros procesos como los del usuario
www. lsof | grep \&lt;pid> puede ser usado para encontrar que archivos
está utilizando determinado proceso. Igualmente con cat
/proc/\&lt;pid>/cmdline puedes saber dónde está el archivo que controla el
proceso.</p>
<h2>bash_history</h2>
<p>Mediante este comando obtendremos el historial de los comandos
ejecutados desde los diferentes usuarios. El archivo se encuentra en la
carpeta / root y el /home/ de cada usuario. Es oculto</p>
<h2>top</h2>
<p>A veces un proceso malicioso causa extremo uso de CPU causando problemas
en el entorno, suele estar situado en el principio de la lista. Todo
proceso que este causando un consumo excesivo de CPU debe ser
considerado sospechoso</p>
<h2>strace -p</h2>
<p>Este comando se ejecutara sobre procesos sospechosos, el cual nos dará
mucha información sobre que está realizando.</p>
<p>En algunos casos, este comando no nos proporcionara ninguna información
real, debido a que se pueden haber modificado los binarios para que la
salida del comando no muestre lo que debería, complicando la
investigación del ataque. Para ello investigaremos que dichos binarios
no están trojanizados:</p>
<h2>rpm -Va</h2>
<p>Este comando comprobara la información de los paquetes instalados con
los metadatos de la base de datos rpm. Entre otras cosas, compara el
tamaño, suma de verificación MD5, permisos, tipo, propietario y grupo.
Cualquier modificación del paquete original será mostrada.</p>
<p>Cuando se ejecuta este comando, es importante si alguno de los paquetes
marcados como modificados esta en alguno de los siguientes directorios,
de ser así, puede significar que se está usando una versión trojanizada
del binario, por lo que no se puede fiar de la salida del comando.</p>
<h4>/bin</h4>
<h4>/sbin</h4>
<h4>/usr/bin</h4>
<h4>/usr/sbin</h4>
<h2>rpm -qa</h2>
<p>Este comando te mostrara cuales son los últimos paquetes instalado en
orden cronológico. En cualquier caso, si el acceso root ha sido
comprometido, la base de datos rpm puede haber sido modificada y no ser
fiable</p>
<h2>lsattr</h2>
<p>En el caso de que el atacante haya conseguido acceso root y trojanizar
determinados binarios, puede que haya establecido dicho binario como
inmutable, por lo que no podrás reinstalar una versión limpia del
binario. Los directorios más comunes son:</p>
<h4>/bin</h4>
<h4>/sbin</h4>
<h4>/usr/bin</h4>
<h4>/usr/sbin</h4>
<p>También deberías de buscar por otros directorios como /etc, /root, /tmp,
etc.</p>
<p>Un ejemplo del binario de ps establecido como inmutable es este:</p>
<h4>-------i----- /bin/ps</h4>
<h2>find / mtime 5</h2>
<p>Con este comando buscaras archivos que han sido modificados en los
últimos 5 días, puedes cambiar el digito numérico si sabes las fechas
exactas, así afinaras más las búsqueda y evitaras ver archivos
modificados que no tengan interés en la investigación.</p>
<h1>Directorios comunes donde se encuentran los exploits</h1>
<p>Comprueba los directorios que Apache comúnmente puede escribir sus
archivos temporales</p>
<h4>ls -al /tmp</h4>
<h4>ls -al /var/tmp</h4>
<h4>ls -al /dev/shm</h4>
<p>Si tienes algun fichero con todos los permisos 777, sospecha de el.</p>
<p>Comprueba que los ficheros ocultos no tengan permisos de ejecución.</p>
<h1>Encontrando el punto de acceso</h1>
<p>Si has encontrado algo con la información anterior, quiere decir que ya
sabes más o menos cuando el ataque se ha realizado, de qué forma y
contra que. Ahora ya podrás investigar sobre los logs de acceso a la
página web por la fecha por la que se produjo el ataque. También debes
mirar en los archivos /var/log/* en los cuales encontraras información
de accesos, del sistema, etc.</p>
<p>Si tienes alguna aplicación afectada que también guarde logs, puedes
investigar sobre ellos para buscar más información sobre el atacante.</p>
<p>Debido a un ataque en uno de los servidores que administro tuve que
lidiar con este tipo de investigación forense. Encontré poca información
al respecto, hasta que encontré la siguiente web, que definitivamente me
ayudo realmente.</p>
<p>https://community.rackspace.com/general/f/34/t/75</p>
<p>Estoy realmente agradecido al creador de esa información, por eso me
decidí a traducirla (no literalmente) para que los que sufran de ese
mismo problema y no sepan ingles puedan descubrir que les han hecho en
su servidor.</p>
<p>En la misma web, tienen un ejemplo práctico de como el encontró su
webshell en phpmyadmin, os recomiendo que la lean.</p>
<p>Infinitamente agradecido.</p>
<p>Un saludo</p><p><a href="/analisis-forense-servidor-atacado.html#disqus_thread">comments</a></p>                </article>
<p class="paginator">
    Page 1 / 1
</p>
            </aside><!-- /#featured -->
            </ol><!-- /#posts-list -->
            </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="https://twitter.com/egongu90">Twitter</a></li>
                            <li><a href="https://www.linkedin.com/in/eduardogonzalezgutierrez">Linkedin</a></li>
                            <li><a href="https://github.com/egonzalez90">Github</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme <a href="https://github.com/blueicefield/pelican-blueidea/">blueidea</a>, inspired by the default theme.</p>
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'egonzalez-1';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>