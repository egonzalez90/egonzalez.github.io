<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>OpenStack Stuff - Linux, OpenStack, Various</title><link href="https://egonzalez90.github.io/" rel="alternate"></link><link href="https://egonzalez90.github.io/feeds/linux-openstack-various.atom.xml" rel="self"></link><id>https://egonzalez90.github.io/</id><updated>2017-01-31T17:00:00+01:00</updated><entry><title>OpenStack Keystone Zero-Downtime upgrade process (N to O)</title><link href="https://egonzalez90.github.io/openstack-keystone-zero-downtime-upgrade-process-n-to-o.html" rel="alternate"></link><published>2017-01-31T17:00:00+01:00</published><updated>2017-01-31T17:00:00+01:00</updated><author><name>egongu90</name></author><id>tag:egonzalez90.github.io,2017-01-31:/openstack-keystone-zero-downtime-upgrade-process-n-to-o.html</id><summary type="html">&lt;p&gt;This blog post will show Keystone upgrade procedure from OpenStack
Newton to Ocata release with zero-downtime.&lt;/p&gt;
&lt;p&gt;In the case of doing this in production, please read release notes,
ensure a proper configuration, do database backups and test the upgrade
a thousand times.&lt;/p&gt;
&lt;p&gt;Keystone upgrade will need to stop one node â€¦&lt;/p&gt;</summary><content type="html">&lt;p&gt;This blog post will show Keystone upgrade procedure from OpenStack
Newton to Ocata release with zero-downtime.&lt;/p&gt;
&lt;p&gt;In the case of doing this in production, please read release notes,
ensure a proper configuration, do database backups and test the upgrade
a thousand times.&lt;/p&gt;
&lt;p&gt;Keystone upgrade will need to stop one node in order to use it as
upgrade server.&lt;br&gt;
In the case of a PoC this is not an issue, but in a production
environment, Keystone loads may be intensive and stopping a node for a
while may decrease other nodes performance more than expected.&lt;br&gt;
For this reason I prefer orchestrate the upgrade from an external
Docker container. With this method all nodes will be fully running
almost all the time.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;New container won't start any service, just will sync the database
    schema with new Keystone version avoiding stop a node to orchestrate
    the upgrade.&lt;/li&gt;
&lt;li&gt;The Docker image is provided by OpenStack Kolla project, if already
    using Kolla this upgrade won't be needed as kolla-ansible already
    provide an upgrade method.&lt;/li&gt;
&lt;li&gt;At the moment of writing of this blog, Ocata packages were not
    released into stable repositories. For this reason I use DLRN
    repositories.&lt;/li&gt;
&lt;li&gt;If Ocata is released please do not use DLRN, use stable packages
    instead.&lt;/li&gt;
&lt;li&gt;Use stable Ocata Docker image if available with tag 4.0.x and will
    avoid repository configuration and package upgrades.&lt;/li&gt;
&lt;li&gt;NOTE: Upgrade may need more steps depending of your own
    configuration, i.e, if using fernet token more steps are necessary
    during the upgrade.&lt;/li&gt;
&lt;li&gt;All Keystone nodes are behind HAproxy.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;Prepare the upgrade&lt;/h3&gt;
&lt;p&gt;Start Keystone Docker container with host networking (needed to
communicate with database nodes directly) and root user (needed to
install packages).&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;(host)# docker run -ti --net host -u 0 kolla/centos-binary-keystone:3.0.2 bash
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Download Delorean CentOS trunk repositories&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;(keystone-upgrade)# curl -Lo /etc/yum.repos.d/delorean.repo http://buildlogs.centos.org/centos/7/cloud/x86_64/rdo-trunk-master-tested/delorean.repo
(keystone-upgrade)# curl -Lo /etc/yum.repos.d/delorean-deps.repo http://trunk.rdoproject.org/centos7/delorean-deps.repo
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Disable Newton repository&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;(keystone-upgrade)# yum-config-manager --disable centos-openstack-newton
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Ensure Newton repository is not longer used by the system&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;(keystone-upgrade)# yum repolist | grep -i openstack
delorean                        delorean-openstack-glance-0bf9d805886c2  565+255
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Update all packages in the Docker container to bump keystone version to
Ocata.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;(keystone-upgrade)# yum clean all &amp;amp;&amp;amp; yum update -y
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Configure keystone.conf file, this are my settings. Review you
configuration and ensure all is correctly, otherwise may cause issues in
the database.&lt;br&gt;
An important option is default_domain_id, this value is for backward
compatible with users created under default domain.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;keystone&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;upgrade&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="err"&gt;#&lt;/span&gt; &lt;span class="n"&gt;egrep&lt;/span&gt; &lt;span class="o"&gt;^&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="o"&gt;^&lt;/span&gt;&lt;span class="err"&gt;#&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;etc&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keystone&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keystone&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;conf&lt;/span&gt; 
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;DEFAULT&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="n"&gt;debug&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;False&lt;/span&gt;
&lt;span class="n"&gt;log_file&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;var&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keystone&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keystone&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;log&lt;/span&gt;
&lt;span class="n"&gt;secure_proxy_ssl_header&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;HTTP_X_FORWARDED_PROTO&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;database&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="n"&gt;connection&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;mysql&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="nl"&gt;pymysql&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="c1"&gt;//keystone:ickvaHC9opkwbz8z8sy28aLiFNezc7Z6Fm34frcB@192.168.100.10:3306/keystone&lt;/span&gt;
&lt;span class="n"&gt;max_retries&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;cache&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="n"&gt;backend&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;oslo_cache&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;memcache_pool&lt;/span&gt;
&lt;span class="n"&gt;enabled&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;True&lt;/span&gt;
&lt;span class="n"&gt;memcache_servers&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mf"&gt;192.168.100.215&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;11211&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mf"&gt;192.168.100.170&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;11211&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;identity&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="n"&gt;default_domain_id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;default&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;token&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="n"&gt;provider&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;uuid&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Check migrate version in the database.&lt;br&gt;
As you will notice, contract/data_migrate/expand are in the same
version&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;(mariadb)# mysql -ukeystone -pickvaHC9opkwbz8z8sy28aLiFNezc7Z6Fm34frcB -h192.168.100.10 keystone -e &amp;quot;select * from migrate_version;&amp;quot; 
Warning: Using a password on the command line interface can be insecure.
+-----------------------+--------------------------------------------------------------------------+---------+
| repository_id         | repository_path                                                          | version |
+-----------------------+--------------------------------------------------------------------------+---------+
| keystone              | /usr/lib/python2.7/site-packages/keystone/common/sql/migrate_repo        |     109 |
| keystone_contract     | /usr/lib/python2.7/site-packages/keystone/common/sql/contract_repo       |       4 |
| keystone_data_migrate | /usr/lib/python2.7/site-packages/keystone/common/sql/data_migration_repo |       4 |
| keystone_expand       | /usr/lib/python2.7/site-packages/keystone/common/sql/expand_repo         |       4 |
+-----------------------+--------------------------------------------------------------------------+---------+
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Before start upgrading the database schema, you will need add SUPER
privileges in the database to keystone user or set
log_bin_trust_function_creators to True.&lt;br&gt;
In my opinion is safer set the value to True, I don't want keystone
with SUPER privileges.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;(mariadb)# mysql -uroot -pnkLMrBibfMTRqOGBAP3UAxdO4kOFfEaPptGM5UDL -h192.168.100.10 keystone -e &amp;quot;set global log_bin_trust_function_creators=1;&amp;quot;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Now use Rally, tempest or some tool to test/benchmarch keystone service
during upgrade.&lt;br&gt;
If don't want to use one of those tools, just use this for command.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;(host)# for i in {1000..6000} ; do openstack user create --password $i $i; done
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Start Upgrade&lt;/h3&gt;
&lt;p&gt;Check database status before upgrade using Doctor, this may raise issues
in the configuration. Some of them may be ignored(Please, ensure is not
an issue before ignoring).&lt;br&gt;
As example, I'm not using fernet tokens and errors appear about missing
folder.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;(keystone-upgrade)# keystone-manage doctor
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Remove obsoleted tokens&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;(keystone-upgrade)# keystone-manage token_flush
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Now, expand the database schema to latest version, in keystone.log can
see the status.&lt;br&gt;
Check in the logs if some error is raised before jump to the next step.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;(keystone-upgrade)# keystone-manage db_sync --expand


2017-01-31 13:42:02.772 306 INFO migrate.versioning.api [-] 4 -&amp;gt; 5... 
2017-01-31 13:42:03.004 306 INFO migrate.versioning.api [-] done
2017-01-31 13:42:03.005 306 INFO migrate.versioning.api [-] 5 -&amp;gt; 6... 
2017-01-31 13:42:03.310 306 INFO migrate.versioning.api [-] done
2017-01-31 13:42:03.310 306 INFO migrate.versioning.api [-] 6 -&amp;gt; 7... 
2017-01-31 13:42:03.670 306 INFO migrate.versioning.api [-] done
2017-01-31 13:42:03.671 306 INFO migrate.versioning.api [-] 7 -&amp;gt; 8... 
2017-01-31 13:42:03.984 306 INFO migrate.versioning.api [-] done
2017-01-31 13:42:03.985 306 INFO migrate.versioning.api [-] 8 -&amp;gt; 9... 
2017-01-31 13:42:04.185 306 INFO migrate.versioning.api [-] done
2017-01-31 13:42:04.185 306 INFO migrate.versioning.api [-] 9 -&amp;gt; 10... 
2017-01-31 13:42:07.202 306 INFO migrate.versioning.api [-] done
2017-01-31 13:42:07.202 306 INFO migrate.versioning.api [-] 10 -&amp;gt; 11... 
2017-01-31 13:42:07.481 306 INFO migrate.versioning.api [-] done
2017-01-31 13:42:07.481 306 INFO migrate.versioning.api [-] 11 -&amp;gt; 12... 
2017-01-31 13:42:11.334 306 INFO migrate.versioning.api [-] done
2017-01-31 13:42:11.334 306 INFO migrate.versioning.api [-] 12 -&amp;gt; 13... 
2017-01-31 13:42:11.560 306 INFO migrate.versioning.api [-] done
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;After expand the database, migrate it to latest version.&lt;br&gt;
Ensure there are not errors in Keystone logs.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;(keystone-upgrade)# keystone-manage db_sync --migrate

#keystone.log
2017-01-31 13:42:58.771 314 INFO migrate.versioning.api [-] 4 -&amp;gt; 5... 
2017-01-31 13:42:58.943 314 INFO migrate.versioning.api [-] done
2017-01-31 13:42:58.943 314 INFO migrate.versioning.api [-] 5 -&amp;gt; 6... 
2017-01-31 13:42:59.143 314 INFO migrate.versioning.api [-] done
2017-01-31 13:42:59.143 314 INFO migrate.versioning.api [-] 6 -&amp;gt; 7... 
2017-01-31 13:42:59.340 314 INFO migrate.versioning.api [-] done
2017-01-31 13:42:59.341 314 INFO migrate.versioning.api [-] 7 -&amp;gt; 8... 
2017-01-31 13:42:59.698 314 INFO migrate.versioning.api [-] done
2017-01-31 13:42:59.699 314 INFO migrate.versioning.api [-] 8 -&amp;gt; 9... 
2017-01-31 13:42:59.852 314 INFO migrate.versioning.api [-] done
2017-01-31 13:42:59.852 314 INFO migrate.versioning.api [-] 9 -&amp;gt; 10... 
2017-01-31 13:43:00.135 314 INFO migrate.versioning.api [-] done
2017-01-31 13:43:00.135 314 INFO migrate.versioning.api [-] 10 -&amp;gt; 11... 
2017-01-31 13:43:00.545 314 INFO migrate.versioning.api [-] done
2017-01-31 13:43:00.545 314 INFO migrate.versioning.api [-] 11 -&amp;gt; 12... 
2017-01-31 13:43:00.703 314 INFO migrate.versioning.api [-] done
2017-01-31 13:43:00.703 314 INFO migrate.versioning.api [-] 12 -&amp;gt; 13... 
2017-01-31 13:43:00.854 314 INFO migrate.versioning.api [-] done
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Now, see migrate_version table, you will notice that expand and
data_migrate are in the latest version, but contract still in the
previous version.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;(mariadb)# mysql -ukeystone -pickvaHC9opkwbz8z8sy28aLiFNezc7Z6Fm34frcB -h192.168.100.10 keystone -e &amp;quot;select * from migrate_version;&amp;quot;
+-----------------------+--------------------------------------------------------------------------+---------+
| repository_id         | repository_path                                                          | version |
+-----------------------+--------------------------------------------------------------------------+---------+
| keystone              | /usr/lib/python2.7/site-packages/keystone/common/sql/migrate_repo        |     109 |
| keystone_contract     | /usr/lib/python2.7/site-packages/keystone/common/sql/contract_repo       |       4 |
| keystone_data_migrate | /usr/lib/python2.7/site-packages/keystone/common/sql/data_migration_repo |      13 |
| keystone_expand       | /usr/lib/python2.7/site-packages/keystone/common/sql/expand_repo         |      13 |
+-----------------------+--------------------------------------------------------------------------+---------+
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Every Keystone node, one by one&lt;/h3&gt;
&lt;p&gt;Go to keystone nodes.&lt;br&gt;
Stop Keystone services, in my case using wsgi inside Apache&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;(keystone_nodes)# systemctl stop httpd
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Configure Ocata repositories as made in the Docker container.&lt;br&gt;
Update packages, if you have Keystone sharing the node with other
OpenStack service, do not update all packages as it will break other
services.&lt;br&gt;
Update only required packages.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;(keystone_nodes)# yum clean all &amp;amp;&amp;amp; yum update -y
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Configure Keystone configuration file to the desired state. Your
configuration may change.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;keystone_nodes&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="err"&gt;#&lt;/span&gt; &lt;span class="n"&gt;egrep&lt;/span&gt; &lt;span class="o"&gt;^&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="o"&gt;^&lt;/span&gt;&lt;span class="err"&gt;#&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;etc&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keystone&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keystone&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;conf&lt;/span&gt; 
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;DEFAULT&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="n"&gt;debug&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;False&lt;/span&gt;
&lt;span class="n"&gt;log_file&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;var&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keystone&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keystone&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;log&lt;/span&gt;
&lt;span class="n"&gt;secure_proxy_ssl_header&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;HTTP_X_FORWARDED_PROTO&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;database&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="n"&gt;connection&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;mysql&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="nl"&gt;pymysql&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="c1"&gt;//keystone:ickvaHC9opkwbz8z8sy28aLiFNezc7Z6Fm34frcB@192.168.100.10:3306/keystone&lt;/span&gt;
&lt;span class="n"&gt;max_retries&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;cache&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="n"&gt;backend&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;oslo_cache&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;memcache_pool&lt;/span&gt;
&lt;span class="n"&gt;enabled&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;True&lt;/span&gt;
&lt;span class="n"&gt;memcache_servers&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mf"&gt;192.168.100.215&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;11211&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mf"&gt;192.168.100.170&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;11211&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;identity&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="n"&gt;default_domain_id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;default&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;token&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="n"&gt;provider&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;uuid&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Start Keystone service.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;(keystone_nodes)# systemctl start httpd
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Finish Upgrade&lt;/h3&gt;
&lt;p&gt;After all the nodes are updated to latest version (please ensure all
nodes are using latest packages, if not will fail).&lt;br&gt;
Contract Keystone database schema.&lt;br&gt;
Look at keystone.log for errors.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;(keystone-upgrade)# keystone-manage db_sync --contract

keystone.log

2017-01-31 13:57:52.164 322 INFO migrate.versioning.api [-] 4 -&amp;gt; 5... 
2017-01-31 13:57:52.379 322 INFO migrate.versioning.api [-] done
2017-01-31 13:57:52.379 322 INFO migrate.versioning.api [-] 5 -&amp;gt; 6... 
2017-01-31 13:57:52.969 322 INFO migrate.versioning.api [-] done
2017-01-31 13:57:52.969 322 INFO migrate.versioning.api [-] 6 -&amp;gt; 7... 
2017-01-31 13:57:53.462 322 INFO migrate.versioning.api [-] done
2017-01-31 13:57:53.462 322 INFO migrate.versioning.api [-] 7 -&amp;gt; 8... 
2017-01-31 13:57:53.793 322 INFO migrate.versioning.api [-] done
2017-01-31 13:57:53.793 322 INFO migrate.versioning.api [-] 8 -&amp;gt; 9... 
2017-01-31 13:57:53.957 322 INFO migrate.versioning.api [-] done
2017-01-31 13:57:53.957 322 INFO migrate.versioning.api [-] 9 -&amp;gt; 10... 
2017-01-31 13:57:54.111 322 INFO migrate.versioning.api [-] done
2017-01-31 13:57:54.112 322 INFO migrate.versioning.api [-] 10 -&amp;gt; 11... 
2017-01-31 13:57:54.853 322 INFO migrate.versioning.api [-] done
2017-01-31 13:57:54.853 322 INFO migrate.versioning.api [-] 11 -&amp;gt; 12... 
2017-01-31 13:57:56.727 322 INFO migrate.versioning.api [-] done
2017-01-31 13:57:56.728 322 INFO migrate.versioning.api [-] 12 -&amp;gt; 13... 
2017-01-31 13:57:59.529 322 INFO migrate.versioning.api [-] done
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Now if we look at migrate_version table, will see that contract version
is latest and match with the other version (Ensure all are in the same
version).&lt;br&gt;
This means the database upgrade has been successfully implemented.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;(mariadb)# mysql -ukeystone -pickvaHC9opkwbz8z8sy28aLiFNezc7Z6Fm34frcB -h192.168.100.10 keystone -e &amp;quot;select * from migrate_version;&amp;quot;
+-----------------------+--------------------------------------------------------------------------+---------+
| repository_id         | repository_path                                                          | version |
+-----------------------+--------------------------------------------------------------------------+---------+
| keystone              | /usr/lib/python2.7/site-packages/keystone/common/sql/migrate_repo        |     109 |
| keystone_contract     | /usr/lib/python2.7/site-packages/keystone/common/sql/contract_repo       |      13 |
| keystone_data_migrate | /usr/lib/python2.7/site-packages/keystone/common/sql/data_migration_repo |      13 |
| keystone_expand       | /usr/lib/python2.7/site-packages/keystone/common/sql/expand_repo         |      13 |
+-----------------------+--------------------------------------------------------------------------+---------+
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Remove log_bin_trust_function_creators value.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;(mariadb)# mysql -uroot -pnkLMrBibfMTRqOGBAP3UAxdO4kOFfEaPptGM5UDL -h192.168.100.10 keystone -e &amp;quot;set global log_bin_trust_function_creators=0;&amp;quot;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;After finish the upgrade, Rally tests should not have any error. **If
using HAproxy for load balance Keystone service, some errors may happen
due a connection drop while stopping Keystone service and re-balance to
other Keystone node. This can be avoided putting the node to update in
Maintenance Mode in HAproxy backend.&lt;/p&gt;
&lt;p&gt;Have to thank Keystone team in #openstack-keystone IRC channel for the
help provided with a couple of issues.&lt;/p&gt;
&lt;p&gt;Regards, Eduardo Gonzalez&lt;/p&gt;</content><category term="contract"></category><category term="database"></category><category term="docker"></category><category term="Downtime"></category><category term="expand"></category><category term="keystone"></category><category term="kolla"></category><category term="migrate"></category><category term="newton"></category><category term="ocata"></category><category term="openstack"></category><category term="schema"></category><category term="Upgrade"></category><category term="Zero"></category><category term="zero-downtime"></category></entry></feed>