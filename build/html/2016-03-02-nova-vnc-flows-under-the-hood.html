
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Nova VNC flows under the hood &#8212; egonzalez  documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Ansible INI file module, simplifying your DevOps life" href="2016-02-24-ansible-ini_file-module-simplifying-your-devops-life.html" />
    <link rel="prev" title="Ceph Ansible baremetal deployment" href="2016-03-17-ceph-ansible-baremetal-deployment.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="nova-vnc-flows-under-the-hood">
<h1>Nova VNC flows under the hood<a class="headerlink" href="#nova-vnc-flows-under-the-hood" title="Permalink to this headline">¶</a></h1>
<p>Most OpenStack deployments has a VNC console implemented with
nova-novncproxy. This service gives the final user the ability to log
into their instances in a web based method through a browser.</p>
<p>At this post i’m going to show how a vnc console request works under the
hood while using the following command or lauching a vnc session through
Horizon.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># nova get-vnc-console INSTANCE novnc</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">First of all, a user connects to NOVA and issues a VNC console request
for an instance. Nova API needs to validate the user issuing an
authentication request to keystone.</div>
<div class="line">The user receives a token with nova’s endpoint URL in the catalog,
with that endpoint and the token, the user makes a request against
nova calling for a VNC session.</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.208</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span><span class="n">v2</span><span class="o">.</span><span class="mi">0</span> <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Accept: application/json&quot;</span> <span class="o">-</span><span class="n">H</span> \
<span class="s2">&quot;User-Agent: python-keystoneclient&quot;</span>

<span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.208</span><span class="p">:</span><span class="mi">8774</span><span class="o">/</span><span class="n">v2</span><span class="o">/</span> <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;User-Agent: python-novaclient&quot;</span> <span class="o">-</span><span class="n">H</span> \
<span class="s2">&quot;Accept: application/json&quot;</span> <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;X-Auth-Token: </span><span class="si">{SHA1}</span><span class="s2">3b6262df9eaba5da33c1004805187806322201f1&quot;</span>
</pre></div>
</div>
<p>If a name instead of an instance ID is used in the request, Nova need to
check his database to match that name with his corresponding ID, as we
can see in the following request.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>GET http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers?name=test1 \
-H &quot;User-Agent: python-novaclient&quot; -H &quot;Accept: application/json&quot; \
-H &quot;X-Auth-Token: {SHA1}3b6262df9eaba5da33c1004805187806322201f1&quot;

RESP BODY: {&quot;servers&quot;: [{&quot;id&quot;: &quot;9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;, \
&quot;links&quot;: [{&quot;href&quot;: &quot;http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;, &quot;rel&quot;: &quot;self&quot;},\
 {&quot;href&quot;: &quot;http://192.168.200.208:8774/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;, \
&quot;rel&quot;: &quot;bookmark&quot;}], &quot;name&quot;: &quot;test1&quot;}]}
</pre></div>
</div>
<p>Once the ID is matched with the name, Nova check information about the
instance (I thought it was to validate if is in ACTIVE status, but i
realized that even when is in STOPPED status the request is made it
anyway).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.208</span><span class="p">:</span><span class="mi">8774</span><span class="o">/</span><span class="n">v2</span><span class="o">/</span><span class="n">ee84411cdb8148d28674b129ef482f31</span><span class="o">/</span><span class="n">servers</span><span class="o">/</span><span class="mi">9165</span><span class="n">dbda</span><span class="o">-</span><span class="n">f54e</span><span class="o">-</span><span class="mi">4186</span><span class="o">-</span><span class="n">b2cb</span><span class="o">-</span><span class="n">e6ca05ac53ee</span>\
 <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;User-Agent: python-novaclient&quot;</span> <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Accept: application/json&quot;</span> \
 <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;X-Auth-Token: </span><span class="si">{SHA1}</span><span class="s2">3b6262df9eaba5da33c1004805187806322201f1&quot;</span>

<span class="n">RESP</span> <span class="n">BODY</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;server&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ACTIVE&quot;</span><span class="p">,</span> <span class="s2">&quot;updated&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-03-02T17:28:45Z&quot;</span><span class="p">,</span> <span class="s2">&quot;hostId&quot;</span><span class="p">:</span> <span class="s2">&quot;ca3a874dcad9079fcc6a0b10b0e2efaa394bc66b5335197fdd9c2498&quot;</span><span class="p">,</span> <span class="s2">&quot;OS-EXT-SRV-ATTR:host&quot;</span><span class="p">:</span> <span class="s2">&quot;liberty&quot;</span><span class="p">,</span> <span class="s2">&quot;addresses&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;private&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;OS-EXT-IPS-MAC:mac_addr&quot;</span><span class="p">:</span> <span class="s2">&quot;fa:16:3e:aa:1c:32&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;addr&quot;</span><span class="p">:</span> <span class="s2">&quot;10.0.0.6&quot;</span><span class="p">,</span> <span class="s2">&quot;OS-EXT-IPS:type&quot;</span><span class="p">:</span> <span class="s2">&quot;fixed&quot;</span><span class="p">}]},</span> <span class="s2">&quot;links&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;</span><span class="p">,</span> <span class="s2">&quot;rel&quot;</span><span class="p">:</span> <span class="s2">&quot;self&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;http://192.168.200.208:8774/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;</span><span class="p">,</span> <span class="s2">&quot;rel&quot;</span><span class="p">:</span> <span class="s2">&quot;bookmark&quot;</span><span class="p">}],</span> <span class="s2">&quot;key_name&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;bf31eadd-c5f4-40f8-9ddb-30f688ca5e5f&quot;</span><span class="p">,</span> <span class="s2">&quot;links&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;http://192.168.200.208:8774/ee84411cdb8148d28674b129ef482f31/images/bf31eadd-c5f4-40f8-9ddb-30f688ca5e5f&quot;</span><span class="p">,</span> <span class="s2">&quot;rel&quot;</span><span class="p">:</span> <span class="s2">&quot;bookmark&quot;</span><span class="p">}]},</span> <span class="s2">&quot;OS-EXT-STS:task_state&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span> <span class="s2">&quot;OS-EXT-STS:vm_state&quot;</span><span class="p">:</span> <span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="s2">&quot;OS-EXT-SRV-ATTR:instance_name&quot;</span><span class="p">:</span> <span class="s2">&quot;instance-0000000a&quot;</span><span class="p">,</span> <span class="s2">&quot;OS-SRV-USG:launched_at&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-03-02T17:28:45.000000&quot;</span><span class="p">,</span> <span class="s2">&quot;OS-EXT-SRV-ATTR:hypervisor_hostname&quot;</span><span class="p">:</span> <span class="s2">&quot;liberty&quot;</span><span class="p">,</span> <span class="s2">&quot;flavor&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;links&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;http://192.168.200.208:8774/ee84411cdb8148d28674b129ef482f31/flavors/1&quot;</span><span class="p">,</span> <span class="s2">&quot;rel&quot;</span><span class="p">:</span> <span class="s2">&quot;bookmark&quot;</span><span class="p">}]},</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;</span><span class="p">,</span> <span class="s2">&quot;security_groups&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">}],</span> <span class="s2">&quot;OS-SRV-USG:terminated_at&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span> <span class="s2">&quot;OS-EXT-AZ:availability_zone&quot;</span><span class="p">:</span> <span class="s2">&quot;nova&quot;</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;d9164a323be649c0a8c5c80fdd5bd585&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;test1&quot;</span><span class="p">,</span> <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-03-02T17:28:34Z&quot;</span><span class="p">,</span> <span class="s2">&quot;tenant_id&quot;</span><span class="p">:</span> <span class="s2">&quot;ee84411cdb8148d28674b129ef482f31&quot;</span><span class="p">,</span> <span class="s2">&quot;OS-DCF:diskConfig&quot;</span><span class="p">:</span> <span class="s2">&quot;MANUAL&quot;</span><span class="p">,</span> <span class="s2">&quot;os-extended-volumes:volumes_attached&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;accessIPv4&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;accessIPv6&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;progress&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;OS-EXT-STS:power_state&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;config_drive&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{}}}</span>
</pre></div>
</div>
<p>When we get the information, nova-api POST a request to nova-consoleauth
for a VNC console.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">200.208</span><span class="p">:</span><span class="mi">8774</span><span class="o">/</span><span class="n">v2</span><span class="o">/</span><span class="n">ee84411cdb8148d28674b129ef482f31</span><span class="o">/</span><span class="n">servers</span><span class="o">/</span><span class="mi">9165</span><span class="n">dbda</span><span class="o">-</span><span class="n">f54e</span><span class="o">-</span><span class="mi">4186</span><span class="o">-</span><span class="n">b2cb</span><span class="o">-</span><span class="n">e6ca05ac53ee</span><span class="o">/</span><span class="n">action</span> \
<span class="o">-</span><span class="n">H</span> <span class="s2">&quot;User-Agent: python-novaclient&quot;</span> <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span> \
<span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Accept: application/json&quot;</span> <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;X-Auth-Token: </span><span class="si">{SHA1}</span><span class="s2">3b6262df9eaba5da33c1004805187806322201f1&quot;</span>\
<span class="o">-</span><span class="n">d</span> <span class="s1">&#39;{&quot;os-getVNCConsole&quot;: {&quot;type&quot;: &quot;novnc&quot;}}&#39;</span>


<span class="n">DEBUG</span> <span class="n">nova</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">openstack</span><span class="o">.</span><span class="n">wsgi</span> <span class="p">[</span><span class="n">req</span><span class="o">-</span><span class="mi">2201</span><span class="n">b9d6</span><span class="o">-</span><span class="mi">5711</span><span class="o">-</span><span class="mi">46</span><span class="n">d3</span><span class="o">-</span><span class="n">ac4d</span><span class="o">-</span><span class="mi">669094</span><span class="n">f07527</span> \
<span class="n">d9164a323be649c0a8c5c80fdd5bd585</span> <span class="n">ee84411cdb8148d28674b129ef482f31</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span><span class="p">]</span> \
<span class="n">Action</span><span class="p">:</span> <span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="n">calling</span> <span class="n">method</span><span class="p">:</span> <span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;os-getVNCConsole&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;novnc&quot;</span><span class="p">}}</span> \
<span class="n">_process_stack</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="o">.</span><span class="mi">7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">nova</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">openstack</span><span class="o">/</span><span class="n">wsgi</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">789</span>
</pre></div>
</div>
<p>Nova-consoleauth receives the console request and create an access URL
while generates a temporary token for the vnc console.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INFO</span> <span class="n">nova</span><span class="o">.</span><span class="n">consoleauth</span><span class="o">.</span><span class="n">manager</span> <span class="p">[</span><span class="n">req</span><span class="o">-</span><span class="n">d4def6f9</span><span class="o">-</span><span class="mi">1</span><span class="n">ab9</span><span class="o">-</span><span class="mi">4626</span><span class="o">-</span><span class="n">b6a8</span><span class="o">-</span><span class="n">d81643ea5eb4</span> <span class="n">d9164a323be649c0a8c5c80fdd5bd585</span> <span class="n">ee84411cdb8148d28674b129ef482f31</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span><span class="p">]</span> \
<span class="n">Received</span> <span class="n">Token</span><span class="p">:</span> <span class="mi">3</span><span class="n">dfcd011</span><span class="o">-</span><span class="mi">28</span><span class="n">f1</span><span class="o">-</span><span class="mi">4</span><span class="n">cf3</span><span class="o">-</span><span class="mi">8</span><span class="n">f5c</span><span class="o">-</span><span class="mi">8</span><span class="n">cd18de4560e</span><span class="p">,</span> \
<span class="p">{</span><span class="s1">&#39;instance_uuid&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;9165dbda-f54e-4186-b2cb-e6ca05ac53ee&#39;</span><span class="p">,</span> \
<span class="s1">&#39;access_url&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;http://192.168.200.208:6080/vnc_auto.html?token=3dfcd011-28f1-4cf3-8f5c-8cd18de4560e&#39;</span><span class="p">,</span>\
 <span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;3dfcd011-28f1-4cf3-8f5c-8cd18de4560e&#39;</span><span class="p">,</span> <span class="s1">&#39;last_activity_at&#39;</span><span class="p">:</span> <span class="mf">1456940028.356214</span><span class="p">,</span> \
<span class="s1">&#39;internal_access_path&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;console_type&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;novnc&#39;</span><span class="p">,</span> <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;liberty&#39;</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;5900&#39;</span><span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">Nova-consoleauth answer to nova-api who also answers to the user with
an access URL.</div>
<div class="line">This URL got the following content on it:</div>
</div>
<ul class="simple">
<li>HTTP or HTTPS connection to nova-novncproxy IP</li>
<li>Nova-novncproxy port</li>
<li>A token to validate the VNC connection</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>RESP BODY: {&quot;console&quot;: {&quot;url&quot;: &quot;http://192.168.200.208:6080/vnc_auto.html?token=3dfcd011-28f1-4cf3-8f5c-8cd18de4560e&quot;, &quot;type&quot;: &quot;novnc&quot;}}

+-------+--------------------------------------------------------------------------------------+
| Type  | Url                                                                                  |
+-------+--------------------------------------------------------------------------------------+
| novnc | http://192.168.200.208:6080/vnc_auto.html?token=3dfcd011-28f1-4cf3-8f5c-8cd18de4560e |
+-------+--------------------------------------------------------------------------------------+
</pre></div>
</div>
<div class="line-block">
<div class="line">Until now, nova-novncproxy service can be stopped or isn’t used at
all, is at this point the when proxy server enter into the game.</div>
<div class="line">The user connects through a web browser to the nova-novncproxy’s URL
provided by nova before.</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DEBUG</span> <span class="n">nova</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">websocketproxy</span> <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">200.1</span><span class="p">:</span> \
<span class="n">new</span> <span class="n">handler</span> <span class="n">Process</span> <span class="n">vmsg</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="o">.</span><span class="mi">7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">websockify</span><span class="o">/</span><span class="n">websocket</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">828</span>
</pre></div>
</div>
<p>Nova-vncproxy validate the issued token with the URL against
nova-consoleauth.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nova</span><span class="o">.</span><span class="n">consoleauth</span><span class="o">.</span><span class="n">manager</span> <span class="p">[</span><span class="n">req</span><span class="o">-</span><span class="mi">399</span><span class="n">c7b58</span><span class="o">-</span><span class="mi">700</span><span class="n">a</span><span class="o">-</span><span class="mi">4779</span><span class="o">-</span><span class="n">b215</span><span class="o">-</span><span class="n">b12d10056813</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span><span class="p">]</span> \
<span class="n">Checking</span> <span class="n">Token</span><span class="p">:</span> <span class="mi">3</span><span class="n">dfcd011</span><span class="o">-</span><span class="mi">28</span><span class="n">f1</span><span class="o">-</span><span class="mi">4</span><span class="n">cf3</span><span class="o">-</span><span class="mi">8</span><span class="n">f5c</span><span class="o">-</span><span class="mi">8</span><span class="n">cd18de4560e</span><span class="p">,</span> <span class="kc">True</span>
</pre></div>
</div>
<p>When the token is validated, nova-novncproxy maps compute’s node private
IP (at this case port 5900) with the nova-novncproxy public IP(6080
port).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INFO</span> <span class="n">nova</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">websocketproxy</span> <span class="p">[</span><span class="n">req</span><span class="o">-</span><span class="mi">399</span><span class="n">c7b58</span><span class="o">-</span><span class="mi">700</span><span class="n">a</span><span class="o">-</span><span class="mi">4779</span><span class="o">-</span><span class="n">b215</span><span class="o">-</span><span class="n">b12d10056813</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span><span class="p">]</span>\
   <span class="mi">7</span><span class="p">:</span> <span class="n">connect</span> <span class="n">info</span><span class="p">:</span> <span class="p">{</span><span class="sa">u</span><span class="s1">&#39;instance_uuid&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;9165dbda-f54e-4186-b2cb-e6ca05ac53ee&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="se">\</span>
<span class="s1">internal_access_path&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;last_activity_at&#39;</span><span class="p">:</span> <span class="mf">1456940028.356214</span><span class="p">,</span> \
<span class="sa">u</span><span class="s1">&#39;console_type&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;novnc&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;liberty&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;3dfcd011-28f1-4cf3-8f5c-8cd18de4560e&#39;</span><span class="p">,</span> \
<span class="sa">u</span><span class="s1">&#39;access_url&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;http://192.168.200.208:6080/vnc_auto.html?token=3dfcd011-28f1-4cf3-8f5c-8cd18de4560e&#39;</span>\
<span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;5900&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>We can see how the python novncproxy process binds both IPs/port.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># ps aux | grep vnc
nova     14840  1.2  0.7 362096 41000 ?        S    18:53   0:14 /usr/bin/python2 /usr/bin/nova-novncproxy --web /usr/share/novnc/

# netstat -putona | grep 14840
tcp        0      0 192.168.200.208:6080    192.168.200.1:59918     ESTABLISHED 14840/python2        keepalive (3,13/0/0)
tcp        0      0 192.168.122.73:57764    192.168.122.73:5900     ESTABLISHED 14840/python2        keepalive (3,13/0/0)
</pre></div>
</div>
<p>Nova-novncproxy starts the connection between the instance and user’s
browser session.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INFO</span> <span class="n">nova</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">websocketproxy</span> <span class="p">[</span><span class="n">req</span><span class="o">-</span><span class="mi">399</span><span class="n">c7b58</span><span class="o">-</span><span class="mi">700</span><span class="n">a</span><span class="o">-</span><span class="mi">4779</span><span class="o">-</span><span class="n">b215</span><span class="o">-</span><span class="n">b12d10056813</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span><span class="p">]</span>\
   <span class="mi">7</span><span class="p">:</span> <span class="n">connecting</span> <span class="n">to</span><span class="p">:</span> <span class="n">liberty</span><span class="p">:</span><span class="mi">5900</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">Libvirt connects a vnc console into the instance, as we can see at the
xml provided by virsh command.</div>
<div class="line">Also, port 5900 now is binded at qemu-kvm process.</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># virsh dumpxml 2</span>
<span class="o">...</span>
<span class="o">&lt;</span><span class="n">graphics</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;vnc&#39;</span> <span class="n">port</span><span class="o">=</span><span class="s1">&#39;5900&#39;</span> <span class="n">autoport</span><span class="o">=</span><span class="s1">&#39;yes&#39;</span> <span class="n">listen</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span> <span class="n">keymap</span><span class="o">=</span><span class="s1">&#39;en-us&#39;</span><span class="o">&gt;</span>
     <span class="o">&lt;</span><span class="n">listen</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;address&#39;</span> <span class="n">address</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="o">/&gt;</span>
   <span class="o">&lt;/</span><span class="n">graphics</span><span class="o">&gt;</span>
<span class="o">...</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># netstat -putona | grep 5900</span>
<span class="n">tcp</span>        <span class="mi">0</span>      <span class="mi">0</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">5900</span>            <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="o">*</span>               <span class="n">LISTEN</span>      <span class="mi">5910</span><span class="o">/</span><span class="n">qemu</span><span class="o">-</span><span class="n">kvm</span>        <span class="n">off</span> <span class="p">(</span><span class="mf">0.00</span><span class="o">/</span><span class="mi">0</span><span class="o">/</span><span class="mi">0</span><span class="p">)</span>
<span class="n">tcp</span>        <span class="mi">0</span>      <span class="mi">0</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">122.73</span><span class="p">:</span><span class="mi">5900</span>     <span class="mf">192.168</span><span class="o">.</span><span class="mf">122.73</span><span class="p">:</span><span class="mi">57702</span>    <span class="n">ESTABLISHED</span> <span class="mi">5910</span><span class="o">/</span><span class="n">qemu</span><span class="o">-</span><span class="n">kvm</span>        <span class="n">off</span> <span class="p">(</span><span class="mf">0.00</span><span class="o">/</span><span class="mi">0</span><span class="o">/</span><span class="mi">0</span><span class="p">)</span>
<span class="n">tcp</span>        <span class="mi">0</span>      <span class="mi">0</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">122.73</span><span class="p">:</span><span class="mi">57702</span>    <span class="mf">192.168</span><span class="o">.</span><span class="mf">122.73</span><span class="p">:</span><span class="mi">5900</span>     <span class="n">ESTABLISHED</span> <span class="mi">11118</span><span class="o">/</span><span class="n">python2</span>        <span class="n">keepalive</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">92</span><span class="o">/</span><span class="mi">0</span><span class="o">/</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>Nova-novncproxy keeps the connection alive until browser session ends.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DEBUG</span> <span class="n">nova</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">websocketproxy</span> <span class="p">[</span><span class="o">-</span><span class="p">]</span> \
<span class="n">Reaing</span> <span class="n">zombies</span><span class="p">,</span> <span class="n">active</span> <span class="n">child</span> <span class="n">count</span> <span class="ow">is</span> <span class="mi">1</span> <span class="n">vmsg</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="o">.</span><span class="mi">7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">websockify</span><span class="o">/</span><span class="n">websocket</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">828</span>
</pre></div>
</div>
<p>When a token is not valid while authenticating against nova-consoleauth,
we can see a message like the following.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INFO</span> <span class="n">nova</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">websocketproxy</span> <span class="p">[</span><span class="n">req</span><span class="o">-</span><span class="mi">9164</span><span class="n">b32d</span><span class="o">-</span><span class="mi">3</span><span class="n">ce1</span><span class="o">-</span><span class="mi">441</span><span class="n">b</span><span class="o">-</span><span class="mi">82</span><span class="n">c7</span><span class="o">-</span><span class="mi">6</span><span class="n">c23c9a354d0</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span><span class="p">]</span> \
<span class="n">handler</span> <span class="n">exception</span><span class="p">:</span> <span class="n">The</span> <span class="n">token</span> <span class="s1">&#39;3dfcd011-28f1-4cf3-8f5c-8cd18de4560e&#39;</span> <span class="ow">is</span> <span class="n">invalid</span> <span class="ow">or</span> <span class="n">has</span> <span class="n">expired</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">Regards.</div>
<div class="line">Eduardo Gonzalez</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">egonzalez</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Post:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="2017-08-28-openstack-tacker-and-service-function-chaining-sfc-with-kolla.html">OpenStack tacker and service function chaining sfc with kolla</a></li>
<li class="toctree-l1"><a class="reference internal" href="2017-02-22-deploy-openstack-designate-with-kolla-ansible.html">Deploy OpenStack designate with kolla-ansible</a></li>
<li class="toctree-l1"><a class="reference internal" href="2017-01-31-openstack-keystone-zero-downtime-upgrade-process-n-to-o.html">OpenStack keystone zero downtime upgrade process newton to ocata</a></li>
<li class="toctree-l1"><a class="reference internal" href="2016-10-31-to-conditional-or-to-skip-that-is-the-ansible-question.html">To conditional or to skip, that’s the Ansible question</a></li>
<li class="toctree-l1"><a class="reference internal" href="2016-07-04-midonet-integration-with-openstack-mitaka.html">Midonet integration with OpenStack Mitaka</a></li>
<li class="toctree-l1"><a class="reference internal" href="2016-06-15-rally-openstack-benchmarking-from-docker-containers.html">Rally OpenStack benchmarking from Docker containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="2016-06-06-opendaylight-in-a-docker-container.html">OpenDaylight in a Docker container</a></li>
<li class="toctree-l1"><a class="reference internal" href="2016-04-24-openstack-kolla-deployment-from-rdo-packages.html">OpenStack kolla deployment from RDO packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="2016-03-24-magnum-in-rdo-openstack-liberty-manual-installation-from-source-code.html">Magnum in RDO OpenStack Liberty manual installation from source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="2016-03-17-ceph-ansible-baremetal-deployment.html">Ceph Ansible baremetal deployment</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Nova VNC flows under the hood</a></li>
<li class="toctree-l1"><a class="reference internal" href="2016-02-24-ansible-ini_file-module-simplifying-your-devops-life.html">Ansible INI file module, simplifying your DevOps life</a></li>
<li class="toctree-l1"><a class="reference internal" href="2016-02-15-working-with-affinityanti-affinity-groups-openstack.html">Working with affinity/anti-affinity groups OpenStack</a></li>
<li class="toctree-l1"><a class="reference internal" href="2016-02-02-migrate-from-keystone-v2-0-to-keystone-v3-openstack-liberty.html">Migrate keystone v2.0 to keystone v3 OpenStack Liberty</a></li>
<li class="toctree-l1"><a class="reference internal" href="2016-01-27-configure-neutron-dvr-openstack-liberty.html">Configure neutron DVR OpenStack Liberty</a></li>
<li class="toctree-l1"><a class="reference internal" href="2016-01-14-openstack-segregation-with-availability-zones-and-host-aggregates.html">OpenStack segregation with availability zones and host aggregates</a></li>
<li class="toctree-l1"><a class="reference internal" href="2015-12-23-nova-docker-driver.html">Nova Docker driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="2015-12-14-murano-in-rdo-openstack-manual-installation.html">Murano in RDO OpenStack manual installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="2015-09-08-ceph-radosgw-admin-ops-how-to-use-it.html">Ceph RadosGW admin Ops, how to use it</a></li>
<li class="toctree-l1"><a class="reference internal" href="2015-08-13-multiple-store-locations-for-glance-images.html">Multiple store locations for glance images</a></li>
<li class="toctree-l1"><a class="reference internal" href="2015-07-02-list-all-tenants-belonging-an-user.html">List all tenants belonging an user</a></li>
<li class="toctree-l1"><a class="reference internal" href="2015-03-24-load-balancer-as-a-service-lbaas.html">Load balancer as a service OpenStack LbaaS</a></li>
<li class="toctree-l1"><a class="reference internal" href="2015-03-16-openstack-nova-api-start-error-could-not-bind-to-0-0-0-0-address-already-in-use.html">OpenStack nova APi start error, could not bind to 0.0.0.0 address all ready in use</a></li>
<li class="toctree-l1"><a class="reference internal" href="2015-03-09-delete-openstack-neutron-networks-solution-to-unable-to-complete-operation-on-subnet.html">Delete OpenStack neutron networks, fix to unable to complete operation on subnet</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="2016-03-17-ceph-ansible-baremetal-deployment.html" title="previous chapter">Ceph Ansible baremetal deployment</a></li>
      <li>Next: <a href="2016-02-24-ansible-ini_file-module-simplifying-your-devops-life.html" title="next chapter">Ansible INI file module, simplifying your DevOps life</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Eduardo Gonzalez.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/2016-03-02-nova-vnc-flows-under-the-hood.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>