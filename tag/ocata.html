<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OpenStack Stuff | articles tagged "ocata"</title>
    <link rel="shortcut icon" type="image/png" href="https://egonzalez90.github.io/favicon.png">
    <link rel="shortcut icon" type="image/x-icon" href="https://egonzalez90.github.io/favicon.ico">
    <link href="https://egonzalez90.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="OpenStack Stuff Full Atom Feed" />
    <link rel="stylesheet" href="https://egonzalez90.github.io/theme/css/screen.css" type="text/css" />
    <link rel="stylesheet" href="https://egonzalez90.github.io/theme/css/pygments.css" type="text/css" />
    <link rel="stylesheet" href="https://egonzalez90.github.io/theme/css/print.css" type="text/css" media="print" />
    <meta name="generator" content="Pelican" />
    <meta name="description" content="" />
    <meta name="author" content="Eduardo Gonzalez" />
</head>
<body>
    <header>
        <nav>
            <ul>
                <li class="ephemeral selected"><a href="https://egonzalez90.github.io/tag/ocata.html">ocata</a></li>
                <li><a href="https://egonzalez90.github.io/">Home</a></li>
                <li><a href="https://docs.openstack.org">OpenStack</a></li>
                <li><a href="https://www.linkedin.com/in/eduardogonzalezgutierrez">Linkedin</a></li>
                <li><a href="https://github.com/egonzalez90">Github</a></li>
                <li><a href="https://egonzalez90.github.io/archives">Archives</a></li>
            </ul>
        </nav>
        <div class="header_box">
            <h1><a href="https://egonzalez90.github.io/">OpenStack Stuff</a></h1>
        </div>
    </header>
    <div id="wrapper">
        <div id="content">            <h4 class="date">Feb 22, 2017</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://egonzalez90.github.io/deploy-openstack-designate-with-kolla-ansible.html" rel="bookmark" title="Permanent Link to &quot;Deploy OpenStack Designate with Kolla&quot;">Deploy OpenStack Designate with Kolla</a>
                </h2>

                
                

                <p>During Ocata release, OpenStack DNS-as-a-Service (Designate) support was
implemented in OpenStack kolla project.</p>
<p>This post will guide you through a basic deployment and tests of
designate service.</p>
<p>Install required dependencies and tools for kolla-ansible and designate.</p>
<div class="highlight"><pre><span></span># yum install -y epel-release
# yum install -y python-pip python-devel libffi-devel gcc openssl-devel ansible ntp wget bind-utils
# pip install -U pip
</pre></div>


<p>Install Docker and downgrade to 1.12.6. At the time of writing this post
libvirt had issues to connect with D-Bus due SElinux issues with Docker
1.13.</p>
<div class="highlight"><pre><span></span># curl -sSL https://get.docker.io | bash
# yum downgrade docker-engine-1.12.6 docker-engine-selinux-1.12.6
# yum install -y python-docker-py
</pre></div>


<p>Configure Docker daemon to allow insecure-registry (Use the IP where
your remote registry will be located).</p>
<div class="highlight"><pre><span></span># mkdir -p /etc/systemd/system/docker.service.d
# tee /etc/systemd/system/docker.service.d/kolla.conf &lt;&lt;-&#39;EOF&#39;
[Service]
ExecStart=
ExecStart=/usr/bin/dockerd --insecure-registry 172.28.128.3:4000
MountFlags=shared
EOF
</pre></div>


<p>Reload systemd daemons and start/stop/disable/enable the following
services.</p>
<div class="highlight"><pre><span></span># systemctl daemon-reload
# systemctl stop libvirtd
# systemctl disable libvirtd
# systemctl enable ntpd docker
# systemctl start ntpd docker
</pre></div>


<p>Download Ocata registry created in tarballs.openstack.org, skip this
step if images used are custom builds or downloaded from DockerHub.<br>
Create kolla registry from downloaded tarball.</p>
<div class="highlight"><pre><span></span># wget https://tarballs.openstack.org/kolla/images/centos-binary-registry-ocata.tar.gz
# mkdir /opt/kolla_registry
# sudo tar xzf centos-binary-registry-ocata.tar.gz -C /opt/kolla_registry
# docker run -d -p 4000:5000 --restart=always -v /opt/kolla_registry/:/var/lib/registry --name registry registry:2
</pre></div>


<p>Install kolla-ansible.</p>
<div class="highlight"><pre><span></span># pip install kolla-ansible
# cp -r /usr/share/kolla-ansible/etc_examples/kolla /etc/kolla/
# cp /usr/share/kolla-ansible/ansible/inventory/* .
</pre></div>


<p>Configure kolla globals.yml configuration file with the following
content.<br>
Change values when necessary (IP addresses, interface names).<br>
This is a sample minimal configuration.</p>
<div class="highlight"><pre><span></span># vi /etc/kolla/globals.yml
---
kolla_internal_vip_address: &quot;172.28.128.10&quot;
kolla_base_distro: &quot;centos&quot;
kolla_install_type: &quot;binary&quot;
docker_registry: &quot;172.28.128.3:4000&quot;
docker_namespace: &quot;lokolla&quot;
network_interface: &quot;enp0s8&quot;
neutron_external_interface: &quot;enp0s9&quot;
</pre></div>


<p>Configure designate options in globals.yml.<br>
dns_interface must be network reachable from nova instances if
internal DNS resolution is needed.</p>
<div class="highlight"><pre><span></span>enable_designate: &quot;yes&quot;
dns_interface: &quot;enp0s8&quot;
designate_backend: &quot;bind9&quot;
designate_ns_record: &quot;sample.openstack.org&quot;
</pre></div>


<p>Configure inventory, add the nodes in their respective groups.</p>
<div class="highlight"><pre><span></span># vi ~/multinode
</pre></div>


<p>Generate passwords.</p>
<div class="highlight"><pre><span></span># kolla-genpwd
</pre></div>


<p>Ensure the environment is ready to deploy with prechecks.<br>
Until prechecks does not succeed do not start deployment.<br>
Fix what is necessary.</p>
<div class="highlight"><pre><span></span># kolla-ansible prechecks -i ~/multinode
</pre></div>


<p>Pull Docker images on the servers, this can be skipped because will be
made in deploy step, but doing it first will ensure all the nodes have
the images you need and will minimize the deployment time.</p>
<div class="highlight"><pre><span></span># kolla-ansible pull -i ~/multinode
</pre></div>


<p>Deploy kolla-ansible and do a woot for kolla ;)</p>
<div class="highlight"><pre><span></span># kolla-ansible deploy -i ~/multinode
</pre></div>


<p>Create credentials file and source it.</p>
<div class="highlight"><pre><span></span># kolla-ansible post-deploy -i ~/multinode
# source /etc/kolla/admin-openrc.sh
</pre></div>


<p>Check that all containers are running and none of them are restarting or
exiting.</p>
<div class="highlight"><pre><span></span># docker ps -a --filter status=exited --filter status=restarting
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
</pre></div>


<p>Install required python clients</p>
<div class="highlight"><pre><span></span># pip install python-openstackclient python-designateclient python-neutronclient
</pre></div>


<p>Execute a base OpenStack configuration (public and internal networks,
cirros image).<br>
Do no execute this script if custom networks are going to be used.</p>
<div class="highlight"><pre><span></span># sh /usr/share/kolla-ansible/init-runonce
</pre></div>


<p>Create a sample designate zone.</p>
<div class="highlight"><pre><span></span># openstack zone create --email admin@sample.openstack.org sample.openstack.org.
+----------------+--------------------------------------+
| Field          | Value                                |
+----------------+--------------------------------------+
| action         | CREATE                               |
| attributes     |                                      |
| created_at     | 2017-02-22T13:14:39.000000           |
| description    | None                                 |
| email          | admin@sample.openstack.org           |
| id             | 4a44b0c9-bd07-4f5c-8908-523f453f269d |
| masters        |                                      |
| name           | sample.openstack.org.                |
| pool_id        | 85d18aec-453e-45ae-9eb3-748841a1da12 |
| project_id     | 937d49af6cfe4ef080a79f9a833d7c7d     |
| serial         | 1487769279                           |
| status         | PENDING                              |
| transferred_at | None                                 |
| ttl            | 3600                                 |
| type           | PRIMARY                              |
| updated_at     | None                                 |
| version        | 1                                    |
+----------------+--------------------------------------+
</pre></div>


<p>Configure designate sink to make use of the previously created zone,
sink will need zone_id to automatically create neutron and nova records
into designate.</p>
<div class="highlight"><pre><span></span># mkdir -p /etc/kolla/config/designate/designate-sink/
# vi /etc/kolla/config/designate/designate-sink.conf
[handler:nova_fixed]
zone_id = 4a44b0c9-bd07-4f5c-8908-523f453f269d
[handler:neutron_floatingip]
zone_id = 4a44b0c9-bd07-4f5c-8908-523f453f269d
</pre></div>


<p>After configure designate-sink.conf, reconfigure designate to make use
of this configuration.</p>
<div class="highlight"><pre><span></span># kolla-ansible reconfigure -i ~/multinode --tags designate
</pre></div>


<p>List networks.</p>
<div class="highlight"><pre><span></span># neutron net-list
+--------------------------------------+----------+----------------------------------+--------------------------------------------------+
| id                                   | name     | tenant_id                        | subnets                                          |
+--------------------------------------+----------+----------------------------------+--------------------------------------------------+
| 3b56c605-5a01-45be-9ed6-e4c3285e4366 | demo-net | 937d49af6cfe4ef080a79f9a833d7c7d | 7f28f050-77b2-426e-b963-35b682077993 10.0.0.0/24 |
| 6954d495-fb8c-4b0b-98a9-9672a7f65b7c | public1  | 937d49af6cfe4ef080a79f9a833d7c7d | 9bd9feca-40a7-4e82-b912-e51b726ad746 10.0.2.0/24 |
+--------------------------------------+----------+----------------------------------+--------------------------------------------------+
</pre></div>


<p>Update the network with a dns_domain.</p>
<div class="highlight"><pre><span></span># neutron net-update 3b56c605-5a01-45be-9ed6-e4c3285e4366 --dns_domain sample.openstack.org.
Updated network: 3b56c605-5a01-45be-9ed6-e4c3285e4366
</pre></div>


<p>Ensure dns_domain is properly applied.</p>
<div class="highlight"><pre><span></span># neutron net-show 3b56c605-5a01-45be-9ed6-e4c3285e4366
+---------------------------+--------------------------------------+
| Field                     | Value                                |
+---------------------------+--------------------------------------+
| admin_state_up            | True                                 |
| availability_zone_hints   |                                      |
| availability_zones        | nova                                 |
| created_at                | 2017-02-22T13:13:06Z                 |
| description               |                                      |
| dns_domain                | sample.openstack.org.                |
| id                        | 3b56c605-5a01-45be-9ed6-e4c3285e4366 |
| ipv4_address_scope        |                                      |
| ipv6_address_scope        |                                      |
| mtu                       | 1450                                 |
| name                      | demo-net                             |
| port_security_enabled     | True                                 |
| project_id                | 937d49af6cfe4ef080a79f9a833d7c7d     |
| provider:network_type     | vxlan                                |
| provider:physical_network |                                      |
| provider:segmentation_id  | 27                                   |
| revision_number           | 6                                    |
| router:external           | False                                |
| shared                    | False                                |
| status                    | ACTIVE                               |
| subnets                   | 7f28f050-77b2-426e-b963-35b682077993 |
| tags                      |                                      |
| tenant_id                 | 937d49af6cfe4ef080a79f9a833d7c7d     |
| updated_at                | 2017-02-22T13:25:16Z                 |
+---------------------------+--------------------------------------+
</pre></div>


<p>Create a new instance in the previously updated network.</p>
<div class="highlight"><pre><span></span># openstack server create   
   --image cirros   
   --flavor m1.tiny   
   --key-name mykey   
   --nic net-id=3b56c605-5a01-45be-9ed6-e4c3285e4366   
   demo1
</pre></div>


<p>Once the instance is ACTIVE, check the IP associated.</p>
<div class="highlight"><pre><span></span># openstack server list
+--------------------------------------+-------+--------+-------------------+------------+
| ID                                   | Name  | Status | Networks          | Image Name |
+--------------------------------------+-------+--------+-------------------+------------+
| d483e4ee-58c2-4e1e-9384-85174630428e | demo1 | ACTIVE | demo-net=10.0.0.3 | cirros     |
+--------------------------------------+-------+--------+-------------------+------------+
</pre></div>


<p>List records in the designate zone.<br>
As you can see there is a record in designate associated with the
instance IP.</p>
<div class="highlight"><pre><span></span># openstack recordset list sample.openstack.org.
+--------------------------------------+----------------------------------+------+-------------------------------------------+--------+--------+
| id                                   | name                             | type | records                                   | status | action |
+--------------------------------------+----------------------------------+------+-------------------------------------------+--------+--------+
| 4f70531e-c325-4ffd-a8d3-8172bd5163b8 | sample.openstack.org.            | SOA  | sample.openstack.org.                     | ACTIVE | NONE   |
|                                      |                                  |      | admin.sample.openstack.org. 1487770304    |        |        |
|                                      |                                  |      | 3586 600 86400 3600                       |        |        |
| a9a09c5f-ccf1-4b52-8400-f36e8faa9549 | sample.openstack.org.            | NS   | sample.openstack.org.                     | ACTIVE | NONE   |
| aa6cd25d-186e-425b-9153-699d8b0811de | 10-0-0-3.sample.openstack.org.   | A    | 10.0.0.3                                  | ACTIVE | NONE   |
| 713650a5-a45e-470b-9539-74e110b15115 | demo1.None.sample.openstack.org. | A    | 10.0.0.3                                  | ACTIVE | NONE   |
| 6506e6f6-f535-45eb-9bfb-4ac1f16c5c9b | demo1.sample.openstack.org.      | A    | 10.0.0.3                                  | ACTIVE | NONE   |
+--------------------------------------+----------------------------------+------+-------------------------------------------+--------+--------+
</pre></div>


<p>Validate that designate resolves the DNS record.<br>
You can use designate mDNS service or directly to bind9 servers to
validate the test.</p>
<div class="highlight"><pre><span></span><span class="cp"># dig +short -p 5354 @172.28.128.3 demo1.sample.openstack.org. A</span>
<span class="mf">10.0.0.3</span>
<span class="cp"># dig +short -p 53 @172.28.128.3 demo1.sample.openstack.org. A</span>
<span class="mf">10.0.0.3</span>
</pre></div>


<p>If you find any issue with designate in kolla-ansible or kolla, please
fill a bug <a href="https://bugs.launchpad.net/kolla-ansible/+filebug">https://bugs.launchpad.net/kolla-ansible/+filebug</a></p>
<p>Regards,<br>
Eduardo Gonzalez</p>
                <div class="clear"></div>

                <div class="info">
                    <a href="https://egonzalez90.github.io/deploy-openstack-designate-with-kolla-ansible.html">posted at 15:39</a>
                    &nbsp;&middot;&nbsp;<a href="https://egonzalez90.github.io/category/openstack.html" rel="tag">OpenStack</a>
                    &nbsp;&middot;
                    &nbsp;<a href="https://egonzalez90.github.io/tag/-configure.html" class="tags">--configure</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/ansible.html" class="tags">ansible</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/deploy.html" class="tags">deploy</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/designate.html" class="tags">designate</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/dns.html" class="tags">DNS</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/kolla.html" class="tags">kolla</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/kolla-ansible.html" class="tags">kolla-ansible</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/ocata.html" class="tags selected">ocata</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/openstack.html" class="tags">openstack</a>
                </div>
		<a href="https://egonzalez90.github.io/deploy-openstack-designate-with-kolla-ansible.html#disqus_thread">Click to read and post comments</a>
            </article>            <h4 class="date">Jan 31, 2017</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://egonzalez90.github.io/openstack-keystone-zero-downtime-upgrade-process-n-to-o.html" rel="bookmark" title="Permanent Link to &quot;OpenStack Keystone Zero-Downtime upgrade process (N to O)&quot;">OpenStack Keystone Zero-Downtime upgrade process (N to O)</a>
                </h2>

                
                

                <p>This blog post will show Keystone upgrade procedure from OpenStack
Newton to Ocata release with zero-downtime.</p>
<p>In the case of doing this in production, please read release notes,
ensure a proper configuration, do database backups and test the upgrade
a thousand times.</p>
<p>Keystone upgrade will need to stop one node in order to use it as
upgrade server.<br>
In the case of a PoC this is not an issue, but in a production
environment, Keystone loads may be intensive and stopping a node for a
while may decrease other nodes performance more than expected.<br>
For this reason I prefer orchestrate the upgrade from an external
Docker container. With this method all nodes will be fully running
almost all the time.</p>
<ul>
<li>New container won't start any service, just will sync the database
    schema with new Keystone version avoiding stop a node to orchestrate
    the upgrade.</li>
<li>The Docker image is provided by OpenStack Kolla project, if already
    using Kolla this upgrade won't be needed as kolla-ansible already
    provide an upgrade method.</li>
<li>At the moment of writing of this blog, Ocata packages were not
    released into stable repositories. For this reason I use DLRN
    repositories.</li>
<li>If Ocata is released please do not use DLRN, use stable packages
    instead.</li>
<li>Use stable Ocata Docker image if available with tag 4.0.x and will
    avoid repository configuration and package upgrades.</li>
<li>NOTE: Upgrade may need more steps depending of your own
    configuration, i.e, if using fernet token more steps are necessary
    during the upgrade.</li>
<li>All Keystone nodes are behind HAproxy.</li>
</ul>
<h3>Prepare the upgrade</h3>
<p>Start Keystone Docker container with host networking (needed to
communicate with database nodes directly) and root user (needed to
install packages).</p>
<div class="highlight"><pre><span></span>(host)# docker run -ti --net host -u 0 kolla/centos-binary-keystone:3.0.2 bash
</pre></div>


<p>Download Delorean CentOS trunk repositories</p>
<div class="highlight"><pre><span></span>(keystone-upgrade)# curl -Lo /etc/yum.repos.d/delorean.repo http://buildlogs.centos.org/centos/7/cloud/x86_64/rdo-trunk-master-tested/delorean.repo
(keystone-upgrade)# curl -Lo /etc/yum.repos.d/delorean-deps.repo http://trunk.rdoproject.org/centos7/delorean-deps.repo
</pre></div>


<p>Disable Newton repository</p>
<div class="highlight"><pre><span></span>(keystone-upgrade)# yum-config-manager --disable centos-openstack-newton
</pre></div>


<p>Ensure Newton repository is not longer used by the system</p>
<div class="highlight"><pre><span></span>(keystone-upgrade)# yum repolist | grep -i openstack
delorean                        delorean-openstack-glance-0bf9d805886c2  565+255
</pre></div>


<p>Update all packages in the Docker container to bump keystone version to
Ocata.</p>
<div class="highlight"><pre><span></span>(keystone-upgrade)# yum clean all &amp;&amp; yum update -y
</pre></div>


<p>Configure keystone.conf file, this are my settings. Review you
configuration and ensure all is correctly, otherwise may cause issues in
the database.<br>
An important option is default_domain_id, this value is for backward
compatible with users created under default domain.</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="n">keystone</span><span class="o">-</span><span class="n">upgrade</span><span class="p">)</span><span class="err">#</span> <span class="n">egrep</span> <span class="o">^</span><span class="p">[</span><span class="o">^</span><span class="err">#</span><span class="p">]</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">keystone</span><span class="o">/</span><span class="n">keystone</span><span class="p">.</span><span class="n">conf</span> 
<span class="p">[</span><span class="n">DEFAULT</span><span class="p">]</span>
<span class="n">debug</span> <span class="o">=</span> <span class="n">False</span>
<span class="n">log_file</span> <span class="o">=</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">keystone</span><span class="o">/</span><span class="n">keystone</span><span class="p">.</span><span class="n">log</span>
<span class="n">secure_proxy_ssl_header</span> <span class="o">=</span> <span class="n">HTTP_X_FORWARDED_PROTO</span>
<span class="p">[</span><span class="n">database</span><span class="p">]</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">+</span><span class="nl">pymysql</span><span class="p">:</span><span class="c1">//keystone:ickvaHC9opkwbz8z8sy28aLiFNezc7Z6Fm34frcB@192.168.100.10:3306/keystone</span>
<span class="n">max_retries</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">[</span><span class="n">cache</span><span class="p">]</span>
<span class="n">backend</span> <span class="o">=</span> <span class="n">oslo_cache</span><span class="p">.</span><span class="n">memcache_pool</span>
<span class="n">enabled</span> <span class="o">=</span> <span class="n">True</span>
<span class="n">memcache_servers</span> <span class="o">=</span> <span class="mf">192.168.100.215</span><span class="o">:</span><span class="mi">11211</span><span class="p">,</span><span class="mf">192.168.100.170</span><span class="o">:</span><span class="mi">11211</span>
<span class="p">[</span><span class="n">identity</span><span class="p">]</span>
<span class="n">default_domain_id</span> <span class="o">=</span> <span class="k">default</span>
<span class="p">[</span><span class="n">token</span><span class="p">]</span>
<span class="n">provider</span> <span class="o">=</span> <span class="n">uuid</span>
</pre></div>


<p>Check migrate version in the database.<br>
As you will notice, contract/data_migrate/expand are in the same
version</p>
<div class="highlight"><pre><span></span>(mariadb)# mysql -ukeystone -pickvaHC9opkwbz8z8sy28aLiFNezc7Z6Fm34frcB -h192.168.100.10 keystone -e &quot;select * from migrate_version;&quot; 
Warning: Using a password on the command line interface can be insecure.
+-----------------------+--------------------------------------------------------------------------+---------+
| repository_id         | repository_path                                                          | version |
+-----------------------+--------------------------------------------------------------------------+---------+
| keystone              | /usr/lib/python2.7/site-packages/keystone/common/sql/migrate_repo        |     109 |
| keystone_contract     | /usr/lib/python2.7/site-packages/keystone/common/sql/contract_repo       |       4 |
| keystone_data_migrate | /usr/lib/python2.7/site-packages/keystone/common/sql/data_migration_repo |       4 |
| keystone_expand       | /usr/lib/python2.7/site-packages/keystone/common/sql/expand_repo         |       4 |
+-----------------------+--------------------------------------------------------------------------+---------+
</pre></div>


<p>Before start upgrading the database schema, you will need add SUPER
privileges in the database to keystone user or set
log_bin_trust_function_creators to True.<br>
In my opinion is safer set the value to True, I don't want keystone
with SUPER privileges.</p>
<div class="highlight"><pre><span></span>(mariadb)# mysql -uroot -pnkLMrBibfMTRqOGBAP3UAxdO4kOFfEaPptGM5UDL -h192.168.100.10 keystone -e &quot;set global log_bin_trust_function_creators=1;&quot;
</pre></div>


<p>Now use Rally, tempest or some tool to test/benchmarch keystone service
during upgrade.<br>
If don't want to use one of those tools, just use this for command.</p>
<div class="highlight"><pre><span></span>(host)# for i in {1000..6000} ; do openstack user create --password $i $i; done
</pre></div>


<h3>Start Upgrade</h3>
<p>Check database status before upgrade using Doctor, this may raise issues
in the configuration. Some of them may be ignored(Please, ensure is not
an issue before ignoring).<br>
As example, I'm not using fernet tokens and errors appear about missing
folder.</p>
<div class="highlight"><pre><span></span>(keystone-upgrade)# keystone-manage doctor
</pre></div>


<p>Remove obsoleted tokens</p>
<div class="highlight"><pre><span></span>(keystone-upgrade)# keystone-manage token_flush
</pre></div>


<p>Now, expand the database schema to latest version, in keystone.log can
see the status.<br>
Check in the logs if some error is raised before jump to the next step.</p>
<div class="highlight"><pre><span></span>(keystone-upgrade)# keystone-manage db_sync --expand


2017-01-31 13:42:02.772 306 INFO migrate.versioning.api [-] 4 -&gt; 5... 
2017-01-31 13:42:03.004 306 INFO migrate.versioning.api [-] done
2017-01-31 13:42:03.005 306 INFO migrate.versioning.api [-] 5 -&gt; 6... 
2017-01-31 13:42:03.310 306 INFO migrate.versioning.api [-] done
2017-01-31 13:42:03.310 306 INFO migrate.versioning.api [-] 6 -&gt; 7... 
2017-01-31 13:42:03.670 306 INFO migrate.versioning.api [-] done
2017-01-31 13:42:03.671 306 INFO migrate.versioning.api [-] 7 -&gt; 8... 
2017-01-31 13:42:03.984 306 INFO migrate.versioning.api [-] done
2017-01-31 13:42:03.985 306 INFO migrate.versioning.api [-] 8 -&gt; 9... 
2017-01-31 13:42:04.185 306 INFO migrate.versioning.api [-] done
2017-01-31 13:42:04.185 306 INFO migrate.versioning.api [-] 9 -&gt; 10... 
2017-01-31 13:42:07.202 306 INFO migrate.versioning.api [-] done
2017-01-31 13:42:07.202 306 INFO migrate.versioning.api [-] 10 -&gt; 11... 
2017-01-31 13:42:07.481 306 INFO migrate.versioning.api [-] done
2017-01-31 13:42:07.481 306 INFO migrate.versioning.api [-] 11 -&gt; 12... 
2017-01-31 13:42:11.334 306 INFO migrate.versioning.api [-] done
2017-01-31 13:42:11.334 306 INFO migrate.versioning.api [-] 12 -&gt; 13... 
2017-01-31 13:42:11.560 306 INFO migrate.versioning.api [-] done
</pre></div>


<p>After expand the database, migrate it to latest version.<br>
Ensure there are not errors in Keystone logs.</p>
<div class="highlight"><pre><span></span>(keystone-upgrade)# keystone-manage db_sync --migrate

#keystone.log
2017-01-31 13:42:58.771 314 INFO migrate.versioning.api [-] 4 -&gt; 5... 
2017-01-31 13:42:58.943 314 INFO migrate.versioning.api [-] done
2017-01-31 13:42:58.943 314 INFO migrate.versioning.api [-] 5 -&gt; 6... 
2017-01-31 13:42:59.143 314 INFO migrate.versioning.api [-] done
2017-01-31 13:42:59.143 314 INFO migrate.versioning.api [-] 6 -&gt; 7... 
2017-01-31 13:42:59.340 314 INFO migrate.versioning.api [-] done
2017-01-31 13:42:59.341 314 INFO migrate.versioning.api [-] 7 -&gt; 8... 
2017-01-31 13:42:59.698 314 INFO migrate.versioning.api [-] done
2017-01-31 13:42:59.699 314 INFO migrate.versioning.api [-] 8 -&gt; 9... 
2017-01-31 13:42:59.852 314 INFO migrate.versioning.api [-] done
2017-01-31 13:42:59.852 314 INFO migrate.versioning.api [-] 9 -&gt; 10... 
2017-01-31 13:43:00.135 314 INFO migrate.versioning.api [-] done
2017-01-31 13:43:00.135 314 INFO migrate.versioning.api [-] 10 -&gt; 11... 
2017-01-31 13:43:00.545 314 INFO migrate.versioning.api [-] done
2017-01-31 13:43:00.545 314 INFO migrate.versioning.api [-] 11 -&gt; 12... 
2017-01-31 13:43:00.703 314 INFO migrate.versioning.api [-] done
2017-01-31 13:43:00.703 314 INFO migrate.versioning.api [-] 12 -&gt; 13... 
2017-01-31 13:43:00.854 314 INFO migrate.versioning.api [-] done
</pre></div>


<p>Now, see migrate_version table, you will notice that expand and
data_migrate are in the latest version, but contract still in the
previous version.</p>
<div class="highlight"><pre><span></span>(mariadb)# mysql -ukeystone -pickvaHC9opkwbz8z8sy28aLiFNezc7Z6Fm34frcB -h192.168.100.10 keystone -e &quot;select * from migrate_version;&quot;
+-----------------------+--------------------------------------------------------------------------+---------+
| repository_id         | repository_path                                                          | version |
+-----------------------+--------------------------------------------------------------------------+---------+
| keystone              | /usr/lib/python2.7/site-packages/keystone/common/sql/migrate_repo        |     109 |
| keystone_contract     | /usr/lib/python2.7/site-packages/keystone/common/sql/contract_repo       |       4 |
| keystone_data_migrate | /usr/lib/python2.7/site-packages/keystone/common/sql/data_migration_repo |      13 |
| keystone_expand       | /usr/lib/python2.7/site-packages/keystone/common/sql/expand_repo         |      13 |
+-----------------------+--------------------------------------------------------------------------+---------+
</pre></div>


<h3>Every Keystone node, one by one</h3>
<p>Go to keystone nodes.<br>
Stop Keystone services, in my case using wsgi inside Apache</p>
<div class="highlight"><pre><span></span>(keystone_nodes)# systemctl stop httpd
</pre></div>


<p>Configure Ocata repositories as made in the Docker container.<br>
Update packages, if you have Keystone sharing the node with other
OpenStack service, do not update all packages as it will break other
services.<br>
Update only required packages.</p>
<div class="highlight"><pre><span></span>(keystone_nodes)# yum clean all &amp;&amp; yum update -y
</pre></div>


<p>Configure Keystone configuration file to the desired state. Your
configuration may change.</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="n">keystone_nodes</span><span class="p">)</span><span class="err">#</span> <span class="n">egrep</span> <span class="o">^</span><span class="p">[</span><span class="o">^</span><span class="err">#</span><span class="p">]</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">keystone</span><span class="o">/</span><span class="n">keystone</span><span class="p">.</span><span class="n">conf</span> 
<span class="p">[</span><span class="n">DEFAULT</span><span class="p">]</span>
<span class="n">debug</span> <span class="o">=</span> <span class="n">False</span>
<span class="n">log_file</span> <span class="o">=</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">keystone</span><span class="o">/</span><span class="n">keystone</span><span class="p">.</span><span class="n">log</span>
<span class="n">secure_proxy_ssl_header</span> <span class="o">=</span> <span class="n">HTTP_X_FORWARDED_PROTO</span>
<span class="p">[</span><span class="n">database</span><span class="p">]</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">+</span><span class="nl">pymysql</span><span class="p">:</span><span class="c1">//keystone:ickvaHC9opkwbz8z8sy28aLiFNezc7Z6Fm34frcB@192.168.100.10:3306/keystone</span>
<span class="n">max_retries</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">[</span><span class="n">cache</span><span class="p">]</span>
<span class="n">backend</span> <span class="o">=</span> <span class="n">oslo_cache</span><span class="p">.</span><span class="n">memcache_pool</span>
<span class="n">enabled</span> <span class="o">=</span> <span class="n">True</span>
<span class="n">memcache_servers</span> <span class="o">=</span> <span class="mf">192.168.100.215</span><span class="o">:</span><span class="mi">11211</span><span class="p">,</span><span class="mf">192.168.100.170</span><span class="o">:</span><span class="mi">11211</span>
<span class="p">[</span><span class="n">identity</span><span class="p">]</span>
<span class="n">default_domain_id</span> <span class="o">=</span> <span class="k">default</span>
<span class="p">[</span><span class="n">token</span><span class="p">]</span>
<span class="n">provider</span> <span class="o">=</span> <span class="n">uuid</span>
</pre></div>


<p>Start Keystone service.</p>
<div class="highlight"><pre><span></span>(keystone_nodes)# systemctl start httpd
</pre></div>


<h3>Finish Upgrade</h3>
<p>After all the nodes are updated to latest version (please ensure all
nodes are using latest packages, if not will fail).<br>
Contract Keystone database schema.<br>
Look at keystone.log for errors.</p>
<div class="highlight"><pre><span></span>(keystone-upgrade)# keystone-manage db_sync --contract

keystone.log

2017-01-31 13:57:52.164 322 INFO migrate.versioning.api [-] 4 -&gt; 5... 
2017-01-31 13:57:52.379 322 INFO migrate.versioning.api [-] done
2017-01-31 13:57:52.379 322 INFO migrate.versioning.api [-] 5 -&gt; 6... 
2017-01-31 13:57:52.969 322 INFO migrate.versioning.api [-] done
2017-01-31 13:57:52.969 322 INFO migrate.versioning.api [-] 6 -&gt; 7... 
2017-01-31 13:57:53.462 322 INFO migrate.versioning.api [-] done
2017-01-31 13:57:53.462 322 INFO migrate.versioning.api [-] 7 -&gt; 8... 
2017-01-31 13:57:53.793 322 INFO migrate.versioning.api [-] done
2017-01-31 13:57:53.793 322 INFO migrate.versioning.api [-] 8 -&gt; 9... 
2017-01-31 13:57:53.957 322 INFO migrate.versioning.api [-] done
2017-01-31 13:57:53.957 322 INFO migrate.versioning.api [-] 9 -&gt; 10... 
2017-01-31 13:57:54.111 322 INFO migrate.versioning.api [-] done
2017-01-31 13:57:54.112 322 INFO migrate.versioning.api [-] 10 -&gt; 11... 
2017-01-31 13:57:54.853 322 INFO migrate.versioning.api [-] done
2017-01-31 13:57:54.853 322 INFO migrate.versioning.api [-] 11 -&gt; 12... 
2017-01-31 13:57:56.727 322 INFO migrate.versioning.api [-] done
2017-01-31 13:57:56.728 322 INFO migrate.versioning.api [-] 12 -&gt; 13... 
2017-01-31 13:57:59.529 322 INFO migrate.versioning.api [-] done
</pre></div>


<p>Now if we look at migrate_version table, will see that contract version
is latest and match with the other version (Ensure all are in the same
version).<br>
This means the database upgrade has been successfully implemented.</p>
<div class="highlight"><pre><span></span>(mariadb)# mysql -ukeystone -pickvaHC9opkwbz8z8sy28aLiFNezc7Z6Fm34frcB -h192.168.100.10 keystone -e &quot;select * from migrate_version;&quot;
+-----------------------+--------------------------------------------------------------------------+---------+
| repository_id         | repository_path                                                          | version |
+-----------------------+--------------------------------------------------------------------------+---------+
| keystone              | /usr/lib/python2.7/site-packages/keystone/common/sql/migrate_repo        |     109 |
| keystone_contract     | /usr/lib/python2.7/site-packages/keystone/common/sql/contract_repo       |      13 |
| keystone_data_migrate | /usr/lib/python2.7/site-packages/keystone/common/sql/data_migration_repo |      13 |
| keystone_expand       | /usr/lib/python2.7/site-packages/keystone/common/sql/expand_repo         |      13 |
+-----------------------+--------------------------------------------------------------------------+---------+
</pre></div>


<p>Remove log_bin_trust_function_creators value.</p>
<div class="highlight"><pre><span></span>(mariadb)# mysql -uroot -pnkLMrBibfMTRqOGBAP3UAxdO4kOFfEaPptGM5UDL -h192.168.100.10 keystone -e &quot;set global log_bin_trust_function_creators=0;&quot;
</pre></div>


<p>After finish the upgrade, Rally tests should not have any error. **If
using HAproxy for load balance Keystone service, some errors may happen
due a connection drop while stopping Keystone service and re-balance to
other Keystone node. This can be avoided putting the node to update in
Maintenance Mode in HAproxy backend.</p>
<p>Have to thank Keystone team in #openstack-keystone IRC channel for the
help provided with a couple of issues.</p>
<p>Regards, Eduardo Gonzalez</p>
                <div class="clear"></div>

                <div class="info">
                    <a href="https://egonzalez90.github.io/openstack-keystone-zero-downtime-upgrade-process-n-to-o.html">posted at 17:00</a>
                    &nbsp;&middot;&nbsp;<a href="https://egonzalez90.github.io/category/linux-openstack-various.html" rel="tag">Linux, OpenStack, Various</a>
                    &nbsp;&middot;
                    &nbsp;<a href="https://egonzalez90.github.io/tag/contract.html" class="tags">contract</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/database.html" class="tags">database</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/docker.html" class="tags">docker</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/downtime.html" class="tags">Downtime</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/expand.html" class="tags">expand</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/keystone.html" class="tags">keystone</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/kolla.html" class="tags">kolla</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/migrate.html" class="tags">migrate</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/newton.html" class="tags">newton</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/ocata.html" class="tags selected">ocata</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/openstack.html" class="tags">openstack</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/schema.html" class="tags">schema</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/upgrade.html" class="tags">Upgrade</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/zero.html" class="tags">Zero</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/zero-downtime.html" class="tags">zero-downtime</a>
                </div>
		<a href="https://egonzalez90.github.io/openstack-keystone-zero-downtime-upgrade-process-n-to-o.html#disqus_thread">Click to read and post comments</a>
            </article>

            <div class="clear"></div>
            <footer>
                <p>
                <a href="https://github.com/jody-frankowski/blue-penguin">Blue Penguin</a> Theme
                &middot;
                Powered by <a href="http://getpelican.com">Pelican</a>
                &middot;
                <a href="https://egonzalez90.github.io/feeds/all.atom.xml" rel="alternate">Atom Feed</a>
            </footer>
        </div>
        <div class="clear"></div>
    </div>
</body>
</html>