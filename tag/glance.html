<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OpenStack Stuff | articles tagged "glance"</title>
    <link rel="shortcut icon" type="image/png" href="https://egonzalez90.github.io/favicon.png">
    <link rel="shortcut icon" type="image/x-icon" href="https://egonzalez90.github.io/favicon.ico">
    <link href="https://egonzalez90.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="OpenStack Stuff Full Atom Feed" />
    <link rel="stylesheet" href="https://egonzalez90.github.io/theme/css/screen.css" type="text/css" />
    <link rel="stylesheet" href="https://egonzalez90.github.io/theme/css/pygments.css" type="text/css" />
    <link rel="stylesheet" href="https://egonzalez90.github.io/theme/css/print.css" type="text/css" media="print" />
    <meta name="generator" content="Pelican" />
    <meta name="description" content="" />
    <meta name="author" content="Eduardo Gonzalez" />
</head>
<body>
    <header>
        <nav>
            <ul>
                <li class="ephemeral selected"><a href="https://egonzalez90.github.io/tag/glance.html">glance</a></li>
                <li><a href="https://egonzalez90.github.io/">Home</a></li>
                <li><a href="https://docs.openstack.org">OpenStack</a></li>
                <li><a href="https://www.linkedin.com/in/eduardogonzalezgutierrez">Linkedin</a></li>
                <li><a href="https://github.com/egonzalez90">Github</a></li>
                <li><a href="https://egonzalez90.github.io/archives">Archives</a></li>
            </ul>
        </nav>
        <div class="header_box">
            <h1><a href="https://egonzalez90.github.io/">OpenStack Stuff</a></h1>
        </div>
    </header>
    <div id="wrapper">
        <div id="content">            <h4 class="date">Dec 23, 2015</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://egonzalez90.github.io/nova-docker-driver.html" rel="bookmark" title="Permanent Link to &quot;Nova Docker driver&quot;">Nova Docker driver</a>
                </h2>

                
                

                <p>Cloud computing has evolved too fast over the last years, currently is a
totally different thing as the 5 years ago cloud, today is a common
thing listening words like containers, instances, microservices, queue
messages on linkedin, twitter, etc.</p>
<p>OpenStack is not a lazy community, new capabilities are daily added to
the OpenStack catalog reaching more users and business needs who are
discovered at the several summits and meetups over the world. One of
that needs is the capability to easy create and manage docker
containers.<br>
Now we have two main methods, directly launching instances as
containers from nova driver or with heat/kubernetes/messos.<br>
The second method is the one with more followers, but there are some
projects which are using nova driver as Solum, for this reason i'm going
to show you how to configure docker as nova driver.</p>
<p>The fist step is install docker on the compute nodes</p>
<div class="highlight"><pre><span></span>curl -sSL https://get.docker.com/ | sh

+ sh -c &#39;sleep 3; yum -y -q install docker-engine&#39;
advertencia:/var/cache/yum/x86_64/7/docker-main-repo/packages/docker-engine-selinux-1.9.1-1.el7.centos.noarch.rpm: EncabezadoV4 RSA/SHA512 Signature, ID de clave 2c52609d: NOKEY
No se ha instalado la llave pública de docker-engine-selinux-1.9.1-1.el7.centos.noarch.rpm
Importando llave GPG 0x2C52609D:
Usuarioid  : &quot;Docker Release Tool (releasedocker) &lt;docker@docker.com&gt;&quot;
Huella       : 5811 8e89 f3a9 1289 7c07 0adb f762 2157 2c52 609d
Desde      : https://yum.dockerproject.org/gpg
Full path required for exclude: net:[4026532228].
Full path required for exclude: net:[4026532228].
Full path required for exclude: net:[4026532285].
Full path required for exclude: net:[4026532285].
Full path required for exclude: net:[4026532228].
Full path required for exclude: net:[4026532228].
Full path required for exclude: net:[4026532285].
Full path required for exclude: net:[4026532285].
</pre></div>


<p>Add nova user to docker group, docker group will be created during
docker installation</p>
<div class="highlight"><pre><span></span>usermod -aG docker nova
</pre></div>


<p>Start docker service</p>
<div class="highlight"><pre><span></span>sudo systemctl start docker
</pre></div>


<p>Test docker installation with the following command, a Hello from Docker
message should be prompted</p>
<div class="highlight"><pre><span></span>sudo docker run hello-world

Unable to find image &#39;hello-world:latest&#39; locally
latest: Pulling from library/hello-world
b901d36b6f2f: Pull complete
0a6ba66e537a: Pull complete
Digest: sha256:8be990ef2aeb16dbcb9271ddfe2610fa6658d13f6dfb8bc72074cc1ca36966a7
Status: Downloaded newer image for hello-world:latest

Hello from Docker.
This message shows that your installation appears to be working correctly.
</pre></div>


<p>Once docker runs in a proper way, enable docker service at boot</p>
<div class="highlight"><pre><span></span>sudo systemctl enable docker
ln -s &#39;/usr/lib/systemd/system/docker.service&#39; &#39;/etc/systemd/system/multi-user.target.wants/docker.service&#39;
</pre></div>


<p>Give docker socket the apropiate permissions</p>
<div class="highlight"><pre><span></span>chmod 666  /var/run/docker.sock
</pre></div>


<p>Restart nova-compute service</p>
<div class="highlight"><pre><span></span>systemctl restart openstack-nova-compute
</pre></div>


<p>Install git and pip if not present on the system</p>
<div class="highlight"><pre><span></span>sudo yum install -y git
sudo easy_install pip
</pre></div>


<p>Clone docker driver for nova from OpenStack repositories</p>
<div class="highlight"><pre><span></span>git clone -b stable/liberty https://github.com/openstack/nova-docker
</pre></div>


<p>Install basic requirements</p>
<div class="highlight"><pre><span></span>cd nova-docker
sudo  pip install -r requirements.txt
</pre></div>


<p>Install docker driver</p>
<div class="highlight"><pre><span></span>python setup.py install
</pre></div>


<p>Edit nova.conf and allow docker driver as compute driver</p>
<div class="highlight"><pre><span></span>vi /etc/nova/nova.conf
compute_driver=novadocker.virt.docker.DockerDriver
</pre></div>


<p>Create the following directory</p>
<div class="highlight"><pre><span></span>mkdir /etc/nova/rootwrap.d
</pre></div>


<p>Create a file with the following content to allow setting networking in
docker containers</p>
<div class="highlight"><pre><span></span>vi /etc/nova/rootwrap.d/docker.filters

[Filters]
# nova/virt/docker/driver.py: &#39;ln&#39;, &#39;-sf&#39;, &#39;/var/run/netns/.*&#39;
ln: CommandFilter, /bin/ln, root
</pre></div>


<p>Edit glance-api.conf and allow docker as container format</p>
<div class="highlight"><pre><span></span>vi /etc/glance/glance-api.conf
container_formats=ami,ari,aki,bare,ovf,ova,docker
</pre></div>


<p>Restart glance-api to apply changes</p>
<div class="highlight"><pre><span></span>systemctl restart openstack-glance-api
</pre></div>


<p>Pull a docker image, i use hipache as testing image</p>
<div class="highlight"><pre><span></span>docker pull hipache

Using default tag: latest
latest: Pulling from library/hipache
0a85502c06c9: Pull complete
0998bf8fb9e9: Pull complete
a6785352b25c: Pull complete
e9ae3c220b23: Pull complete
84d61e35041c: Pull complete
0fd25fcc737a: Pull complete
c0af65e2f918: Pull complete
dc335e9e58f4: Pull complete
7245129ed8a4: Pull complete
52a015bc8761: Pull complete
d38065541924: Pull complete
0b8658d6c429: Pull complete
188468e0ae8d: Pull complete
741abf992884: Pull complete
Digest: sha256:7774cf9155a8cc83b6964c7ea0d655143c152debc6d11d4f6dfa918c7a7ea099
Status: Downloaded newer image for hipache:latest
</pre></div>


<p>Upload the image to glance</p>
<div class="highlight"><pre><span></span>docker save hipache | openstack image create hipache --public --container-format docker --disk-format raw

+------------------+------------------------------------------------------+
| Field            | Value                                                |
+------------------+------------------------------------------------------+
| checksum         | e93b7c1ddeb2d38419bf44aaf07cc811                     |
| container_format | docker                                               |
| created_at       | 2015-12-18T10:06:31Z                                 |
| disk_format      | raw                                                  |
| file             | /v2/images/7f05f7d6-88af-4d0f-adad-66ca025404fa/file |
| id               | 7f05f7d6-88af-4d0f-adad-66ca025404fa                 |
| min_disk         | 0                                                    |
| min_ram          | 0                                                    |
| name             | hipache                                              |
| owner            | 74675bfffc3c4e1a9d9fb2f1388217d4                     |
| protected        | False                                                |
| schema           | /v2/schemas/image                                    |
| size             | 384304640                                            |
| status           | active                                               |
| updated_at       | 2015-12-18T10:07:03Z                                 |
| virtual_size     | None                                                 |
| visibility       | public                                               |
+------------------+------------------------------------------------------+
</pre></div>


<p>Once the image is active at glance, create a new instance, the instance
won't be a KVM virtual machine, now will be a docker container</p>
<div class="highlight"><pre><span></span>nova boot --flavor m1.tiny --image hipache --nic net-id=a1aa6336-9ae2-4ffb-99f5-1b6d1130989c --key-name mykey test1
</pre></div>


<p>After a while, the instance should be in ACTIVE state</p>
<div class="highlight"><pre><span></span>watch nova list
+--------------------------------------+-------+--------+------------+-------------+-----------------------------+
| ID                                   | Name  | Status | Task State | Power State | Networks                    |
+--------------------------------------+-------+--------+------------+-------------+-----------------------------+
| fb192405-4150-4c2d-98ad-316141f48cc5 | test1 | ACTIVE | -          | Running     | private_network=192.168.1.3 |
+--------------------------------------+-------+--------+------------+-------------+-----------------------------+
</pre></div>


<p>If all the steps worked fine, you can use docker as nova backend.<br>
Regards</p>
                <div class="clear"></div>

                <div class="info">
                    <a href="https://egonzalez90.github.io/nova-docker-driver.html">posted at 18:31</a>
                    &nbsp;&middot;&nbsp;<a href="https://egonzalez90.github.io/category/openstack.html" rel="tag">OpenStack</a>
                    &nbsp;&middot;
                    &nbsp;<a href="https://egonzalez90.github.io/tag/-configure.html" class="tags">--configure</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/centos.html" class="tags">centos</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/container.html" class="tags">container</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/docker.html" class="tags">docker</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/driver.html" class="tags">driver</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/glance.html" class="tags selected">glance</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/install.html" class="tags">install</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/instance.html" class="tags">instance</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/nova.html" class="tags">nova</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/openstack.html" class="tags">openstack</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/rdo.html" class="tags">rdo</a>
                </div>
		<a href="https://egonzalez90.github.io/nova-docker-driver.html#disqus_thread">Click to read and post comments</a>
            </article>            <h4 class="date">Aug 13, 2015</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://egonzalez90.github.io/multiple-store-locations-for-glance-images.html" rel="bookmark" title="Permanent Link to &quot;Multiple store locations for Glance images&quot;">Multiple store locations for Glance images</a>
                </h2>

                
                

                <p>In this post i will show you how to add multiple store locations for
glance images.<br>
This will allow you to extend your glance capacity without affect your
current stored images.<br>
The location can be any device or directory mounted at your glance host
as a NFS, a physical hard disk, or an extended partition.<br>
Let's start:</p>
<p>First we need to create the directories where hard disks are going to be
mounted  </p>
<p><code>sudo mkdir /var/lib/glance/lvm-images sudo mkdir /var/lib/glance/extended-images</code></p>
<p>Next, we mount the devices at the directories created in the previous
step</p>
<p><code>sudo mount /dev/sdc1 /var/lib/glance/lvm-images/ sudo mount /dev/sdd1 /var/lib/glance/extended-images/</code></p>
<p>An important step is making the glance user the owner of that
directories</p>
<p><code>chown glance:glance /var/lib/glance/lvm-images/ chown glance:glance /var/lib/glance/extended-images/</code></p>
<p>Once the previous steps has been made, we need to configure the
/etc/glance/glance-api.conf file.<br>
In this file, we're going to configure glance to use multiple
directories to store images.<br>
We search the section "Filesystem Store Options" and modify/create the
following:<br>
We will leave the option "filesystem_store_datadir=" empty, if we
comment this option, glance will use it as default store location and
will show us an error during image creation.<br>
And we add the option "filesystem_store_datadirs", once for any
directory we created in previous steps.<br>
We can use priorities on glance, priority 200 has precedence over
priority 100, if we don't specify any priority, default will be 0</p>
<p><code># ============ Filesystem Store Options ======================== filesystem_store_datadir= filesystem_store_datadirs=/var/lib/glance/images filesystem_store_datadirs=/var/lib/glance/lvm-images:200 filesystem_store_datadirs=/var/lib/glance/extended-images:100</code></p>
<p>Once we have configured glance-api.conf, restart glance-api service</p>
<p><code>systemctl restart openstack-glance-api</code></p>
<p>Now we're going to create an image</p>
<div class="highlight"><pre><span></span>glance image-create --name CirrosDatadir --file ~/Images/cirros-0.3.4-i386-disk.img --disk-format qcow2 --container-format bare --progress
[=============================&gt;] 100%
+------------------+--------------------------------------+
| Property         | Value                                |
+------------------+--------------------------------------+
| checksum         | 79b4436412283bb63c2cba4ac796bcd9     |
| container_format | bare                                 |
| created_at       | 2015-08-13T11:34:00.000000           |
| deleted          | False                                |
| deleted_at       | None                                 |
| disk_format      | qcow2                                |
| id               | 6ac8f5b9-5863-46ca-bb04-db352d35d829 |
| is_public        | False                                |
| min_disk         | 0                                    |
| min_ram          | 0                                    |
| name             | CirrosDatadir                        |
| owner            | 738ec25d8b9c41f9b0cf84ce25730e92     |
| protected        | False                                |
| size             | 12506112                             |
| status           | active                               |
| updated_at       | 2015-08-13T11:34:09.000000           |
| virtual_size     | None                                 |
+------------------+--------------------------------------+
</pre></div>


<p>The image has been properly created at glance, we're going to check if
the image has been properly created in the expected location.<br>
As we have configured a priority of 200 on this directory, the image
must be here.</p>
<p><code>ls -lsrt /var/lib/glance/extended-images/ total 12216 12216 -rw-r-----. 1 glance glance 12506112 ago 13 13:34 6ac8f5b9-5863-46ca-bb04-db352d35d829</code></p>
<p>We have to keep the store location that we have been using till now, the
images remain available here.</p>
<p><code>ls -lsrt /var/lib/glance/images/ total 12892 12892 -rw-r-----. 1 glance glance 13200896 ago 6 11:09 10a7a49f-2533-4513-881f-c4c6e419b778</code></p>
<p>Finally we check if the images are in active status</p>
<div class="highlight"><pre><span></span>glance image-list
+--------------------------------------+----------------+-------------+------------------+----------+--------+
| ID                                   | Name           | Disk Format | Container Format | Size     | Status |
+--------------------------------------+----------------+-------------+------------------+----------+--------+
| 10a7a49f-2533-4513-881f-c4c6e419b778 | cirros         | qcow2       | bare             | 13200896 | active |
| 6ac8f5b9-5863-46ca-bb04-db352d35d829 | CirrosDatadir  | qcow2       | bare             | 12506112 | active |
| 9e957bad-d0f8-4294-a438-77ad0d6af02b | CirrosDatadir2 | qcow2       | bare             | 12506112 | active |
+--------------------------------------+----------------+-------------+------------------+----------+--------+
</pre></div>


<p>Regards</p>
                <div class="clear"></div>

                <div class="info">
                    <a href="https://egonzalez90.github.io/multiple-store-locations-for-glance-images.html">posted at 13:37</a>
                    &nbsp;&middot;&nbsp;<a href="https://egonzalez90.github.io/category/openstack.html" rel="tag">OpenStack</a>
                    &nbsp;&middot;
                    &nbsp;<a href="https://egonzalez90.github.io/tag/create.html" class="tags">create</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/filesystem_store_datadirs.html" class="tags">filesystem_store_datadirs</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/glance.html" class="tags selected">glance</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/glance-api.html" class="tags">glance-api</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/glance-apiconf.html" class="tags">glance-api.conf</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/images.html" class="tags">images</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/locations.html" class="tags">locations</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/multiple.html" class="tags">multiple</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/openstack.html" class="tags">openstack</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/storage.html" class="tags">storage</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/store.html" class="tags">store</a>
                </div>
		<a href="https://egonzalez90.github.io/multiple-store-locations-for-glance-images.html#disqus_thread">Click to read and post comments</a>
            </article>            <h4 class="date">Feb 04, 2015</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://egonzalez90.github.io/comprobar-glance-image-service.html" rel="bookmark" title="Permanent Link to &quot;Comprobar Glance Image Service&quot;">Comprobar Glance Image Service</a>
                </h2>

                
                

                <p>Una vez configurado Image Service, comprobaremos que funciona
correctamente creando una carpeta y añadiendo una imagen de Cirros a
nuestro nuevo entorno.</p>
<p>Lo primero que haremos será crear una carpeta y descargaremos la imagen
de Cirros.</p>
<blockquote>
<p># mkdir /tmp/images</p>
<p># cd /tmp/images</p>
<p>#
wget http://download.cirros-cloud.net/0.3.3/cirros-0.3.3-x86_64-disk.img</p>
</blockquote>
<p>Crearemos la imagen de Cirros en Glance</p>
<blockquote>
<p># glance image-create --name=cirros --disk-format=qcow2
--container-format=bare --is-public=True --      progress
> cirros-0.3.3-x86_64-disk.img</p>
</blockquote>
<p>Listamos las imagenes disponibles</p>
<blockquote>
<p># glance image-list</p>
</blockquote>
<p>Eliminamos el archivo descargado de Cirros</p>
<blockquote>
<p># rm -rf /tmp/images/cirros-0.3.3-x86_64-disk.img</p>
</blockquote>
                <div class="clear"></div>

                <div class="info">
                    <a href="https://egonzalez90.github.io/comprobar-glance-image-service.html">posted at 16:34</a>
                    &nbsp;&middot;&nbsp;<a href="https://egonzalez90.github.io/category/openstack.html" rel="tag">OpenStack</a>
                    &nbsp;&middot;
                    &nbsp;<a href="https://egonzalez90.github.io/tag/cloud.html" class="tags">cloud</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/comprobar.html" class="tags">comprobar</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/glance.html" class="tags selected">glance</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/image.html" class="tags">image</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/image-create.html" class="tags">image-create</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/image-list.html" class="tags">image-list</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/openstack.html" class="tags">openstack</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/service.html" class="tags">service</a>
                </div>
		<a href="https://egonzalez90.github.io/comprobar-glance-image-service.html#disqus_thread">Click to read and post comments</a>
            </article>

                <div class="clear"></div>
                <div class="pages">

                    <a href="https://egonzalez90.github.io/page/2" class="next_page">Next&nbsp;&rarr;</a>
                    <span>Page 1 of 2</span>
                </div>

            <div class="clear"></div>
            <footer>
                <p>
                <a href="https://github.com/jody-frankowski/blue-penguin">Blue Penguin</a> Theme
                &middot;
                Powered by <a href="http://getpelican.com">Pelican</a>
                &middot;
                <a href="https://egonzalez90.github.io/feeds/all.atom.xml" rel="alternate">Atom Feed</a>
            </footer>
        </div>
        <div class="clear"></div>
    </div>
</body>
</html>