<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>OpenStack Stuff - neutron</title>
        <link rel="stylesheet" href="https://egonzalez90.github.io/theme/css/main.css" />
        <link href="https://egonzalez90.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="OpenStack Stuff Atom Feed" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://egonzalez90.github.io/">OpenStack Stuff </a></h1>
                <nav><ul>
                    <li><a href="https://docs.openstack.org">OpenStack</a></li>
                    <li><a href="https://www.linkedin.com/in/eduardogonzalezgutierrez">Linkedin</a></li>
                    <li><a href="https://github.com/egonzalez90">Github</a></li>
                    <li><a href="https://egonzalez90.github.io/category/linux.html">Linux</a></li>
                    <li><a href="https://egonzalez90.github.io/category/linux-openstack.html">Linux, OpenStack</a></li>
                    <li><a href="https://egonzalez90.github.io/category/linux-openstack-various.html">Linux, OpenStack, Various</a></li>
                    <li><a href="https://egonzalez90.github.io/category/linux-various.html">Linux, Various</a></li>
                    <li><a href="https://egonzalez90.github.io/category/linux-virtualizacion.html">Linux, Virtualizacion</a></li>
                    <li><a href="https://egonzalez90.github.io/category/misc.html">misc</a></li>
                    <li><a href="https://egonzalez90.github.io/category/openstack.html">OpenStack</a></li>
                    <li><a href="https://egonzalez90.github.io/category/reflexiones.html">Reflexiones</a></li>
                    <li><a href="https://egonzalez90.github.io/category/various.html">Various</a></li>
                    <li><a href="https://egonzalez90.github.io/category/virtualizacion.html">Virtualizacion</a></li>
                </ul>
                </nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="https://egonzalez90.github.io/configure-neutron-dvr-openstack-liberty.html">Configure Neutron DVR OpenStack Liberty</a></h1>
<footer class="post-info">
        <span>Wed 27 January 2016</span>
<span>| tags: <a href="https://egonzalez90.github.io/tag/-configure.html">--configure</a><a href="https://egonzalez90.github.io/tag/distributed.html">distributed</a><a href="https://egonzalez90.github.io/tag/dvr.html">dvr</a><a href="https://egonzalez90.github.io/tag/fip.html">fip</a><a href="https://egonzalez90.github.io/tag/l3.html">l3</a><a href="https://egonzalez90.github.io/tag/liberty.html">liberty</a><a href="https://egonzalez90.github.io/tag/neutron.html">neutron</a><a href="https://egonzalez90.github.io/tag/openstack.html">openstack</a><a href="https://egonzalez90.github.io/tag/packstack.html">packstack</a><a href="https://egonzalez90.github.io/tag/qrouter.html">qrouter</a><a href="https://egonzalez90.github.io/tag/rdo.html">rdo</a><a href="https://egonzalez90.github.io/tag/routers.html">routers</a><a href="https://egonzalez90.github.io/tag/snat.html">snat</a><a href="https://egonzalez90.github.io/tag/virtual.html">virtual</a></span>
</footer><!-- /.post-info --><p>Distributed Virtual Routers aka DVR were created to avoid single point
of failure on neutron nodes.<br>
When using standard routers, all the traffic is passing out through
Neutron servers. Inside network servers, router namespaces are created
routing all traffic and NAT forwarding between instances and public
networks. When a network node falls down, instance traffic will no
longer be available until a new namespace is created and executed in
another network node.<br>
Distributed routers is a way to avoid the SPOF neutron nodes were. When
using DVR, router namespaces, are directly created inside compute nodes
where all instance and l3 traffic are routed.</p>
<p>If you want to know more about DVR check this awesome links:  </p>
<p><a href="http://blog.gampel.net/2014/12/openstack-neutron-distributed-virtual.html">http://blog.gampel.net/2014/12/openstack-neutron-distributed-virtual.html</a><br>
<a href="http://blog.gampel.net/2014/12/openstack-dvr2-floating-ips.html">http://blog.gampel.net/2014/12/openstack-dvr2-floating-ips.html</a><br>
<a href="http://blog.gampel.net/2015/01/openstack-DVR-SNAT.html">http://blog.gampel.net/2015/01/openstack-DVR-SNAT.html</a></p>
<p>A previous OpenStack Liberty installation is required, mine was done
with RDO packstack.</p>
<p><strong><ins datetime="2016-01-27T18:47:58+00:00">Configure all Neutron
Servers</ins></strong></p>
<p>Edit ml2 configuration file with the following:</p>
<div class="highlight"><pre><span></span># vi /etc/neutron/plugins/ml2/ml2_conf.ini

mechanism_drivers = openvswitch,l2population
type_drivers = flat,vlan,vxlan
tenant_network_types = vxlan
vni_ranges = 10:100
vxlan_group = 224.1.1.1
enable_security_group = True
</pre></div>


<p>Edit neutron configuration file, enable DVR and uncomment dvr_base_mac
option</p>
<div class="highlight"><pre><span></span># vi /etc/neutron/neutron.conf

router_distributed = True
dvr_base_mac = fa:16:3f:00:00:00
</pre></div>


<p>Configure l3 agent to use dvr_snat</p>
<div class="highlight"><pre><span></span># vi /etc/neutron/l3_agent.ini

agent_mode = dvr_snat
</pre></div>


<p>Restart neutron server</p>
<div class="highlight"><pre><span></span>systemctl restart neutron-server
</pre></div>


<p><strong><ins datetime="2016-01-27T18:47:58+00:00">Configure all Compute
Nodes</ins></strong></p>
<p>Install ml2 package</p>
<div class="highlight"><pre><span></span>yum install openstack-neutron-ml2
</pre></div>


<p>Edit openvswitch agent file as below:</p>
<div class="highlight"><pre><span></span># vi /etc/neutron/plugins/ml2/openvswitch_agent.ini

l2_population = True
arp_responder = True
enable_distributed_routing = True
</pre></div>


<p>Enable DVR and select an interface driver to be used by l3 agent</p>
<div class="highlight"><pre><span></span># vi /etc/neutron/l3_agent.ini

interface_driver = neutron.agent.linux.interface.OVSInterfaceDriver
agent_mode = dvr
</pre></div>


<p>Edit ml2 configuration file as below:</p>
<div class="highlight"><pre><span></span># vi /etc/neutron/plugins/ml2/ml2_conf.ini

type_drivers = flat,vlan,vxlan
tenant_network_types = vxlan
mechanism_drivers = openvswitch,l2population
vni_ranges = 10:100
vxlan_group = 224.1.1.1
enable_security_group = True
</pre></div>


<p>Start and enable metadata agent in compute nodes</p>
<div class="highlight"><pre><span></span>systemctl start neutron-l3-agent neutron-metadata-agent
systemctl enable neutron-l3-agent neutron-metadata-agent
</pre></div>


<p>Create an external bridge with an external IP associated on it</p>
<div class="highlight"><pre><span></span># vi /etc/sysconfig/network-scripts/ifcfg-br-ex

DEVICE=br-ex
DEVICETYPE=ovs
TYPE=OVSBridge
BOOTPROTO=static
IPADDR=192.168.100.4                                                          
NETMASK=255.255.255.0
GATEWAY=192.168.100.1
ONBOOT=yes
</pre></div>


<p>Modify an unused interface connected with the same network as the IP
configured with br-ex, edit the interface to be used as OVS port by
br-ex</p>
<div class="highlight"><pre><span></span># vi /etc/sysconfig/network-scripts/ifcfg-eth1
DEVICE=eth1
TYPE=OVSPort
DEVICETYPE=ovs
OVS_BRIDGE=br-ex
ONBOOT=yes
</pre></div>


<p>Restart network service to apply changes on the interfaces and
openvswith-agent</p>
<div class="highlight"><pre><span></span>systemctl restart network
systemctl restart neutron-openvswitch-agent
</pre></div>


<p>Create an external network and a subnet on it</p>
<div class="highlight"><pre><span></span>neutron net-create external_network --provider:network_type flat --provider:physical_network extnet  --router:external --shared
neutron subnet-create --name public_subnet --enable_dhcp=False --allocation-pool=start=192.168.100.100,end=192.168.100.150 --gateway=192.168.100.1 external_network 192.168.100.0/24
</pre></div>


<p>Create a router and associate external network as router gateway</p>
<div class="highlight"><pre><span></span>neutron router-create router1
neutron router-gateway-set router1 external_network
</pre></div>


<p>Create an internal network, a subnet and associate an interface to the
router</p>
<div class="highlight"><pre><span></span>neutron net-create private_network
neutron subnet-create --name private_subnet private_network 10.0.1.0/24
neutron router-interface-add router1 private_subnet
</pre></div>


<p>Boot 2 instances</p>
<div class="highlight"><pre><span></span>nova boot --flavor m1.tiny --image cirros --nic net-id=154da7a8-fa49-415e-9d35-c840b144a8df test1
nova boot --flavor m1.tiny --image cirros --nic net-id=154da7a8-fa49-415e-9d35-c840b144a8df test2
</pre></div>


<p>Create 2 floating ips and associate it to instances</p>
<div class="highlight"><pre><span></span>neutron floatingip-create external_network
neutron floatingip-create external_network
nova floating-ip-associate test1 192.168.100.101
nova floating-ip-associate test2 192.168.100.102
</pre></div>


<p>Test if all works as expected pinging floating ips</p>
<div class="highlight"><pre><span></span># ping 192.168.100.101
# ping 192.168.100.102
</pre></div>


<p>As you can see, in network nodes, a snat namespace is created</p>
<div class="highlight"><pre><span></span># sudo ip netns
qdhcp-154da7a8-fa49-415e-9d35-c840b144a8df
snat-77fef58a-6d0c-4e96-b4b6-5d8e81ebead3
</pre></div>


<p>In compute nodes, a fip namespace per instance with floating ip
associated running on the compute node are created and a qrouter
namespace are created.</p>
<div class="highlight"><pre><span></span># sudo ip netns
fip-4dfdabb0-d2d6-4d4a-8c00-84df834eec8b
qrouter-77fef58a-6d0c-4e96-b4b6-5d8e81ebead3
</pre></div>


<p>Best regards, Eduardo Gonzalez</p><p><a href="https://egonzalez90.github.io/configure-neutron-dvr-openstack-liberty.html#disqus_thread">comments</a></p>                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="https://egonzalez90.github.io/load-balancer-as-a-service-lbaas.html" rel="bookmark"
                           title="Permalink to Load Balancer as a Service LBaaS">Load Balancer as a Service LBaaS</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <span>Tue 24 March 2015</span>
<span>| tags: <a href="https://egonzalez90.github.io/tag/healthmonitor.html">healthmonitor</a><a href="https://egonzalez90.github.io/tag/ip.html">IP</a><a href="https://egonzalez90.github.io/tag/lbaas.html">lbaas</a><a href="https://egonzalez90.github.io/tag/load-balancer-as-a-service.html">load balancer as a service</a><a href="https://egonzalez90.github.io/tag/member.html">member</a><a href="https://egonzalez90.github.io/tag/neutron.html">neutron</a><a href="https://egonzalez90.github.io/tag/openstack.html">openstack</a><a href="https://egonzalez90.github.io/tag/pool.html">pool</a><a href="https://egonzalez90.github.io/tag/vip.html">vip</a><a href="https://egonzalez90.github.io/tag/virtual.html">virtual</a></span>
</footer><!-- /.post-info -->                <p>The following guide will show you how to deploy a LoadBalancer in
Openstack with Neutron, but first, you should understand how it works,
and what his components do.</p>
<p>A Load Balancer is composed of the following components:</p>
<ul>
<li>Pool - A pool is a group of servers(members) who are designed to …</li></ul>
                <a class="readmore" href="https://egonzalez90.github.io/load-balancer-as-a-service-lbaas.html">read more</a>
<p><a href="https://egonzalez90.github.io/load-balancer-as-a-service-lbaas.html#disqus_thread">comments</a></p>                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://egonzalez90.github.io/delete-openstack-neutron-networks-solution-to-unable-to-complete-operation-on-subnet.html" rel="bookmark"
                           title="Permalink to Delete openstack Neutron networks (Solution to: Unable to complete operation on subnet)">Delete openstack Neutron networks (Solution to: Unable to complete operation on subnet)</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <span>Mon 09 March 2015</span>
<span>| tags: <a href="https://egonzalez90.github.io/tag/cannot-be-deleted-directly-via-the-port-api.html">cannot be deleted directly via the port API</a><a href="https://egonzalez90.github.io/tag/delete.html">delete</a><a href="https://egonzalez90.github.io/tag/error.html">error</a><a href="https://egonzalez90.github.io/tag/floatingip.html">floatingip</a><a href="https://egonzalez90.github.io/tag/guide.html">guide</a><a href="https://egonzalez90.github.io/tag/has-owner-networkfloatingip.html">has owner network:floatingip</a><a href="https://egonzalez90.github.io/tag/net.html">net</a><a href="https://egonzalez90.github.io/tag/network.html">network</a><a href="https://egonzalez90.github.io/tag/neutron.html">neutron</a><a href="https://egonzalez90.github.io/tag/openstack.html">openstack</a><a href="https://egonzalez90.github.io/tag/port.html">port</a><a href="https://egonzalez90.github.io/tag/router.html">router</a><a href="https://egonzalez90.github.io/tag/solution.html">solution</a><a href="https://egonzalez90.github.io/tag/step-by-step.html">step by step</a><a href="https://egonzalez90.github.io/tag/subnet.html">subnet</a><a href="https://egonzalez90.github.io/tag/unable-to-complete-operation-on-subnet.html">Unable to complete operation on subnet</a></span>
</footer><!-- /.post-info -->                <div class="highlight"><pre><span></span>[root@rdoicehouse ~(keystone_admin)]# neutron router-list
+--------------------------------------+------------------+-----------------------------------------------------------------------------+
| id                                   | name             | external_gateway_info                                                       |
+--------------------------------------+------------------+-----------------------------------------------------------------------------+
| e34d94ad-7fe1-4704-8156-d255a2daa167 | demodeleterouter | {&quot;network_id&quot;: &quot;8b2ceda2-4d77-4c5c-ae21-6a7ba133e4fc&quot;, &quot;enable_snat&quot;: true} |
+--------------------------------------+------------------+-----------------------------------------------------------------------------+

[root@rdoicehouse ~(keystone_admin)]# neutron router-gateway-clear e34d94ad-7fe1-4704-8156-d255a2daa167
Removed gateway from router e34d94ad-7fe1-4704-8156-d255a2daa167

[root@rdoicehouse ~(keystone_admin)]# neutron router-port-list e34d94ad-7fe1-4704-8156-d255a2daa167

If Apply: 
          [[ neutron router-interface-delete &lt;router-id&gt; &lt;subnet-id&gt; ]]

[root@rdoicehouse ~(keystone_admin)]# neutron router-delete e34d94ad-7fe1-4704-8156-d255a2daa167
Deleted router: e34d94ad-7fe1-4704-8156-d255a2daa167

[root@rdoicehouse ~(keystone_admin)]# neutron …</pre></div>
                <a class="readmore" href="https://egonzalez90.github.io/delete-openstack-neutron-networks-solution-to-unable-to-complete-operation-on-subnet.html">read more</a>
<p><a href="https://egonzalez90.github.io/delete-openstack-neutron-networks-solution-to-unable-to-complete-operation-on-subnet.html#disqus_thread">comments</a></p>                </div><!-- /.entry-content -->
            </article></li>
            </ol><!-- /#posts-list -->
<p class="paginator">
    Page 1 / 2
        <a href="https://egonzalez90.github.io/tag/neutron2.html">&raquo;</a>
</p>
            </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://egonzalez90.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://twitter.com/egongu90">Twitter</a></li>
                            <li><a href="https://www.linkedin.com/in/eduardogonzalezgutierrez">Linkedin</a></li>
                            <li><a href="https://github.com/egonzalez90">Github</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme <a href="https://github.com/blueicefield/pelican-blueidea/">blueidea</a>, inspired by the default theme.</p>
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'egonzalez-1';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>