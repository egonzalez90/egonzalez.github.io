<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OpenStack Stuff | articles tagged "flows"</title>
    <link rel="shortcut icon" type="image/png" href="https://egonzalez90.github.io/favicon.png">
    <link rel="shortcut icon" type="image/x-icon" href="https://egonzalez90.github.io/favicon.ico">
    <link href="https://egonzalez90.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="OpenStack Stuff Full Atom Feed" />
    <link rel="stylesheet" href="https://egonzalez90.github.io/theme/css/screen.css" type="text/css" />
    <link rel="stylesheet" href="https://egonzalez90.github.io/theme/css/pygments.css" type="text/css" />
    <link rel="stylesheet" href="https://egonzalez90.github.io/theme/css/print.css" type="text/css" media="print" />
    <meta name="generator" content="Pelican" />
    <meta name="description" content="" />
    <meta name="author" content="Eduardo Gonzalez" />
</head>
<body>
    <header>
        <nav>
            <ul>
                <li class="ephemeral selected"><a href="https://egonzalez90.github.io/tag/flows.html">flows</a></li>
                <li><a href="https://egonzalez90.github.io/">Home</a></li>
                <li><a href="https://docs.openstack.org">OpenStack</a></li>
                <li><a href="https://www.linkedin.com/in/eduardogonzalezgutierrez">Linkedin</a></li>
                <li><a href="https://github.com/egonzalez90">Github</a></li>
                <li><a href="https://egonzalez90.github.io/archives">Archives</a></li>
            </ul>
        </nav>
        <div class="header_box">
            <h1><a href="https://egonzalez90.github.io/">OpenStack Stuff</a></h1>
        </div>
    </header>
    <div id="wrapper">
        <div id="content">            <h4 class="date">Mar 02, 2016</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://egonzalez90.github.io/nova-vnc-flows-under-the-hood.html" rel="bookmark" title="Permanent Link to &quot;Nova VNC flows under the hood&quot;">Nova VNC flows under the hood</a>
                </h2>

                
                

                <p>Most OpenStack deployments has a VNC console implemented with
nova-novncproxy. This service gives the final user the ability to log
into their instances in a web based method through a browser.</p>
<p>At this post i'm going to show how a vnc console request works under the
hood while using the following command or lauching a vnc session through
Horizon.</p>
<div class="highlight"><pre><span></span># nova get-vnc-console INSTANCE novnc
</pre></div>


<p>First of all, a user connects to NOVA and issues a VNC console request
for an instance. Nova API needs to validate the user issuing an
authentication request to keystone.<br>
The user receives a token with nova's endpoint URL in the catalog, with
that endpoint and the token, the user makes a request against nova
calling for a VNC session.</p>
<div class="highlight"><pre><span></span>GET http://192.168.200.208:5000/v2.0 -H &quot;Accept: application/json&quot; -H
</pre></div>


<p>"User-Agent: python-keystoneclient"</p>
<div class="highlight"><pre><span></span>GET http://192.168.200.208:8774/v2/ -H &quot;User-Agent: python-novaclient&quot; -H
</pre></div>


<p>"Accept: application/json" -H "X-Auth-Token: {SHA1}3b6262df9eaba5da33c1004805187806322201f1"</p>
<p>If a name instead of an instance ID is used in the request, Nova need to
check his database to match that name with his corresponding ID, as we
can see in the following request.</p>
<div class="highlight"><pre><span></span>GET http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers?name=test1
</pre></div>


<p>-H "User-Agent: python-novaclient" -H "Accept: application/json" <br>
   -H "X-Auth-Token: {SHA1}3b6262df9eaba5da33c1004805187806322201f1"</p>
<div class="highlight"><pre><span></span>RESP BODY: {&quot;servers&quot;: [{&quot;id&quot;: &quot;9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;,
</pre></div>


<p>"links": [{"href": "http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee", "rel": "self"},<br>
    {"href": "http://192.168.200.208:8774/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee", <br>
   "rel": "bookmark"}], "name": "test1"}]}</p>
<p>Once the ID is matched with the name, Nova check information about the
instance (I thought it was to validate if is in ACTIVE status, but i
realized that even when is in STOPPED status the request is made it
anyway).</p>
<div class="highlight"><pre><span></span>GET http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee  
-H &quot;User-Agent: python-novaclient&quot; -H &quot;Accept: application/json&quot;   
-H &quot;X-Auth-Token: {SHA1}3b6262df9eaba5da33c1004805187806322201f1&quot;

RESP BODY: {&quot;server&quot;: {&quot;status&quot;: &quot;ACTIVE&quot;, &quot;updated&quot;: &quot;2016-03-02T17:28:45Z&quot;, &quot;hostId&quot;: &quot;ca3a874dcad9079fcc6a0b10b0e2efaa394bc66b5335197fdd9c2498&quot;, &quot;OS-EXT-SRV-ATTR:host&quot;: &quot;liberty&quot;, &quot;addresses&quot;: {&quot;private&quot;: [{&quot;OS-EXT-IPS-MAC:mac_addr&quot;: &quot;fa:16:3e:aa:1c:32&quot;, &quot;version&quot;: 4, &quot;addr&quot;: &quot;10.0.0.6&quot;, &quot;OS-EXT-IPS:type&quot;: &quot;fixed&quot;}]}, &quot;links&quot;: [{&quot;href&quot;: &quot;http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;, &quot;rel&quot;: &quot;self&quot;}, {&quot;href&quot;: &quot;http://192.168.200.208:8774/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;, &quot;rel&quot;: &quot;bookmark&quot;}], &quot;key_name&quot;: null, &quot;image&quot;: {&quot;id&quot;: &quot;bf31eadd-c5f4-40f8-9ddb-30f688ca5e5f&quot;, &quot;links&quot;: [{&quot;href&quot;: &quot;http://192.168.200.208:8774/ee84411cdb8148d28674b129ef482f31/images/bf31eadd-c5f4-40f8-9ddb-30f688ca5e5f&quot;, &quot;rel&quot;: &quot;bookmark&quot;}]}, &quot;OS-EXT-STS:task_state&quot;: null, &quot;OS-EXT-STS:vm_state&quot;: &quot;active&quot;, &quot;OS-EXT-SRV-ATTR:instance_name&quot;: &quot;instance-0000000a&quot;, &quot;OS-SRV-USG:launched_at&quot;: &quot;2016-03-02T17:28:45.000000&quot;, &quot;OS-EXT-SRV-ATTR:hypervisor_hostname&quot;: &quot;liberty&quot;, &quot;flavor&quot;: {&quot;id&quot;: &quot;1&quot;, &quot;links&quot;: [{&quot;href&quot;: &quot;http://192.168.200.208:8774/ee84411cdb8148d28674b129ef482f31/flavors/1&quot;, &quot;rel&quot;: &quot;bookmark&quot;}]}, &quot;id&quot;: &quot;9165dbda-f54e-4186-b2cb-e6ca05ac53ee&quot;, &quot;security_groups&quot;: [{&quot;name&quot;: &quot;default&quot;}], &quot;OS-SRV-USG:terminated_at&quot;: null, &quot;OS-EXT-AZ:availability_zone&quot;: &quot;nova&quot;, &quot;user_id&quot;: &quot;d9164a323be649c0a8c5c80fdd5bd585&quot;, &quot;name&quot;: &quot;test1&quot;, &quot;created&quot;: &quot;2016-03-02T17:28:34Z&quot;, &quot;tenant_id&quot;: &quot;ee84411cdb8148d28674b129ef482f31&quot;, &quot;OS-DCF:diskConfig&quot;: &quot;MANUAL&quot;, &quot;os-extended-volumes:volumes_attached&quot;: [], &quot;accessIPv4&quot;: &quot;&quot;, &quot;accessIPv6&quot;: &quot;&quot;, &quot;progress&quot;: 0, &quot;OS-EXT-STS:power_state&quot;: 1, &quot;config_drive&quot;: &quot;&quot;, &quot;metadata&quot;: {}}}
</pre></div>


<p>When we get the information, nova-api POST a request to nova-consoleauth
for a VNC console.</p>
<div class="highlight"><pre><span></span>POST http://192.168.200.208:8774/v2/ee84411cdb8148d28674b129ef482f31/servers/9165dbda-f54e-4186-b2cb-e6ca05ac53ee/action
</pre></div>


<p>-H "User-Agent: python-novaclient" -H "Content-Type: application/json" <br>
   -H "Accept: application/json" -H "X-Auth-Token: {SHA1}3b6262df9eaba5da33c1004805187806322201f1"<br>
   -d '{"os-getVNCConsole": {"type": "novnc"}}'</p>
<div class="highlight"><pre><span></span>DEBUG nova.api.openstack.wsgi [req-2201b9d6-5711-46d3-ac4d-669094f07527
</pre></div>


<p>d9164a323be649c0a8c5c80fdd5bd585 ee84411cdb8148d28674b129ef482f31 - - -] <br>
   Action: 'action', calling method: , body: {"os-getVNCConsole": {"type": "novnc"}} <br>
   _process_stack /usr/lib/python2.7/site-packages/nova/api/openstack/wsgi.py:789</p>
<p>Nova-consoleauth receives the console request and create an access URL
while generates a temporary token for the vnc console.</p>
<div class="highlight"><pre><span></span>INFO nova.consoleauth.manager [req-d4def6f9-1ab9-4626-b6a8-d81643ea5eb4 d9164a323be649c0a8c5c80fdd5bd585 ee84411cdb8148d28674b129ef482f31 - - -]
</pre></div>


<p>Received Token: 3dfcd011-28f1-4cf3-8f5c-8cd18de4560e, <br>
   {'instance_uuid': u'9165dbda-f54e-4186-b2cb-e6ca05ac53ee', <br>
   'access_url': u'http://192.168.200.208:6080/vnc_auto.html?token=3dfcd011-28f1-4cf3-8f5c-8cd18de4560e',<br>
    'token': u'3dfcd011-28f1-4cf3-8f5c-8cd18de4560e', 'last_activity_at': 1456940028.356214, <br>
   'internal_access_path': None, 'console_type': u'novnc', 'host': u'liberty', 'port': u'5900'}</p>
<p>Nova-consoleauth answer to nova-api who also answers to the user with an
access URL.<br>
This URL got the following content on it:</p>
<ul>
<li>HTTP or HTTPS connection to nova-novncproxy IP</li>
<li>Nova-novncproxy port</li>
<li>A token to validate the VNC connection</li>
</ul>
<!-- -->

<div class="highlight"><pre><span></span>RESP BODY: {&quot;console&quot;: {&quot;url&quot;: &quot;http://192.168.200.208:6080/vnc_auto.html?token=3dfcd011-28f1-4cf3-8f5c-8cd18de4560e&quot;, &quot;type&quot;: &quot;novnc&quot;}}

+-------+--------------------------------------------------------------------------------------+
| Type  | Url                                                                                  |
+-------+--------------------------------------------------------------------------------------+
| novnc | http://192.168.200.208:6080/vnc_auto.html?token=3dfcd011-28f1-4cf3-8f5c-8cd18de4560e |
+-------+--------------------------------------------------------------------------------------+
</pre></div>


<p>Until now, nova-novncproxy service can be stopped or isn't used at all,
is at this point the when proxy server enter into the game.<br>
The user connects through a web browser to the nova-novncproxy's URL
provided by nova before.</p>
<div class="highlight"><pre><span></span>DEBUG nova.console.websocketproxy [-] 192.168.200.1:
</pre></div>


<p>new handler Process vmsg /usr/lib/python2.7/site-packages/websockify/websocket.py:828</p>
<p>Nova-vncproxy validate the issued token with the URL against
nova-consoleauth.</p>
<div class="highlight"><pre><span></span>nova.consoleauth.manager [req-399c7b58-700a-4779-b215-b12d10056813 - - - - -]
</pre></div>


<p>Checking Token: 3dfcd011-28f1-4cf3-8f5c-8cd18de4560e, True</p>
<p>When the token is validated, nova-novncproxy maps compute's node private
IP (at this case port 5900) with the nova-novncproxy public IP(6080
port).</p>
<div class="highlight"><pre><span></span>INFO nova.console.websocketproxy [req-399c7b58-700a-4779-b215-b12d10056813 - - - - -]  
  7: connect info: {u&#39;instance_uuid&#39;: u&#39;9165dbda-f54e-4186-b2cb-e6ca05ac53ee&#39;, u&#39;
</pre></div>


<p>internal_access_path': None, u'last_activity_at': 1456940028.356214, <br>
   u'console_type': u'novnc', u'host': u'liberty', u'token': u'3dfcd011-28f1-4cf3-8f5c-8cd18de4560e', <br>
   u'access_url': u'http://192.168.200.208:6080/vnc_auto.html?token=3dfcd011-28f1-4cf3-8f5c-8cd18de4560e'<br>
   , u'port': u'5900'}</p>
<p>We can see how the python novncproxy process binds both IPs/port.</p>
<div class="highlight"><pre><span></span># ps aux | grep vnc
nova     14840  1.2  0.7 362096 41000 ?        S    18:53   0:14 /usr/bin/python2 /usr/bin/nova-novncproxy --web /usr/share/novnc/

# netstat -putona | grep 14840
tcp        0      0 192.168.200.208:6080    192.168.200.1:59918     ESTABLISHED 14840/python2        keepalive (3,13/0/0)
tcp        0      0 192.168.122.73:57764    192.168.122.73:5900     ESTABLISHED 14840/python2        keepalive (3,13/0/0)
</pre></div>


<p>Nova-novncproxy starts the connection between the instance and user's
browser session.</p>
<div class="highlight"><pre><span></span>INFO nova.console.websocketproxy [req-399c7b58-700a-4779-b215-b12d10056813 - - - - -]  
  7: connecting to: liberty:5900
</pre></div>


<p>Libvirt connects a vnc console into the instance, as we can see at the
xml provided by virsh command.<br>
Also, port 5900 now is binded at qemu-kvm process.</p>
<div class="highlight"><pre><span></span># virsh dumpxml 2
...
<span class="nt">&lt;graphics</span> <span class="na">type=</span><span class="s">&#39;vnc&#39;</span> <span class="na">port=</span><span class="s">&#39;5900&#39;</span> <span class="na">autoport=</span><span class="s">&#39;yes&#39;</span> <span class="na">listen=</span><span class="s">&#39;0.0.0.0&#39;</span> <span class="na">keymap=</span><span class="s">&#39;en-us&#39;</span><span class="nt">&gt;</span>
     <span class="nt">&lt;listen</span> <span class="na">type=</span><span class="s">&#39;address&#39;</span> <span class="na">address=</span><span class="s">&#39;0.0.0.0&#39;</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;/graphics&gt;</span>
...

# netstat -putona | grep 5900
tcp        0      0 0.0.0.0:5900            0.0.0.0:*               LISTEN      5910/qemu-kvm        off (0.00/0/0)
tcp        0      0 192.168.122.73:5900     192.168.122.73:57702    ESTABLISHED 5910/qemu-kvm        off (0.00/0/0)
tcp        0      0 192.168.122.73:57702    192.168.122.73:5900     ESTABLISHED 11118/python2        keepalive (1,92/0/0)
</pre></div>


<p>Nova-novncproxy keeps the connection alive until browser session ends.</p>
<div class="highlight"><pre><span></span>DEBUG nova.console.websocketproxy [-]
</pre></div>


<p>Reaing zombies, active child count is 1 vmsg /usr/lib/python2.7/site-packages/websockify/websocket.py:828</p>
<p>When a token is not valid while authenticating against nova-consoleauth,
we can see a message like the following.</p>
<div class="highlight"><pre><span></span>INFO nova.console.websocketproxy [req-9164b32d-3ce1-441b-82c7-6c23c9a354d0 - - - - -]
</pre></div>


<p>handler exception: The token '3dfcd011-28f1-4cf3-8f5c-8cd18de4560e' is invalid or has expired</p>
<p>Regards.<br>
Eduardo Gonzalez</p>
                <div class="clear"></div>

                <div class="info">
                    <a href="https://egonzalez90.github.io/nova-vnc-flows-under-the-hood.html">posted at 22:26</a>
                    &nbsp;&middot;&nbsp;<a href="https://egonzalez90.github.io/category/openstack.html" rel="tag">OpenStack</a>
                    &nbsp;&middot;
                    &nbsp;<a href="https://egonzalez90.github.io/tag/auth.html" class="tags">auth</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/console.html" class="tags">console</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/consoleauth.html" class="tags">consoleauth</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/flow.html" class="tags">flow</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/flows.html" class="tags selected">flows</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/how.html" class="tags">how</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/internal.html" class="tags">internal</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/liberty.html" class="tags">liberty</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/nova.html" class="tags">nova</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/novnc.html" class="tags">novnc</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/novncproxy.html" class="tags">novncproxy</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/openstack.html" class="tags">openstack</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/traffic.html" class="tags">traffic</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/vnc.html" class="tags">vnc</a>
                    &nbsp;<a href="https://egonzalez90.github.io/tag/works.html" class="tags">works</a>
                </div>
		<a href="https://egonzalez90.github.io/nova-vnc-flows-under-the-hood.html#disqus_thread">Click to read and post comments</a>
            </article>

            <div class="clear"></div>
            <footer>
                <p>
                <a href="https://github.com/jody-frankowski/blue-penguin">Blue Penguin</a> Theme
                &middot;
                Powered by <a href="http://getpelican.com">Pelican</a>
                &middot;
                <a href="https://egonzalez90.github.io/feeds/all.atom.xml" rel="alternate">Atom Feed</a>
            </footer>
        </div>
        <div class="clear"></div>
    </div>
</body>
</html>